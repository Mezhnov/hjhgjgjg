# pysearch_v9.py from flask import Flask, request, render_template_string, jsonify, Response, abort import requests from bs4 import BeautifulSoup import urllib.parse import re from concurrent.futures import ThreadPoolExecutor, as_completed import time from collections import OrderedDict import random import json import traceback  app = Flask(__name__) app.jinja_env.filters["urlencode"] = lambda s: urllib.parse.quote_plus(str(s))  UA_BROWSER = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" UA_WIKI = "PySearchBot/1.0 (Educational project) Python-requests/2.31"  SESSION = requests.Session() SESSION.headers.update({"User-Agent": UA_BROWSER, "Accept-Language": "ru-RU,ru;q=0.9,en;q=0.8"})  WIKI_SESSION = requests.Session() WIKI_SESSION.headers.update({"User-Agent": UA_WIKI, "Accept": "application/json", "Accept-Language": "ru-RU,ru;q=0.9,en;q=0.8"})  class RateLimiter:     def __init__(self, min_interval=0.5):         self.min_interval = min_interval         self.last_request = 0     def wait(self):         now = time.time()         elapsed = now - self.last_request         if elapsed < self.min_interval:             time.sleep(self.min_interval - elapsed)         self.last_request = time.time()  wiki_rate_limiter = RateLimiter(min_interval=0.3)  # SVG icons as data URIs SOCIAL_ICONS = {     "wikipedia": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'/%3E%3C/svg%3E",     "vk": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%230077FF' d='M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-.981-1.49-1.113-1.744-1.113-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4 8.57 4 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.779.678.864 2.505 2.303 4.698 2.896 4.698.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.744c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.814-.542 1.27-1.422 2.18-3.615 2.18-3.615.119-.254.322-.491.78-.491h1.743c.525 0 .644.27.525.643-.22 1.016-2.354 4.028-2.354 4.028-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.492-.085.745-.576.745z'/%3E%3C/svg%3E",     "instagram": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23E4405F' d='M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z'/%3E%3C/svg%3E",     "telegram": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2326A5E4' d='M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.96 6.502-1.36 8.627-.168.9-.5 1.2-.82 1.23-.697.065-1.225-.46-1.9-.9-1.06-.693-1.66-1.124-2.69-1.8-1.188-.78-.42-1.21.26-1.91.18-.18 3.25-2.98 3.31-3.23.008-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.8 1.14-5.08 3.35-.48.33-.92.49-1.31.48-.43-.01-1.26-.24-1.88-.44-.76-.25-1.36-.38-1.31-.8.03-.22.33-.44.91-.67 3.56-1.55 5.93-2.57 7.12-3.07 3.39-1.4 4.1-1.64 4.56-1.65z'/%3E%3C/svg%3E",     "youtube": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FF0000' d='M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z'/%3E%3C/svg%3E",     "twitter": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z'/%3E%3C/svg%3E",     "facebook": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%231877F2' d='M24 12c0-6.627-5.373-12-12-12S0 5.373 0 12c0 5.99 4.388 10.954 10.125 11.854V15.47H7.078V12h3.047V9.356c0-3.007 1.792-4.668 4.533-4.668 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874V12h3.328l-.532 3.47h-2.796v8.385C19.612 22.954 24 17.99 24 12z'/%3E%3C/svg%3E" }  SOCIAL_NETWORKS = {     "wikipedia": {"name": "Wikipedia", "icon": SOCIAL_ICONS["wikipedia"], "patterns": ["wikipedia.org"], "priority": 1},     "vk": {"name": "VK", "icon": SOCIAL_ICONS["vk"], "patterns": ["vk.com"], "priority": 2},     "instagram": {"name": "Instagram", "icon": SOCIAL_ICONS["instagram"], "patterns": ["instagram.com"], "priority": 3},     "telegram": {"name": "Telegram", "icon": SOCIAL_ICONS["telegram"], "patterns": ["t.me", "telegram.me"], "priority": 4},     "youtube": {"name": "YouTube", "icon": SOCIAL_ICONS["youtube"], "patterns": ["youtube.com", "youtu.be"], "priority": 5},     "twitter": {"name": "X", "icon": SOCIAL_ICONS["twitter"], "patterns": ["twitter.com", "x.com"], "priority": 6},     "facebook": {"name": "Facebook", "icon": SOCIAL_ICONS["facebook"], "patterns": ["facebook.com"], "priority": 7} }  class TTLCache:     def __init__(self, maxsize=256, ttl=60):         self.maxsize, self.ttl, self._data = maxsize, ttl, OrderedDict()     def get(self, key):         if key in self._data:             value, exp = self._data[key]             if exp >= time.time():                 self._data.move_to_end(key)                 return value             del self._data[key]         return None     def set(self, key, value):         self._data[key] = (value, time.time() + self.ttl)         self._data.move_to_end(key)         while len(self._data) > self.maxsize:             self._data.popitem(last=False)  suggest_cache = TTLCache(2048, 300) img_cache = TTLCache(256, 180) web_cache = TTLCache(256, 90) favicon_cache = TTLCache(512, 3600) wiki_cache = TTLCache(256, 3600) wikidata_cache = TTLCache(512, 21600) ddg_instant_cache = TTLCache(256, 3600) gallery_cache = TTLCache(256, 1800) related_cache = TTLCache(256, 3600)  TRENDING = [     {"text": "artificial intelligence 2026", "icon": "fire"},     {"text": "weather forecast", "icon": "sun"},     {"text": "technology news", "icon": "news"},     {"text": "movies 2026", "icon": "movie"},     {"text": "best games 2026", "icon": "game"},     {"text": "sports news", "icon": "ball"}, ]  QUESTIONS = {     "person": ["How old is {name}?", "Where was {name} born?", "Biography of {name}"],     "default": ["What is {name}?", "History of {name}"] }  HTML_TEMPLATE = """ <!DOCTYPE html> <html lang="en"> <head>   <meta charset="UTF-8"/>   <meta name="viewport" content="width=device-width, initial-scale=1.0"/>   <title>{% if query %}{{ query }} - PySearch{% else %}PySearch{% endif %}</title>   <style>     :root{--bg:#0a0a0f;--text:rgba(255,255,255,0.95);--muted:rgba(255,255,255,0.6);--muted2:rgba(255,255,255,0.4);--line:rgba(255,255,255,0.08);--brand1:#6366f1;--brand2:#8b5cf6;--accent:#8b5cf6;--shadow:0 25px 50px -12px rgba(0,0,0,0.5);--radius:20px;--glow:0 0 40px rgba(139,92,246,0.15)}     *{box-sizing:border-box;margin:0;padding:0}     body{font-family:'Inter',-apple-system,sans-serif;color:var(--text);background:var(--bg);min-height:100vh}     body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 20% -20%,rgba(99,102,241,0.25),transparent 50%),radial-gradient(ellipse 60% 40% at 80% 0%,rgba(139,92,246,0.2),transparent 50%);pointer-events:none;z-index:-1}     a{color:inherit;text-decoration:none}     .hero{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}     .hero-card{width:min(900px,95vw);background:linear-gradient(135deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);border-radius:32px;padding:48px 40px;backdrop-filter:blur(20px);box-shadow:var(--shadow),var(--glow)}     .logo{font-size:64px;font-weight:900;text-align:center;margin-bottom:8px;background:linear-gradient(135deg,#6366f1,#8b5cf6,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 4px 20px rgba(139,92,246,0.3))}     .tagline{text-align:center;color:var(--muted);margin-bottom:32px;font-size:16px}     .search-wrap{position:relative}     .searchbar{display:flex;align-items:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:999px;padding:8px 8px 8px 20px;gap:12px;transition:all 0.3s}     .searchbar:focus-within{border-color:rgba(139,92,246,0.5);box-shadow:0 4px 32px rgba(139,92,246,0.2)}     .search-icon{font-size:20px;opacity:0.6}     .search-input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:17px;padding:12px 0}     .search-input::placeholder{color:rgba(255,255,255,0.35)}     .search-btn{border:none;cursor:pointer;padding:14px 28px;border-radius:999px;color:white;font-weight:700;font-size:15px;background:linear-gradient(135deg,var(--brand1),var(--brand2));box-shadow:0 8px 24px rgba(99,102,241,0.3);transition:all 0.2s}     .search-btn:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(99,102,241,0.4)}     .suggest{position:absolute;top:calc(100% + 12px);left:0;right:0;background:rgba(15,15,20,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:20px;overflow:hidden;box-shadow:var(--shadow);display:none;backdrop-filter:blur(20px);z-index:100}     .suggest.open{display:block}     .suggest-head{padding:14px 20px 10px;font-size:11px;text-transform:uppercase;letter-spacing:0.1em;color:rgba(255,255,255,0.4);font-weight:700;display:flex;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.06)}     .suggest-clear{cursor:pointer;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.05)}     .suggest-item{padding:14px 20px;cursor:pointer;display:flex;gap:14px;align-items:center;transition:background 0.15s}     .suggest-item:hover,.suggest-item.active{background:rgba(139,92,246,0.1)}     .topbar{position:sticky;top:0;z-index:50;background:rgba(10,10,15,0.8);border-bottom:1px solid var(--line);backdrop-filter:blur(20px)}     .topbar-inner{max-width:1280px;margin:0 auto;padding:12px 24px;display:flex;align-items:center;gap:20px;flex-wrap:wrap}     .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:22px;background:linear-gradient(135deg,var(--brand1),var(--brand2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}     .brand-badge{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand1),var(--brand2))}     .tabs{display:flex;gap:8px;margin-left:auto}     .tab{padding:10px 18px;border-radius:999px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:var(--muted);font-weight:600;font-size:14px;transition:all 0.2s}     .tab:hover{background:rgba(255,255,255,0.06);color:var(--text)}     .tab.active{background:rgba(139,92,246,0.15);border-color:rgba(139,92,246,0.4);color:white}     .content{max-width:1280px;margin:0 auto;padding:24px}     .meta{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;color:var(--muted2);font-size:14px;margin-bottom:20px}     .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);font-size:13px}     .layout{display:grid;grid-template-columns:1fr 380px;gap:24px;align-items:start}     @media(max-width:1100px){.layout{grid-template-columns:1fr}}     .rightcol{position:sticky;top:90px}     @media(max-width:1100px){.rightcol{position:relative;top:auto;order:-1}}     .grid{display:flex;flex-direction:column;gap:16px}     .card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:var(--radius);padding:20px;transition:all 0.25s}     .card:hover{background:rgba(255,255,255,0.05);border-color:rgba(139,92,246,0.2);transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,0.2)}     .result-head{display:flex;gap:14px}     .favicon{width:32px;height:32px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden}     .favicon img{width:20px;height:20px}     .result-main{flex:1;min-width:0}     .url{color:var(--muted2);font-size:12px;margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}     .title{margin-bottom:8px;font-size:18px;font-weight:600;line-height:1.3}     .title a{color:#a5b4fc}     .title a:hover{text-decoration:underline}     .snippet{color:var(--muted);font-size:14px;line-height:1.6}     .empty{padding:40px;text-align:center;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.1);border-radius:var(--radius)}     .empty-icon{font-size:48px;margin-bottom:16px;opacity:0.6}     .kpanel{background:linear-gradient(135deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);border-radius:24px;overflow:hidden;box-shadow:var(--shadow)}     .kpanel-header{padding:20px;border-bottom:1px solid rgba(255,255,255,0.06)}     .kpanel-title{font-size:24px;font-weight:800;margin-bottom:4px}     .kpanel-subtitle{font-size:14px;color:var(--muted)}     .kpanel-gallery{display:flex;gap:6px;padding:16px;overflow-x:auto}     .kgallery-item{flex-shrink:0;width:90px;height:90px;border-radius:14px;overflow:hidden;cursor:pointer;border:2px solid transparent;transition:all 0.2s;background:rgba(0,0,0,0.3)}     .kgallery-item:first-child{width:130px;height:130px}     .kgallery-item:hover{border-color:var(--accent);transform:scale(1.05)}     .kgallery-item img{width:100%;height:100%;object-fit:cover}     .kpanel-socials{display:flex;flex-wrap:wrap;gap:10px;padding:16px;border-bottom:1px solid rgba(255,255,255,0.06)}     .ksocial-link{display:flex;align-items:center;gap:8px;padding:10px 16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:999px;font-size:13px;font-weight:600;transition:all 0.2s}     .ksocial-link:hover{background:rgba(255,255,255,0.08);transform:translateY(-2px)}     .ksocial-icon{width:20px;height:20px}     .kpanel-section{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.06)}     .kpanel-section:last-child{border-bottom:none}     .ksection-title{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}     .kpanel-bio{font-size:14px;color:rgba(255,255,255,0.75);line-height:1.7}     .kpanel-bio.collapsed{max-height:6em;overflow:hidden;position:relative}     .kpanel-bio.collapsed::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3em;background:linear-gradient(transparent,rgba(10,10,15,0.9))}     .kbio-toggle{margin-top:10px;padding:8px 16px;background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);border-radius:999px;color:white;font-size:13px;font-weight:600;cursor:pointer}     .kpanel-facts{display:flex;flex-direction:column}     .kfact-row{display:grid;grid-template-columns:110px 1fr;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04);gap:12px}     .kfact-row:last-child{border-bottom:none}     .kfact-label{font-size:12px;color:var(--muted);font-weight:600}     .kfact-value{font-size:14px}     .kfact-value a{color:#a5b4fc}     .kpanel-related{display:flex;flex-direction:column;gap:10px}     .krelated-item{display:flex;align-items:center;gap:14px;padding:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:14px;transition:all 0.2s}     .krelated-item:hover{background:rgba(255,255,255,0.06);transform:translateX(4px)}     .krelated-photo{width:48px;height:48px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,var(--brand1),var(--brand2));flex-shrink:0}     .krelated-photo img{width:100%;height:100%;object-fit:cover}     .krelated-info{flex:1;min-width:0}     .krelated-name{font-weight:700;font-size:14px;margin-bottom:2px}     .krelated-desc{font-size:12px;color:var(--muted)}     .kpanel-questions{display:flex;flex-direction:column;gap:8px}     .kquestion{display:flex;align-items:center;gap:12px;padding:12px 16px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;font-size:14px;transition:all 0.2s}     .kquestion:hover{background:rgba(255,255,255,0.06)}     .kpanel-actions{display:flex;flex-wrap:wrap;gap:10px;padding:16px;background:rgba(0,0,0,0.2)}     .kaction-btn{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);font-weight:600;font-size:14px;transition:all 0.2s}     .kaction-btn:hover{background:rgba(255,255,255,0.08);transform:translateY(-2px)}     .kaction-btn.primary{background:linear-gradient(135deg,var(--brand1),var(--brand2));border:none}     .kpanel-source{padding:12px 20px;font-size:12px;color:var(--muted2);background:rgba(0,0,0,0.15)}     .kpanel-empty{padding:40px 20px;text-align:center}     .img-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}     .img-card{border-radius:var(--radius);overflow:hidden;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);cursor:pointer;transition:all 0.25s}     .img-card:hover{transform:translateY(-4px) scale(1.02);border-color:rgba(139,92,246,0.3);box-shadow:0 20px 40px rgba(0,0,0,0.3)}     .img-thumb{width:100%;aspect-ratio:4/3;object-fit:cover;background:rgba(0,0,0,0.2)}     .img-meta{padding:14px}     .img-title{font-size:14px;line-height:1.4;margin-bottom:6px}     .img-domain{font-size:12px;color:var(--muted2)}     .modal{position:fixed;inset:0;background:rgba(0,0,0,0.92);display:none;z-index:200;backdrop-filter:blur(10px);flex-direction:column}     .modal.open{display:flex}     .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:rgba(0,0,0,0.5);border-bottom:1px solid rgba(255,255,255,0.08)}     .modal-title{font-weight:700;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}     .modal-counter{color:var(--muted);font-size:14px;margin:0 20px}     .modal-actions{display:flex;gap:10px}     .btn{padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:white;font-weight:600;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.2s}     .btn:hover{background:rgba(255,255,255,0.12)}     .btn.primary{background:rgba(139,92,246,0.3);border-color:rgba(139,92,246,0.5)}     .modal-body{flex:1;display:flex;align-items:center;justify-content:center;position:relative;padding:20px}     .modal-img{max-width:100%;max-height:calc(100vh - 200px);object-fit:contain;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,0.5)}     .modal-nav{position:absolute;top:50%;transform:translateY(-50%);width:56px;height:56px;border-radius:50%;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.1);color:white;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}     .modal-nav:hover{background:rgba(139,92,246,0.5)}     .modal-nav.prev{left:24px}     .modal-nav.next{right:24px}     .modal-nav:disabled{opacity:0.3;cursor:not-allowed}     .modal-footer{padding:16px 24px;background:rgba(0,0,0,0.5);border-top:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center}     .modal-info{color:var(--muted);font-size:13px}     .thumb-strip{display:flex;gap:8px;padding:12px 24px;background:rgba(0,0,0,0.4);overflow-x:auto;justify-content:center}     .thumb-item{width:64px;height:48px;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid transparent;opacity:0.5;transition:all 0.2s;flex-shrink:0}     .thumb-item:hover{opacity:0.8}     .thumb-item.active{opacity:1;border-color:var(--accent)}     .thumb-item img{width:100%;height:100%;object-fit:cover}     .loader{position:absolute;width:48px;height:48px;border:3px solid rgba(255,255,255,0.1);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}     @keyframes spin{to{transform:rotate(360deg)}}     .trending-section{margin-top:32px;padding-top:24px;border-top:1px solid rgba(255,255,255,0.06)}     .trending-title{display:flex;align-items:center;gap:10px;font-size:14px;color:var(--muted);margin-bottom:16px;font-weight:600}     .trending-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}     .trending-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:14px;transition:all 0.2s}     .trending-item:hover{background:rgba(255,255,255,0.06);transform:translateY(-2px)}     .footer{padding:24px;text-align:center;color:var(--muted2);font-size:13px}   </style> </head> <body> {% if not query %} <div class="hero">   <div class="hero-card">     <div class="logo">PySearch</div>     <p class="tagline">Smart Search Engine</p>     <form action="/search" method="GET" autocomplete="off">       <div class="search-wrap">         <div class="searchbar">           <span class="search-icon">&#128269;</span>           <input id="q" class="search-input" name="q" type="text" placeholder="Start searching..." autofocus/>           <button class="search-btn" type="submit">Search</button>         </div>         <div id="suggest" class="suggest"></div>       </div>     </form>     <div class="trending-section">       <div class="trending-title">&#128293; Popular searches</div>       <div class="trending-grid">         {% for item in trending %}         <a class="trending-item" href="/search?q={{ item.text|urlencode }}">           <span>&#128270;</span>           <span>{{ item.text }}</span>         </a>         {% endfor %}       </div>     </div>     <div class="footer">PySearch 2026</div>   </div> </div> {% else %} <div class="topbar">   <div class="topbar-inner">     <a class="brand" href="/"><span class="brand-badge"></span>PySearch</a>     <div class="search-wrap" style="flex:1;max-width:600px">       <form action="{{ '/images' if tab == 'images' else '/search' }}" method="GET" autocomplete="off">         <div class="searchbar">           <span class="search-icon">&#128269;</span>           <input id="q" class="search-input" name="q" type="text" value="{{ query }}"/>           <button class="search-btn" type="submit">Search</button>         </div>         <div id="suggest" class="suggest"></div>       </form>     </div>     <div class="tabs">       <a class="tab {{ 'active' if tab == 'web' else '' }}" href="/search?q={{ query|urlencode }}">&#128269; All</a>       <a class="tab {{ 'active' if tab == 'images' else '' }}" href="/images?q={{ query|urlencode }}">&#128444; Images</a>     </div>   </div> </div> <div class="content">   <div class="meta">     <span>{% if tab == 'web' %}Found: <b>{{ results|length }}</b>{% else %}Images: <b>{{ images|length }}</b>{% endif %} in {{ elapsed }} sec.</span>     <span class="pill">&#128225; DuckDuckGo + Bing</span>   </div>   {% if tab == 'web' %}   <div class="layout">     <div class="leftcol">       {% if results %}       <div class="grid">         {% for r in results %}         <div class="card">           <div class="result-head">             <div class="favicon"><img loading="lazy" src="/favicon?domain={{ r.domain|urlencode }}" alt=""/></div>             <div class="result-main">               <div class="url">{{ r.url[:80] }}{% if r.url|length > 80 %}...{% endif %}</div>               <h3 class="title"><a href="{{ r.url }}" target="_blank" rel="noopener">{{ r.title }}</a></h3>               <p class="snippet">{{ r.snippet }}</p>             </div>           </div>         </div>         {% endfor %}       </div>       {% else %}       <div class="empty"><div class="empty-icon">&#128533;</div><div>Nothing found</div></div>       {% endif %}     </div>     <div class="rightcol">       <div class="kpanel">         {% if knowledge %}         <div class="kpanel-header">           <h2 class="kpanel-title">{{ knowledge.title }}</h2>           {% if knowledge.kind %}<p class="kpanel-subtitle">{{ knowledge.kind }}</p>{% endif %}         </div>         {% if knowledge.gallery and knowledge.gallery|length > 0 %}         <div class="kpanel-gallery">           {% for img in knowledge.gallery[:6] %}           <div class="kgallery-item" onclick="window.open('{{ img.url }}','_blank')">             <img loading="lazy" src="/img?url={{ img.thumb|urlencode }}" alt="" onerror="this.style.display='none'">           </div>           {% endfor %}         </div>         {% elif knowledge.thumbnail %}         <div class="kpanel-gallery">           <div class="kgallery-item"><img loading="lazy" src="/img?url={{ knowledge.thumbnail|urlencode }}" alt="" onerror="this.style.display='none'"></div>         </div>         {% endif %}         {% if knowledge.socials and knowledge.socials|length > 0 %}         <div class="kpanel-socials">           {% for social in knowledge.socials %}           <a class="ksocial-link" href="{{ social.url }}" target="_blank" rel="noopener">             <img class="ksocial-icon" src="{{ social.icon }}" alt="" onerror="this.style.display='none'">             <span>{{ social.name }}</span>           </a>           {% endfor %}         </div>         {% endif %}         {% if knowledge.extract %}         <div class="kpanel-section">           <h3 class="ksection-title">&#128214; {% if knowledge.is_person %}Biography{% else %}Description{% endif %}</h3>           <p class="kpanel-bio collapsed" id="kpanelBio">{{ knowledge.extract }}</p>           {% if knowledge.extract|length > 300 %}           <button class="kbio-toggle" onclick="toggleBio()"><span id="bioToggleText">Show more</span></button>           {% endif %}         </div>         {% endif %}         {% if knowledge.fields and knowledge.fields|length > 0 %}         <div class="kpanel-section">           <h3 class="ksection-title">&#128202; Facts</h3>           <div class="kpanel-facts">             {% for f in knowledge.fields %}             <div class="kfact-row">               <div class="kfact-label">{{ f.label }}</div>               <div class="kfact-value">{% if f.is_link %}<a href="{{ f.value }}" target="_blank">{{ f.value[:35] }}...</a>{% else %}{{ f.value }}{% endif %}</div>             </div>             {% endfor %}           </div>         </div>         {% endif %}         {% if knowledge.related and knowledge.related|length > 0 %}         <div class="kpanel-section">           <h3 class="ksection-title">&#128101; See also</h3>           <div class="kpanel-related">             {% for rel in knowledge.related[:4] %}             <a class="krelated-item" href="/search?q={{ rel.name|urlencode }}">               <div class="krelated-photo">{% if rel.thumbnail %}<img src="/img?url={{ rel.thumbnail|urlencode }}" alt="">{% endif %}</div>               <div class="krelated-info">                 <div class="krelated-name">{{ rel.name }}</div>                 {% if rel.description %}<div class="krelated-desc">{{ rel.description }}</div>{% endif %}               </div>               <span>&#8594;</span>             </a>             {% endfor %}           </div>         </div>         {% endif %}         {% if knowledge.questions and knowledge.questions|length > 0 %}         <div class="kpanel-section">           <h3 class="ksection-title">&#10067; Questions</h3>           <div class="kpanel-questions">             {% for q in knowledge.questions[:4] %}             <a class="kquestion" href="/search?q={{ q|urlencode }}"><span>&#128270;</span><span>{{ q }}</span><span>&#8594;</span></a>             {% endfor %}           </div>         </div>         {% endif %}         <div class="kpanel-actions">           {% if knowledge.url %}<a class="kaction-btn primary" href="{{ knowledge.url }}" target="_blank">&#128218; Wikipedia</a>{% endif %}           <a class="kaction-btn" href="/images?q={{ query|urlencode }}">&#128444; Images</a>         </div>         <div class="kpanel-source">&#8505; {{ knowledge.source|default('Wikipedia + Wikidata', true) }}</div>         {% else %}         <div class="kpanel-empty"><div style="font-size:48px;opacity:0.5">&#128269;</div><div>No additional info</div></div>         <div class="kpanel-actions"><a class="kaction-btn" href="/images?q={{ query|urlencode }}">&#128444; Images</a></div>         {% endif %}       </div>     </div>   </div>   {% else %}   {% if images %}   <div class="img-grid" id="imgGrid">     {% for im in images %}     <div class="img-card" data-idx="{{ loop.index0 }}" data-full="{{ im.image_url }}" data-title="{{ im.title }}" data-domain="{{ im.domain }}" data-source="{{ im.source_url }}" data-thumb="{{ im.thumb_url }}">       <img class="img-thumb" loading="lazy" src="/img?url={{ im.thumb_url|urlencode }}" alt="{{ im.title }}"/>       <div class="img-meta">         <div class="img-title">{{ im.title[:60] }}{% if im.title|length > 60 %}...{% endif %}</div>         <div class="img-domain">{{ im.domain }}</div>       </div>     </div>     {% endfor %}   </div>   {% else %}   <div class="empty"><div class="empty-icon">&#128533;</div><div>No images found</div></div>   {% endif %}   {% endif %}   <div class="footer">PySearch 2026</div> </div> <div class="modal" id="modal">   <div class="modal-header">     <span class="modal-title" id="modalTitle"></span>     <span class="modal-counter" id="modalCounter"></span>     <div class="modal-actions">       <button class="btn" id="downloadBtn">&#11015; Open</button>       <button class="btn primary" id="sourceBtn">&#128279; Source</button>       <button class="btn" id="closeBtn">&#10005;</button>     </div>   </div>   <div class="modal-body" id="modalBody">     <div class="loader" id="loader"></div>     <button class="modal-nav prev" id="prevBtn">&#9664;</button>     <img class="modal-img" id="modalImg" alt=""/>     <button class="modal-nav next" id="nextBtn">&#9654;</button>   </div>   <div class="thumb-strip" id="thumbStrip"></div>   <div class="modal-footer">     <span class="modal-info" id="modalDomain"></span>     <span style="color:var(--muted2);font-size:12px">Esc - close | arrows - navigate</span>   </div> </div> {% endif %} <script> function toggleBio(){var b=document.getElementById('kpanelBio'),t=document.getElementById('bioToggleText');if(b.classList.contains('collapsed')){b.classList.remove('collapsed');t.textContent='Show less'}else{b.classList.add('collapsed');t.textContent='Show more'}} (function(){var i=document.getElementById('q'),b=document.getElementById('suggest');if(!i||!b)return;var timer,idx=-1,items=[],LS="pysearch.recent"; function esc(s){return String(s).replace(/[&<>"']/g,function(c){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]})} function getRecent(){try{return JSON.parse(localStorage.getItem(LS))||[]}catch(e){return[]}} function pushRecent(q){if(!q)return;var r=[q].concat(getRecent().filter(function(x){return x!==q})).slice(0,10);try{localStorage.setItem(LS,JSON.stringify(r))}catch(e){}} function close(){b.classList.remove('open');b.innerHTML='';idx=-1;items=[]} function render(h,list){items=list;idx=-1;if(!list.length){close();return} var s='<div class="suggest-head"><span>'+esc(h)+'</span>'+(h.indexOf('Recent')>=0?'<span class="suggest-clear" id="clr">Clear</span>':'')+'</div>'; list.slice(0,10).forEach(function(it,j){var t=typeof it==='string'?it:it.text;s+='<div class="suggest-item" data-i="'+j+'"><span>&#128270;</span><span>'+esc(t)+'</span></div>'}); b.innerHTML=s;b.querySelectorAll('.suggest-item').forEach(function(el){el.onmousedown=function(e){e.preventDefault();var t=items[+el.dataset.i];i.value=typeof t==='string'?t:t.text;close();pushRecent(i.value);i.form.submit()};el.onmouseenter=function(){b.querySelectorAll('.suggest-item').forEach(function(x){x.classList.remove('active')});el.classList.add('active');idx=+el.dataset.i}}); var c=document.getElementById('clr');if(c)c.onmousedown=function(e){e.preventDefault();localStorage.removeItem(LS);close()};b.classList.add('open')} async function fetch_(q){try{var r=await fetch('/suggest?q='+encodeURIComponent(q));return(await r.json()).suggestions||[]}catch(e){return[]}} i.onfocus=function(){if(!i.value.trim()){var r=getRecent();if(r.length)render('Recent',r)}}; i.oninput=function(){var q=i.value.trim();if(timer)clearTimeout(timer);if(!q){var r=getRecent();if(r.length)render('Recent',r);else close();return}timer=setTimeout(async function(){var s=await fetch_(q);if(i.value.trim()===q)render('Suggestions',s)},120)}; i.onkeydown=function(e){if(!b.classList.contains('open'))return;var els=b.querySelectorAll('.suggest-item');if(e.key==='ArrowDown'){e.preventDefault();idx=Math.min(idx+1,els.length-1)}else if(e.key==='ArrowUp'){e.preventDefault();idx=Math.max(idx-1,-1)}else if(e.key==='Escape'){close();return}else if(e.key==='Enter'){if(idx>=0&&items[idx]){e.preventDefault();i.value=typeof items[idx]==='string'?items[idx]:items[idx].text;close();pushRecent(i.value);i.form.submit()}else pushRecent(i.value);return}else return;els.forEach(function(el,j){el.classList.toggle('active',j===idx)});if(idx>=0&&items[idx])i.value=typeof items[idx]==='string'?items[idx]:items[idx].text}; document.onclick=function(e){if(!b.contains(e.target)&&e.target!==i)close()}})(); (function(){var g=document.getElementById('imgGrid'),m=document.getElementById('modal');if(!g||!m)return; var img=document.getElementById('modalImg'),title=document.getElementById('modalTitle'),domain=document.getElementById('modalDomain'),counter=document.getElementById('modalCounter'),strip=document.getElementById('thumbStrip'),loader=document.getElementById('loader'),cards=Array.from(g.querySelectorAll('.img-card')),cur=-1,srcUrl='',fullUrl=''; function buildThumbs(){strip.innerHTML='';cards.forEach(function(c,i){var d=document.createElement('div');d.className='thumb-item'+(i===cur?' active':'');d.innerHTML='<img src="/img?url='+encodeURIComponent(c.dataset.thumb)+'" alt="">';d.onclick=function(){open(i)};strip.appendChild(d)})} function open(i){if(i<0||i>=cards.length)return;cur=i;var c=cards[i];fullUrl=c.dataset.full;srcUrl=c.dataset.source;title.textContent=c.dataset.title||'Image';domain.textContent=c.dataset.domain;counter.textContent=(i+1)+' / '+cards.length;loader.style.display='block';img.style.opacity='0';img.onload=function(){loader.style.display='none';img.style.opacity='1'};img.onerror=function(){loader.style.display='none';img.style.opacity='1'};img.src='/img?url='+encodeURIComponent(fullUrl);document.getElementById('prevBtn').disabled=i===0;document.getElementById('nextBtn').disabled=i===cards.length-1;strip.querySelectorAll('.thumb-item').forEach(function(el,j){el.classList.toggle('active',j===cur)});m.classList.add('open');document.body.style.overflow='hidden'} function close(){m.classList.remove('open');img.src='';cur=-1;document.body.style.overflow=''} function prev(){if(cur>0)open(cur-1)} function next(){if(cur<cards.length-1)open(cur+1)} var built=false;cards.forEach(function(c,i){c.onclick=function(){if(!built){buildThumbs();built=true}open(i)}}); document.getElementById('closeBtn').onclick=close;document.getElementById('prevBtn').onclick=prev;document.getElementById('nextBtn').onclick=next; document.getElementById('downloadBtn').onclick=function(){if(fullUrl)window.open(fullUrl,'_blank')}; document.getElementById('sourceBtn').onclick=function(){if(srcUrl)window.open(srcUrl,'_blank','noopener')}; m.onclick=function(e){if(e.target===m||e.target.id==='modalBody')close()}; document.onkeydown=function(e){if(!m.classList.contains('open'))return;if(e.key==='Escape')close();else if(e.key==='ArrowLeft')prev();else if(e.key==='ArrowRight')next()}})(); </script> </body> </html> """  def normalize_url(u):     return (u or "").strip().rstrip("/").lower()  def get_domain(u):     try:         return urllib.parse.urlparse(u).netloc.lower()     except:         return ""  def safe_join(items, sep=", ", max_items=4):     xs = [x for x in (items or []) if x]     if len(xs) <= max_items:         return sep.join(xs)     return sep.join(xs[:max_items]) + f" +{len(xs)-max_items}"  def wd_time_to_date(t):     if not t:         return ""     m = re.match(r"^[\+\-]?(\d{1,4})(?:-(\d{2})-(\d{2}))?T", t)     if not m:         return t     y, mm, dd = m.group(1), m.group(2), m.group(3)     return f"{y}-{mm}-{dd}" if mm and dd else y  def get_commons_thumb_url(filename, width=420):     if not filename:         return ""     filename = filename.replace(" ", "_")     return f"https://commons.wikimedia.org/wiki/Special:FilePath/{urllib.parse.quote(filename)}?width={width}"  def generate_questions(name, cat="person"):     templates = QUESTIONS.get(cat, QUESTIONS["default"])     return [t.format(name=name) for t in templates]  def suggest_google(query, limit=10):     results = []     try:         r = SESSION.get("https://suggestqueries.google.com/complete/search", params={"client": "firefox", "q": query, "hl": "ru"}, timeout=3)         data = r.json()         if isinstance(data, list) and len(data) > 1:             for s in (data[1] or [])[:limit]:                 if isinstance(s, str) and s.strip():                     results.append({"text": s.strip(), "source": "Google"})     except:         pass     return results  def suggest_yandex(query, limit=10):     results = []     try:         r = SESSION.get("https://suggest.yandex.ru/suggest-ff.cgi", params={"part": query, "uil": "ru"}, timeout=3)         data = r.json()         if isinstance(data, list) and len(data) > 1:             for s in (data[1] or [])[:limit]:                 if isinstance(s, str) and s.strip():                     results.append({"text": s.strip(), "source": "Yandex"})     except:         pass     return results  def get_suggestions(query, limit=12):     query = (query or "").strip()     if not query:         return []     cache_key = f"sug:{query}:{limit}"     cached = suggest_cache.get(cache_key)     if cached is not None:         return cached     all_sug = []     seen = set()     try:         with ThreadPoolExecutor(max_workers=2) as ex:             futures = [ex.submit(suggest_google, query, 8), ex.submit(suggest_yandex, query, 8)]             for f in as_completed(futures, timeout=4):                 try:                     for item in (f.result(timeout=1) or []):                         t = (item.get("text") or "").strip().lower()                         if t and t not in seen:                             seen.add(t)                             all_sug.append(item)                 except:                     pass     except:         pass     ql = query.lower()     all_sug.sort(key=lambda x: (0 if x.get("text", "").lower().startswith(ql) else 1, len(x.get("text", ""))))     final = all_sug[:limit]     suggest_cache.set(cache_key, final)     return final  def search_duckduckgo_web(query, num_results=10):     results = []     try:         r = SESSION.get(f"https://html.duckduckgo.com/html/?q={urllib.parse.quote(query)}", timeout=12)         soup = BeautifulSoup(r.text, "html.parser")         for res in soup.select(".result"):             title_el = res.select_one(".result__a")             snippet_el = res.select_one(".result__snippet")             if not title_el:                 continue             title = title_el.get_text(strip=True)             href = title_el.get("href", "")             if "uddg=" in href:                 m = re.search(r"uddg=([^&]+)", href)                 if m:                     href = urllib.parse.unquote(m.group(1))             snippet = snippet_el.get_text(strip=True) if snippet_el else ""             if href and title and href.startswith("http"):                 results.append({"title": title, "url": href, "snippet": snippet, "domain": get_domain(href)})             if len(results) >= num_results:                 break     except Exception as e:         print(f"DDG web error: {e}")     return results  def search_bing_web(query, num_results=10):     results = []     try:         r = SESSION.get(f"https://www.bing.com/search?q={urllib.parse.quote(query)}", timeout=12)         soup = BeautifulSoup(r.text, "html.parser")         for res in soup.select(".b_algo"):             title_el = res.select_one("h2 a")             snippet_el = res.select_one(".b_caption p")             if not title_el:                 continue             title = title_el.get_text(strip=True)             href = title_el.get("href", "")             snippet = snippet_el.get_text(strip=True) if snippet_el else ""             if href and title and href.startswith("http"):                 results.append({"title": title, "url": href, "snippet": snippet, "domain": get_domain(href)})             if len(results) >= num_results:                 break     except Exception as e:         print(f"Bing web error: {e}")     return results  def search_all_web(query, num_results=15):     cache_key = f"web:{query}:{num_results}"     cached = web_cache.get(cache_key)     if cached is not None:         return cached     all_results = []     seen = set()     with ThreadPoolExecutor(max_workers=2) as ex:         futures = [ex.submit(search_duckduckgo_web, query, num_results), ex.submit(search_bing_web, query, num_results)]         for f in as_completed(futures):             try:                 for r in (f.result() or []):                     nu = normalize_url(r.get("url"))                     if nu and nu not in seen:                         seen.add(nu)                         all_results.append(r)             except Exception as e:                 print(f"Search error: {e}")     final = all_results[:num_results]     web_cache.set(cache_key, final)     return final  def search_bing_images(query, num_results=32):     cache_key = f"img:bing:{query}:{num_results}"     cached = img_cache.get(cache_key)     if cached is not None:         return cached     out = []     try:         r = SESSION.get("https://www.bing.com/images/search", params={"q": query, "form": "HDRSC2"}, timeout=12)         soup = BeautifulSoup(r.text, "html.parser")         for a in soup.select("a.iusc"):             m = a.get("m", "")             if not m:                 continue             try:                 data = json.loads(m)             except:                 continue             img = data.get("murl", "")             thumb = data.get("turl", "") or img             title = data.get("t", "Image")             page = data.get("purl", "") or a.get("href", "")             if img:                 out.append({"image_url": img, "thumb_url": thumb, "title": str(title).strip(), "source_url": page, "domain": get_domain(page) or get_domain(img)})             if len(out) >= num_results:                 break     except Exception as e:         print(f"Bing images error: {e}")     img_cache.set(cache_key, out)     return out  def get_gallery_images(query, num_images=6):     cache_key = f"gallery:{query}:{num_images}"     cached = gallery_cache.get(cache_key)     if cached is not None:         return cached     gallery = []     try:         images = search_bing_images(query, num_results=num_images + 2)         for img in images[:num_images]:             gallery.append({"url": img.get("image_url") or img.get("thumb_url"), "thumb": img.get("thumb_url") or img.get("image_url"), "title": img.get("title", ""), "source": img.get("source_url", "")})     except Exception as e:         print(f"Gallery error: {e}")     gallery_cache.set(cache_key, gallery)     return gallery  def ddg_instant_answer(query):     cache_key = f"ddg_ia:{query.lower()}"     cached = ddg_instant_cache.get(cache_key)     if cached is not None:         return cached     try:         r = SESSION.get("https://api.duckduckgo.com/", params={"q": query, "format": "json", "no_html": "1", "skip_disambig": "1"}, timeout=10)         data = r.json()         ddg_instant_cache.set(cache_key, data)         return data     except Exception as e:         print(f"DDG IA error: {e}")         ddg_instant_cache.set(cache_key, {})         return {}  def wiki_find_title(query, lang="ru"):     for ln in [lang, "en"]:         try:             wiki_rate_limiter.wait()             api = f"https://{ln}.wikipedia.org/w/api.php"             r = WIKI_SESSION.get(api, params={"action": "query", "list": "search", "srsearch": query, "srlimit": 1, "format": "json", "utf8": 1}, timeout=10)             r.raise_for_status()             hits = (r.json().get("query") or {}).get("search") or []             if hits:                 return hits[0].get("title"), hits[0].get("pageid"), ln         except Exception as e:             print(f"Wiki find error ({ln}): {e}")     return None, None, None  def wiki_summary(title, lang="ru"):     try:         wiki_rate_limiter.wait()         title_enc = urllib.parse.quote(title.replace(" ", "_"))         r = WIKI_SESSION.get(f"https://{lang}.wikipedia.org/api/rest_v1/page/summary/{title_enc}", timeout=10)         r.raise_for_status()         s = r.json()         return {"title": s.get("title") or title, "description": s.get("description") or "", "extract": s.get("extract") or "", "thumbnail": ((s.get("thumbnail") or {}).get("source")) or "", "url": (((s.get("content_urls") or {}).get("desktop") or {}).get("page")) or ""}     except Exception as e:         print(f"Wiki summary error: {e}")         return {"title": title, "description": "", "extract": "", "thumbnail": "", "url": ""}  def wiki_pageprops(title, lang="ru"):     try:         wiki_rate_limiter.wait()         api = f"https://{lang}.wikipedia.org/w/api.php"         r = WIKI_SESSION.get(api, params={"action": "query", "format": "json", "prop": "pageprops|pageimages", "titles": title, "ppprop": "wikibase_item", "piprop": "thumbnail", "pithumbsize": 400, "redirects": 1, "utf8": 1}, timeout=10)         r.raise_for_status()         pages = (r.json().get("query") or {}).get("pages") or {}         for _, p in pages.items():             qid = ((p.get("pageprops") or {}).get("wikibase_item")) or ""             thumb = ((p.get("thumbnail") or {}).get("source")) or ""             return qid, thumb     except Exception as e:         print(f"Wiki pageprops error: {e}")     return "", ""  def wikidata_get_entities(ids, languages="ru|en", props="labels|descriptions|claims"):     if not ids:         return {}     if isinstance(ids, (list, tuple, set)):         ids = "|".join([x for x in ids if x])     if not ids:         return {}     cache_key = f"wd:{ids}:{languages}:{props}"     cached = wikidata_cache.get(cache_key)     if cached is not None:         return cached     try:         r = WIKI_SESSION.get("https://www.wikidata.org/w/api.php", params={"action": "wbgetentities", "ids": ids, "format": "json", "props": props, "languages": languages}, timeout=12)         r.raise_for_status()         data = r.json() or {}         wikidata_cache.set(cache_key, data)         return data     except Exception as e:         print(f"Wikidata error: {e}")         wikidata_cache.set(cache_key, {})         return {}  def wd_label(ent_data, qid):     try:         ent = (ent_data.get("entities") or {}).get(qid) or {}         labels = ent.get("labels") or {}         return labels.get("ru", {}).get("value") or labels.get("en", {}).get("value") or ""     except:         return ""  def wd_claims(ent_data, qid):     try:         return ((ent_data.get("entities") or {}).get(qid) or {}).get("claims") or {}     except:         return {}  def wd_get_entity_ids(claims, pid, max_items=8):     out = []     for cl in (claims.get(pid) or [])[:max_items]:         dv = (((cl.get("mainsnak") or {}).get("datavalue")) or {}).get("value")         if isinstance(dv, dict) and dv.get("entity-type") == "item":             q = dv.get("id", "")             if q and q not in out:                 out.append(q)     return out  def wd_get_time(claims, pid):     for cl in (claims.get(pid) or [])[:1]:         dv = (((cl.get("mainsnak") or {}).get("datavalue")) or {}).get("value")         if isinstance(dv, dict) and "time" in dv:             return wd_time_to_date(dv.get("time"))     return ""  def wd_get_string(claims, pid):     for cl in (claims.get(pid) or [])[:1]:         dv = (((cl.get("mainsnak") or {}).get("datavalue")) or {}).get("value")         if isinstance(dv, str):             return dv.strip()     return ""  def wd_get_commons_image(claims):     for cl in (claims.get("P18") or [])[:1]:         dv = (((cl.get("mainsnak") or {}).get("datavalue")) or {}).get("value")         if isinstance(dv, str) and dv.strip():             return dv.strip()     return ""  def wd_get_social_links(claims):     socials = []     vk = wd_get_string(claims, "P3185")     if vk:         socials.append({"key": "vk", "name": "VK", "icon": SOCIAL_ICONS["vk"], "url": f"https://vk.com/{vk}", "priority": 2})     ig = wd_get_string(claims, "P2003")     if ig:         socials.append({"key": "instagram", "name": "Instagram", "icon": SOCIAL_ICONS["instagram"], "url": f"https://www.instagram.com/{ig}", "priority": 3})     tg = wd_get_string(claims, "P3789")     if tg:         socials.append({"key": "telegram", "name": "Telegram", "icon": SOCIAL_ICONS["telegram"], "url": f"https://t.me/{tg}", "priority": 4})     yt = wd_get_string(claims, "P2397")     if yt:         socials.append({"key": "youtube", "name": "YouTube", "icon": SOCIAL_ICONS["youtube"], "url": f"https://www.youtube.com/channel/{yt}", "priority": 5})     tw = wd_get_string(claims, "P2002")     if tw:         socials.append({"key": "twitter", "name": "X", "icon": SOCIAL_ICONS["twitter"], "url": f"https://twitter.com/{tw}", "priority": 6})     fb = wd_get_string(claims, "P2013")     if fb:         socials.append({"key": "facebook", "name": "Facebook", "icon": SOCIAL_ICONS["facebook"], "url": f"https://www.facebook.com/{fb}", "priority": 7})     return socials  def get_related_entities(qid, occupation_ids, limit=5):     cache_key = f"related:{qid}:{','.join(occupation_ids[:2])}:{limit}"     cached = related_cache.get(cache_key)     if cached is not None:         return cached     related = []     if not occupation_ids:         return related     try:         occupation_qid = occupation_ids[0]         sparql = f"SELECT ?item ?itemLabel ?itemDescription ?image WHERE {{ ?item wdt:P106 wd:{occupation_qid} . ?item wdt:P31 wd:Q5 . FILTER(?item != wd:{qid}) OPTIONAL {{ ?item wdt:P18 ?image . }} SERVICE wikibase:label {{ bd:serviceParam wikibase:language \"ru,en\". }} }} LIMIT 15"         r = WIKI_SESSION.get("https://query.wikidata.org/sparql", params={"query": sparql}, headers={"Accept": "application/json"}, timeout=15)         r.raise_for_status()         results = r.json().get("results", {}).get("bindings", [])         seen = {qid}         for item in results:             item_uri = item.get("item", {}).get("value", "")             item_qid = item_uri.split("/")[-1] if item_uri else ""             if not item_qid or item_qid in seen:                 continue             seen.add(item_qid)             name = item.get("itemLabel", {}).get("value", "")             desc = item.get("itemDescription", {}).get("value", "")             image_url = item.get("image", {}).get("value", "")             if name.startswith("Q") and name[1:].isdigit():                 continue             thumbnail = ""             if image_url:                 filename = urllib.parse.unquote(image_url.split("/")[-1])                 thumbnail = get_commons_thumb_url(filename, width=100)             related.append({"qid": item_qid, "name": name, "description": desc[:50] + "..." if len(desc) > 50 else desc, "thumbnail": thumbnail})             if len(related) >= limit:                 break     except Exception as e:         print(f"Related error: {e}")     related_cache.set(cache_key, related)     return related  def wiki_knowledge_panel(query, search_results=None):     q = (query or "").strip()     if not q:         return None     cache_key = f"wiki_kp_v9:{q.lower()}"     cached = wiki_cache.get(cache_key)     if cached is not None:         return cached     panel = None     is_person = False     occupation_ids = []     main_qid = ""     try:         data = ddg_instant_answer(q)         abstract = data.get("AbstractText", "")         heading = data.get("Heading", "")         abstract_url = data.get("AbstractURL", "")         image = data.get("Image", "")         entity = data.get("Entity", "")         source = data.get("AbstractSource", "")         if abstract or heading:             thumbnail = ""             if image:                 if image.startswith("http"):                     thumbnail = image                 elif image.startswith("/"):                     thumbnail = "https://duckduckgo.com" + image             fields = []             infobox = (data.get("Infobox") or {}).get("content") or []             for item in infobox[:8]:                 if isinstance(item, dict):                     label = item.get("label", "")                     value = item.get("value", "")                     if label and value:                         fields.append({"label": label, "value": str(value), "is_link": str(value).startswith("http")})             panel = {"title": heading or q, "description": entity or "", "extract": abstract, "thumbnail": thumbnail, "url": abstract_url, "wikidata_id": "", "wikidata_url": "", "kind": entity or "", "fields": fields, "source": f"DuckDuckGo ({source})" if source else "DuckDuckGo", "is_person": False, "gallery": [], "socials": [], "questions": [], "related": []}     except Exception as e:         print(f"DDG panel error: {e}")     if not panel or not panel.get("extract"):         try:             title, _, lang = wiki_find_title(q)             if title and lang:                 summ = wiki_summary(title, lang)                 qid, thumb_props = wiki_pageprops(title, lang)                 wiki_panel = {"title": summ.get("title") or title, "description": summ.get("description") or "", "extract": summ.get("extract") or "", "thumbnail": summ.get("thumbnail") or thumb_props or "", "url": summ.get("url") or "", "wikidata_id": qid or "", "wikidata_url": f"https://www.wikidata.org/wiki/{qid}" if qid else "", "kind": "", "fields": [], "source": "Wikipedia + Wikidata", "is_person": False, "gallery": [], "socials": [], "questions": [], "related": []}                 if qid:                     main_qid = qid                     ent = wikidata_get_entities(qid, props="labels|descriptions|claims", languages="ru|en")                     claims = wd_claims(ent, qid)                     inst = wd_get_entity_ids(claims, "P31", max_items=10)                     is_human = "Q5" in inst                     wiki_panel["is_person"] = is_human                     is_person = is_human                     wd_socials = wd_get_social_links(claims)                     wiki_panel["socials"] = wd_socials                     if is_human:                         wiki_panel["kind"] = "Person"                         img_filename = wd_get_commons_image(claims)                         if img_filename:                             wiki_panel["thumbnail"] = get_commons_thumb_url(img_filename, width=420)                         q_occupation = wd_get_entity_ids(claims, "P106", max_items=6)                         occupation_ids = q_occupation                         q_citizen = wd_get_entity_ids(claims, "P27", max_items=4)                         q_birthplace = wd_get_entity_ids(claims, "P19", max_items=2)                         need_labels = set(q_occupation + q_citizen + q_birthplace)                         labels_data = wikidata_get_entities(list(need_labels), props="labels", languages="ru|en")                         born = wd_get_time(claims, "P569")                         died = wd_get_time(claims, "P570")                         birthplace = safe_join([wd_label(labels_data, x) for x in q_birthplace])                         occupation = safe_join([wd_label(labels_data, x) for x in q_occupation])                         citizen = safe_join([wd_label(labels_data, x) for x in q_citizen])                         website = wd_get_string(claims, "P856")                         fields = []                         if born or birthplace:                             val = born                             if birthplace:                                 val = (val + ", " if val else "") + birthplace                             fields.append({"label": "Birth", "value": val, "is_link": False})                         if died:                             fields.append({"label": "Death", "value": died, "is_link": False})                         if occupation:                             fields.append({"label": "Occupation", "value": occupation, "is_link": False})                         if citizen:                             fields.append({"label": "Citizenship", "value": citizen, "is_link": False})                         if website and website.startswith("http"):                             fields.append({"label": "Website", "value": website, "is_link": True})                         wiki_panel["fields"] = fields                         wiki_panel["questions"] = generate_questions(wiki_panel["title"], "person")                     else:                         wiki_panel["questions"] = generate_questions(wiki_panel["title"], "default")                 if wiki_panel.get("extract") and (not panel or not panel.get("extract")):                     panel = wiki_panel                 elif wiki_panel.get("extract") and panel:                     if not panel.get("thumbnail") and wiki_panel.get("thumbnail"):                         panel["thumbnail"] = wiki_panel["thumbnail"]                     if not panel.get("fields") and wiki_panel.get("fields"):                         panel["fields"] = wiki_panel["fields"]                     if wiki_panel.get("wikidata_url"):                         panel["wikidata_url"] = wiki_panel["wikidata_url"]                     if wiki_panel.get("url"):                         panel["url"] = wiki_panel["url"]                     if wiki_panel.get("socials"):                         panel["socials"] = wiki_panel["socials"]                     if wiki_panel.get("is_person"):                         panel["is_person"] = wiki_panel["is_person"]                         is_person = True                     if wiki_panel.get("questions"):                         panel["questions"] = wiki_panel["questions"]                     panel["source"] = "Wikipedia + Wikidata + DuckDuckGo"         except Exception as e:             print(f"Wiki panel error: {e}")             traceback.print_exc()     if panel:         try:             gallery_query = panel.get("title") or q             panel["gallery"] = get_gallery_images(gallery_query, num_images=6)         except Exception as e:             print(f"Gallery error: {e}")             panel["gallery"] = []         if panel.get("url") and "wikipedia.org" in panel.get("url", ""):             wiki_social = {"key": "wikipedia", "name": "Wikipedia", "icon": SOCIAL_ICONS["wikipedia"], "url": panel["url"], "priority": 1}             if not panel.get("socials"):                 panel["socials"] = []             panel["socials"] = [wiki_social] + [s for s in panel["socials"] if s["key"] != "wikipedia"]         panel["socials"] = sorted(panel.get("socials", []), key=lambda x: x.get("priority", 99))[:6]         if is_person and occupation_ids and main_qid:             try:                 panel["related"] = get_related_entities(main_qid, occupation_ids, limit=5)             except Exception as e:                 print(f"Related error: {e}")                 panel["related"] = []         else:             panel["related"] = []     if panel and not panel.get("extract") and not panel.get("description"):         panel = None     wiki_cache.set(cache_key, panel)     return panel  @app.route("/favicon") def favicon_proxy():     domain = (request.args.get("domain") or "").strip().lower()     if not domain or "/" in domain:         abort(400)     cached = favicon_cache.get(domain)     if cached:         content, ctype = cached         return Response(content, content_type=ctype, headers={"Cache-Control": "public, max-age=3600"})     try:         r = SESSION.get("https://www.google.com/s2/favicons", params={"domain": domain, "sz": "64"}, timeout=8)         ctype = r.headers.get("Content-Type", "image/png")         content = r.content or b""         if content:             favicon_cache.set(domain, (content, ctype))             return Response(content, content_type=ctype, headers={"Cache-Control": "public, max-age=3600"})     except:         pass     abort(404)  @app.route("/img") def image_proxy():     raw = (request.args.get("url") or "").strip()     if not raw:         abort(400)     try:         url = raw         for _ in range(3):             decoded = urllib.parse.unquote(url)             if decoded == url:                 break             url = decoded         p = urllib.parse.urlparse(url)         if p.scheme not in ("http", "https"):             abort(400)     except:         abort(400)     MAX_BYTES = 15 * 1024 * 1024     if "wikimedia.org" in url or "wikipedia.org" in url:         try:             headers = {"User-Agent": UA_WIKI, "Accept": "image/*,*/*", "Referer": "https://www.wikipedia.org/"}             if "Special:FilePath" in url:                 r = requests.get(url, headers=headers, allow_redirects=True, timeout=15)             else:                 r = requests.get(url, headers=headers, timeout=15)             r.raise_for_status()             ctype = r.headers.get("Content-Type", "image/jpeg")             return Response(r.content, content_type=ctype, headers={"Cache-Control": "public, max-age=3600"})         except Exception as e:             print(f"Wikimedia image error: {e}")             abort(404)     try:         with SESSION.get(url, stream=True, timeout=15, headers={"Referer": "https://www.google.com/", "Accept": "image/*,*/*"}) as r:             r.raise_for_status()             ctype = r.headers.get("Content-Type", "image/jpeg")             total = 0             chunks = []             for chunk in r.iter_content(chunk_size=64*1024):                 if chunk:                     total += len(chunk)                     if total > MAX_BYTES:                         abort(413)                     chunks.append(chunk)             return Response(b"".join(chunks), content_type=ctype, headers={"Cache-Control": "public, max-age=600"})     except Exception as e:         print(f"Image proxy error: {e}")         abort(404)  @app.route("/") def home():     trending = random.sample(TRENDING, min(6, len(TRENDING)))     return render_template_string(HTML_TEMPLATE, query=None, tab="web", trending=trending, results=[], images=[], elapsed=0, knowledge=None)  @app.route("/suggest") def suggest():     q = (request.args.get("q") or "").strip()     if not q:         return jsonify({"suggestions": []})     try:         suggestions = get_suggestions(q, limit=12)         return jsonify({"suggestions": suggestions})     except Exception as e:         print(f"Suggest error: {e}")         return jsonify({"suggestions": []})  @app.route("/search") def search_web():     query = (request.args.get("q") or "").strip()     if not query:         return home()     start = time.time()     results = search_all_web(query, 15)     knowledge = wiki_knowledge_panel(query, search_results=results)     elapsed = round(time.time() - start, 2)     return render_template_string(HTML_TEMPLATE, query=query, tab="web", results=results, images=[], elapsed=elapsed, trending=[], knowledge=knowledge)  @app.route("/images") def search_images():     query = (request.args.get("q") or "").strip()     if not query:         return home()     start = time.time()     images = search_bing_images(query, num_results=32)     elapsed = round(time.time() - start, 2)     return render_template_string(HTML_TEMPLATE, query=query, tab="images", results=[], images=images, elapsed=elapsed, trending=[], knowledge=None)  if __name__ == "__main__":     print("=" * 60)     print("  PySearch v9 - Fully Fixed Version")     print("=" * 60)     print("  http://localhost:5000")     print("=" * 60)     app.run(debug=True, host="0.0.0.0", port=5000)                (,  ai)                  
