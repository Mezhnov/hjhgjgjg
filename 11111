#!/usr/bin/env python3
"""
üîß –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
"""
import sqlite3
import os
import shutil
from datetime import datetime

CORRUPTED_DB = 'bot_database_corrupted_20260219_213016.db'
NEW_DB = 'bot_database.db'

def create_new_database():
    """–°–æ–∑–¥–∞—ë—Ç —á–∏—Å—Ç—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    if os.path.exists(NEW_DB):
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        backup_name = f'bot_database_old_{timestamp}.db'
        shutil.copy2(NEW_DB, backup_name)
        print(f"üì¶ –°—Ç–∞—Ä–∞—è –±–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ {backup_name}")
        os.remove(NEW_DB)
    
    conn = sqlite3.connect(NEW_DB)
    cursor = conn.cursor()
    cursor.execute("""CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        first_name TEXT,
        last_name TEXT,
        password TEXT,
        is_logged_in INTEGER DEFAULT 0,
        user_group TEXT DEFAULT '',
        group_id INTEGER DEFAULT 0
    )""")
    conn.commit()
    conn.close()
    print("‚úÖ –ù–æ–≤–∞—è –±–∞–∑–∞ —Å–æ–∑–¥–∞–Ω–∞")
    return True

def recover_data_from_backup():
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω–æ–π –∫–æ–ø–∏–∏"""
    if not os.path.exists(CORRUPTED_DB):
        print(f"‚ùå –§–∞–π–ª {CORRUPTED_DB} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return []
    
    recovered_data = []
    
    # –ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ
    try:
        conn = sqlite3.connect(CORRUPTED_DB)
        conn.execute("PRAGMA journal_mode=OFF")
        cursor = conn.cursor()
        cursor.execute("SELECT user_id, first_name, last_name, password, is_logged_in, user_group, group_id FROM users")
        recovered_data = cursor.fetchall()
        conn.close()
        print(f"‚úÖ –ú–µ—Ç–æ–¥ 1: –ò–∑–≤–ª–µ—á–µ–Ω–æ {len(recovered_data)} –∑–∞–ø–∏—Å–µ–π")
    except Exception as e:
        print(f"‚ö†Ô∏è –ú–µ—Ç–æ–¥ 1 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª: {e}")
    
    # –ú–µ—Ç–æ–¥ 2: –ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ (–µ—Å–ª–∏ –ú–µ—Ç–æ–¥ 1 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
    if not recovered_data:
        try:
            conn = sqlite3.connect(CORRUPTED_DB)
            cursor = conn.cursor()
            offset = 0
            limit = 10
            while True:
                try:
                    cursor.execute(f"SELECT user_id, first_name, last_name, password, is_logged_in, user_group, group_id FROM users LIMIT {limit} OFFSET {offset}")
                    rows = cursor.fetchall()
                    if not rows:
                        break
                    recovered_data.extend(rows)
                    offset += limit
                except:
                    offset += limit
                if offset > 10000:
                    break
            conn.close()
            print(f"‚úÖ –ú–µ—Ç–æ–¥ 2: –ò–∑–≤–ª–µ—á–µ–Ω–æ {len(recovered_data)} –∑–∞–ø–∏—Å–µ–π")
        except Exception as e:
            print(f"‚ö†Ô∏è –ú–µ—Ç–æ–¥ 2 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª: {e}")
    
    return recovered_data

def insert_data(data):
    """–í—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—É—é –±–∞–∑—É"""
    if not data:
        print("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è")
        return 0
    
    conn = sqlite3.connect(NEW_DB)
    cursor = conn.cursor()
    restored = 0
    
    for row in data:
        try:
            cursor.execute("""
                INSERT OR REPLACE INTO users 
                (user_id, first_name, last_name, password, is_logged_in, user_group, group_id)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            """, row)
            restored += 1
        except Exception as e:
            print(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–ø–∏—Å—å {row[0] if row else 'N/A'}: {e}")
    
    conn.commit()
    conn.close()
    print(f"‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {restored} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    return restored

def verify_database():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –Ω–æ–≤–æ–π –±–∞–∑—ã"""
    print("\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤–æ–π –±–∞–∑—ã...")
    conn = sqlite3.connect(NEW_DB)
    cursor = conn.cursor()
    
    cursor.execute("PRAGMA integrity_check")
    result = cursor.fetchone()
    print(f"   –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å: {result[0]}")
    
    cursor.execute("SELECT COUNT(*) FROM users")
    count = cursor.fetchone()[0]
    print(f"   –ó–∞–ø–∏—Å–µ–π: {count}")
    
    if count > 0:
        cursor.execute("SELECT user_id, first_name, last_name, user_group FROM users LIMIT 5")
        print("   –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π:")
        for row in cursor.fetchall():
            print(f"      {row}")
    
    conn.close()

def main():
    print("=" * 60)
    print("üîß –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–•")
    print("=" * 60)
    
    # 1. –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    data = recover_data_from_backup()
    
    # 2. –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –±–∞–∑—É
    create_new_database()
    
    # 3. –í—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
    insert_data(data)
    
    # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º
    verify_database()
    
    print("\n" + "=" * 60)
    print("‚úÖ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!")
    print("=" * 60)
    print("üöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: python 112.py")

if __name__ == "__main__":
    main()
