import sqlite3
import os
import shutil

CORRUPTED_DB = 'bot_database_corrupted_20260219_213016.db'
NEW_DB = 'bot_database.db'

def recover():
    print("üîß –ù–∞—á–∞–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è...")
    
    # 1. –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä–∞—è –±–∞–∑–∞ - —É–¥–∞–ª—è–µ–º –µ—ë
    if os.path.exists(NEW_DB):
        os.remove(NEW_DB)
        print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è {NEW_DB}")
    
    # 2. –°–æ–∑–¥–∞—ë–º —á–∏—Å—Ç—É—é –±–∞–∑—É
    conn = sqlite3.connect(NEW_DB)
    cursor = conn.cursor()
    cursor.execute("""CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        first_name TEXT,
        last_name TEXT,
        password TEXT,
        is_logged_in INTEGER DEFAULT 0,
        user_group TEXT DEFAULT '',
        group_id INTEGER DEFAULT 0
    )""")
    conn.commit()
    print("‚úÖ –°–æ–∑–¥–∞–Ω–∞ —á–∏—Å—Ç–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö")
    
    # 3. –ü—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∏—Ç–æ–π –∫–æ–ø–∏–∏
    if not os.path.exists(CORRUPTED_DB):
        print(f"‚ùå –§–∞–π–ª {CORRUPTED_DB} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        conn.close()
        return

    data = []
    try:
        # –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫
        conn_backup = sqlite3.connect(CORRUPTED_DB)
        conn_backup.execute("PRAGMA journal_mode=OFF")
        conn_backup.execute("PRAGMA ignore_check_constraints=ON")
        cur = conn_backup.cursor()
        
        # –ß–∏—Ç–∞–µ–º –ø–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏, —á—Ç–æ–±—ã –Ω–µ —É–ø–∞—Å—Ç—å –Ω–∞ –æ—à–∏–±–∫–µ
        try:
            cur.execute("SELECT user_id, first_name, last_name, password, is_logged_in, user_group, group_id FROM users")
            data = cur.fetchall()
            print(f"üì¶ –ò–∑–≤–ª–µ—á–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {len(data)}")
        except sqlite3.DatabaseError as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: {e}")
            print("–ü—ã—Ç–∞–µ–º—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥...")
            # –ï—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ - –ø—Ä–æ–±—É–µ–º —á–∏—Ç–∞—Ç—å –ø–æ ID (–µ—Å–ª–∏ –æ–Ω–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã)
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã - –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥
            pass
        conn_backup.close()
    except Exception as e:
        print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é: {e}")
    
    # 4. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—É—é –±–∞–∑—É
    if data:
        for row in data:
            try:
                cursor.execute("""
                    INSERT OR REPLACE INTO users 
                    (user_id, first_name, last_name, password, is_logged_in, user_group, group_id)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                """, row)
            except Exception as e:
                print(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–ø–∏—Å—å: {e}")
        conn.commit()
        print("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã!")
    else:
        print("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.")
    
    conn.close()
    
    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞
    conn_check = sqlite3.connect(NEW_DB)
    cur_check = conn_check.cursor()
    cur_check.execute("SELECT COUNT(*) FROM users")
    count = cur_check.fetchone()[0]
    conn_check.close()
    
    print(f"üìä –ò—Ç–æ–≥–æ –≤ –±–∞–∑–µ: {count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    print("üöÄ –ì–û–¢–û–í–û. –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–π –±–æ—Ç–∞ (112.py)")

if __name__ == "__main__":
    recover()
