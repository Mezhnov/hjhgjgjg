import sqlite3
import os
import shutil

BACKUP_FILE = 'bot_database_corrupted_20260219_213016.db'
TARGET_DB = 'bot_database.db'

def restore():
    print("üîß –ù–∞—á–∞–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è...")
    
    # 1. –£–¥–∞–ª—è–µ–º –±–∏—Ç—É—é –±–∞–∑—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    if os.path.exists(TARGET_DB):
        os.remove(TARGET_DB)
        print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–∞—è {TARGET_DB}")
    
    # 2. –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—É—é –±–∞–∑—É
    conn = sqlite3.connect(TARGET_DB)
    cursor = conn.cursor()
    cursor.execute("""CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        first_name TEXT,
        last_name TEXT,
        password TEXT,
        is_logged_in INTEGER DEFAULT 0,
        user_group TEXT DEFAULT '',
        group_id INTEGER DEFAULT 0
    )""")
    conn.commit()
    print("‚úÖ –°–æ–∑–¥–∞–Ω–∞ —á–∏—Å—Ç–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö")
    
    # 3. –ü—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
    if not os.path.exists(BACKUP_FILE):
        print(f"‚ùå –§–∞–π–ª {BACKUP_FILE} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return

    data = []
    try:
        # –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é
        conn_backup = sqlite3.connect(BACKUP_FILE)
        conn_backup.execute("PRAGMA journal_mode=OFF")
        cur = conn_backup.cursor()
        cur.execute("SELECT user_id, first_name, last_name, password, is_logged_in, user_group, group_id FROM users")
        data = cur.fetchall()
        conn_backup.close()
        print(f"üì¶ –ò–∑–≤–ª–µ—á–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {len(data)}")
    except Exception as e:
        print(f"‚ö†Ô∏è –ü—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å: {e}")
        print("–ü—ã—Ç–∞–µ–º—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥...")
        # –ï—Å–ª–∏ —Ñ–∞–π–ª —Ç–æ–∂–µ –±–∏—Ç—ã–π, –ø—Ä–æ–±—É–µ–º —á–∏—Ç–∞—Ç—å –ø–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        # –í —Å–ª–æ–∂–Ω–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sqlite3 .recover, –Ω–æ –ø–æ–ø—Ä–æ–±—É–µ–º —Ç–∞–∫
        return

    # 4. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—É—é –±–∞–∑—É
    if data:
        for row in data:
            try:
                cursor.execute("""
                    INSERT OR REPLACE INTO users 
                    (user_id, first_name, last_name, password, is_logged_in, user_group, group_id)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                """, row)
            except Exception as e:
                print(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–ø–∏—Å—å: {e}")
        conn.commit()
        print("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã!")
    else:
        print("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.")
    
    conn.close()
    print("üöÄ –ì–û–¢–û–í–û. –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–π –±–æ—Ç–∞ (112.py)")

if __name__ == "__main__":
    restore()
