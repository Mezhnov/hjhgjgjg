package com.example.myapplication

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.BasicTextField
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.focus.FocusDirection
import androidx.compose.ui.focus.FocusRequester
import androidx.compose.ui.focus.focusRequester
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.SolidColor
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.text.TextRange
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.input.TextFieldValue
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.window.Dialog
import androidx.compose.ui.window.DialogProperties
import com.example.myapplication.ui.theme.MyApplicationTheme
import kotlinx.coroutines.delay

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            MyApplicationTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    TelegramAuthApp()
                }
            }
        }
    }
}

// –°–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
sealed class AuthScreen {
    object PhoneInput : AuthScreen()
    data class CodeVerification(val phoneNumber: String, val countryCode: String) : AuthScreen()
    data class Registration(val phoneNumber: String) : AuthScreen()
    object Success : AuthScreen()
}

// –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç—Ä–∞–Ω—ã
data class Country(
    val name: String,
    val code: String,
    val flag: String,
    val phoneCode: String
)

// –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
data class UserData(
    var firstName: String = "",
    var lastName: String = "",
    var birthDay: String = "",
    var birthMonth: String = "",
    var birthYear: String = "",
    var bio: String = "",
    var username: String = ""
)

// –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω
val countries = listOf(
    Country("–†–æ—Å—Å–∏—è", "RU", "üá∑üá∫", "+7"),
    Country("–£–∫—Ä–∞–∏–Ω–∞", "UA", "üá∫üá¶", "+380"),
    Country("–ë–µ–ª–∞—Ä—É—Å—å", "BY", "üáßüáæ", "+375"),
    Country("–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", "KZ", "üá∞üáø", "+7"),
    Country("–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", "UZ", "üá∫üáø", "+998"),
    Country("–ì–µ—Ä–º–∞–Ω–∏—è", "DE", "üá©üá™", "+49"),
    Country("–°–®–ê", "US", "üá∫üá∏", "+1"),
    Country("–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", "GB", "üá¨üáß", "+44"),
    Country("–§—Ä–∞–Ω—Ü–∏—è", "FR", "üá´üá∑", "+33"),
    Country("–ò—Ç–∞–ª–∏—è", "IT", "üáÆüáπ", "+39"),
    Country("–ò—Å–ø–∞–Ω–∏—è", "ES", "üá™üá∏", "+34"),
    Country("–ü–æ–ª—å—à–∞", "PL", "üáµüá±", "+48"),
    Country("–¢—É—Ä—Ü–∏—è", "TR", "üáπüá∑", "+90"),
    Country("–ö–∏—Ç–∞–π", "CN", "üá®üá≥", "+86"),
    Country("–Ø–ø–æ–Ω–∏—è", "JP", "üáØüáµ", "+81"),
    Country("–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è", "KR", "üá∞üá∑", "+82"),
    Country("–ò–Ω–¥–∏—è", "IN", "üáÆüá≥", "+91"),
    Country("–ë—Ä–∞–∑–∏–ª–∏—è", "BR", "üáßüá∑", "+55"),
    Country("–ö–∞–Ω–∞–¥–∞", "CA", "üá®üá¶", "+1"),
    Country("–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "AU", "üá¶üá∫", "+61"),
    Country("–û–ê–≠", "AE", "üá¶üá™", "+971"),
    Country("–ì—Ä—É–∑–∏—è", "GE", "üá¨üá™", "+995"),
    Country("–ê—Ä–º–µ–Ω–∏—è", "AM", "üá¶üá≤", "+374"),
    Country("–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω", "AZ", "üá¶üáø", "+994"),
    Country("–ú–æ–ª–¥–æ–≤–∞", "MD", "üá≤üá©", "+373"),
    Country("–õ–∏—Ç–≤–∞", "LT", "üá±üáπ", "+370"),
    Country("–õ–∞—Ç–≤–∏—è", "LV", "üá±üáª", "+371"),
    Country("–≠—Å—Ç–æ–Ω–∏—è", "EE", "üá™üá™", "+372")
)

// Telegram —Ü–≤–µ—Ç–∞
object TelegramColors {
    val Primary = Color(0xFF5288C1)
    val PrimaryLight = Color(0xFF64B5F6)
    val PrimaryDark = Color(0xFF3D6A8A)
    val Background = Color(0xFFF5F5F5)
    val Surface = Color.White
    val TextPrimary = Color(0xFF222222)
    val TextSecondary = Color(0xFF8E8E93)
    val Divider = Color(0xFFE5E5EA)
    val Link = Color(0xFF007AFF)
    val Error = Color(0xFFFF3B30)
    val Success = Color(0xFF34C759)
    val GradientStart = Color(0xFF6CB3E8)
    val GradientEnd = Color(0xFF3E99D6)
}

@Composable
fun TelegramAuthApp() {
    var currentScreen by remember { mutableStateOf<AuthScreen>(AuthScreen.PhoneInput) }
    var userData by remember { mutableStateOf(UserData()) }

    AnimatedContent(
        targetState = currentScreen,
        transitionSpec = {
            if (targetState is AuthScreen.PhoneInput) {
                slideInHorizontally { -it } + fadeIn() togetherWith
                        slideOutHorizontally { it } + fadeOut()
            } else {
                slideInHorizontally { it } + fadeIn() togetherWith
                        slideOutHorizontally { -it } + fadeOut()
            }
        },
        label = "screen_transition"
    ) { screen ->
        when (screen) {
            is AuthScreen.PhoneInput -> {
                LoginScreen(
                    onContinue = { phoneNumber, countryCode ->
                        currentScreen = AuthScreen.CodeVerification(phoneNumber, countryCode)
                    }
                )
            }
            is AuthScreen.CodeVerification -> {
                CodeVerificationScreen(
                    phoneNumber = screen.phoneNumber,
                    countryCode = screen.countryCode,
                    onBack = { currentScreen = AuthScreen.PhoneInput },
                    onCodeVerified = { isNewUser ->
                        currentScreen = if (isNewUser) {
                            AuthScreen.Registration(screen.phoneNumber)
                        } else {
                            AuthScreen.Success
                        }
                    }
                )
            }
            is AuthScreen.Registration -> {
                RegistrationScreen(
                    phoneNumber = screen.phoneNumber,
                    userData = userData,
                    onUserDataChanged = { userData = it },
                    onBack = { currentScreen = AuthScreen.PhoneInput },
                    onComplete = { currentScreen = AuthScreen.Success }
                )
            }
            is AuthScreen.Success -> {
                SuccessScreen(
                    userData = userData,
                    onLogout = {
                        userData = UserData()
                        currentScreen = AuthScreen.PhoneInput
                    }
                )
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun LoginScreen(
    onContinue: (String, String) -> Unit
) {
    var selectedCountry by remember { mutableStateOf(countries[0]) }
    var phoneNumber by remember { mutableStateOf("") }
    var showCountryPicker by remember { mutableStateOf(false) }
    var syncContacts by remember { mutableStateOf(true) }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(TelegramColors.Background)
            .padding(horizontal = 32.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Spacer(modifier = Modifier.height(80.dp))

        // –õ–æ–≥–æ—Ç–∏–ø Telegram
        TelegramLogo()

        Spacer(modifier = Modifier.height(24.dp))

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        Text(
            text = "–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω",
            style = MaterialTheme.typography.headlineLarge,
            color = TelegramColors.TextPrimary,
            fontWeight = FontWeight.Bold
        )

        Spacer(modifier = Modifier.height(12.dp))

        // –û–ø–∏—Å–∞–Ω–∏–µ
        Text(
            text = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã\n–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.",
            style = MaterialTheme.typography.bodyMedium,
            color = TelegramColors.TextSecondary,
            textAlign = TextAlign.Center,
            lineHeight = 20.sp
        )

        Spacer(modifier = Modifier.height(40.dp))

        // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –ø–æ–ª—è–º–∏ –≤–≤–æ–¥–∞
        Card(
            modifier = Modifier.fillMaxWidth(),
            shape = RoundedCornerShape(12.dp),
            colors = CardDefaults.cardColors(containerColor = TelegramColors.Surface),
            elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
        ) {
            Column {
                // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable { showCountryPicker = true }
                        .padding(horizontal = 16.dp, vertical = 14.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(text = selectedCountry.flag, fontSize = 24.sp)
                    Spacer(modifier = Modifier.width(12.dp))
                    Text(
                        text = selectedCountry.name,
                        style = MaterialTheme.typography.bodyLarge,
                        color = TelegramColors.TextPrimary,
                        modifier = Modifier.weight(1f)
                    )
                    Icon(
                        imageVector = Icons.Default.KeyboardArrowDown,
                        contentDescription = "–í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É",
                        tint = TelegramColors.TextSecondary
                    )
                }

                HorizontalDivider(
                    modifier = Modifier.padding(start = 52.dp),
                    color = TelegramColors.Divider,
                    thickness = 0.5.dp
                )

                // –í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 16.dp, vertical = 14.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Box(
                        modifier = Modifier
                            .width(60.dp)
                            .clickable { showCountryPicker = true }
                    ) {
                        Text(
                            text = selectedCountry.phoneCode,
                            style = MaterialTheme.typography.bodyLarge,
                            color = TelegramColors.Primary,
                            fontWeight = FontWeight.Medium
                        )
                    }

                    Spacer(modifier = Modifier.width(8.dp))

                    BasicTextField(
                        value = phoneNumber,
                        onValueChange = { newValue ->
                            val filtered = newValue.filter { it.isDigit() }
                            if (filtered.length <= 15) {
                                phoneNumber = filtered
                            }
                        },
                        modifier = Modifier
                            .weight(1f)
                            .height(24.dp),
                        textStyle = MaterialTheme.typography.bodyLarge.copy(
                            color = TelegramColors.TextPrimary
                        ),
                        keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Phone),
                        singleLine = true,
                        cursorBrush = SolidColor(TelegramColors.Primary),
                        decorationBox = { innerTextField ->
                            Box(
                                modifier = Modifier.fillMaxWidth(),
                                contentAlignment = Alignment.CenterStart
                            ) {
                                if (phoneNumber.isEmpty()) {
                                    Text(
                                        text = "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
                                        style = MaterialTheme.typography.bodyLarge,
                                        color = TelegramColors.TextSecondary
                                    )
                                }
                                innerTextField()
                            }
                        }
                    )
                }
            }
        }

        Spacer(modifier = Modifier.height(24.dp))

        // –ß–µ–∫–±–æ–∫—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .clickable(
                    indication = null,
                    interactionSource = remember { MutableInteractionSource() }
                ) { syncContacts = !syncContacts },
            verticalAlignment = Alignment.CenterVertically
        ) {
            Checkbox(
                checked = syncContacts,
                onCheckedChange = { syncContacts = it },
                colors = CheckboxDefaults.colors(
                    checkedColor = TelegramColors.Primary,
                    uncheckedColor = TelegramColors.TextSecondary
                )
            )
            Spacer(modifier = Modifier.width(8.dp))
            Text(
                text = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã",
                style = MaterialTheme.typography.bodyMedium,
                color = TelegramColors.TextPrimary
            )
        }

        Spacer(modifier = Modifier.weight(1f))

        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        Button(
            onClick = { onContinue(phoneNumber, selectedCountry.phoneCode) },
            modifier = Modifier
                .fillMaxWidth()
                .height(50.dp),
            shape = RoundedCornerShape(10.dp),
            colors = ButtonDefaults.buttonColors(containerColor = TelegramColors.Primary),
            enabled = phoneNumber.length >= 6
        ) {
            Text(
                text = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                style = MaterialTheme.typography.titleMedium,
                color = Color.White
            )
        }

        Spacer(modifier = Modifier.height(16.dp))

        Text(
            text = "–í–æ–π—Ç–∏ –ø–æ QR-–∫–æ–¥—É",
            style = MaterialTheme.typography.bodyMedium,
            color = TelegramColors.Link,
            modifier = Modifier
                .clickable { /* TODO */ }
                .padding(vertical = 8.dp)
        )

        Spacer(modifier = Modifier.height(32.dp))
    }

    if (showCountryPicker) {
        CountryPickerDialog(
            countries = countries,
            selectedCountry = selectedCountry,
            onCountrySelected = { country ->
                selectedCountry = country
                showCountryPicker = false
            },
            onDismiss = { showCountryPicker = false }
        )
    }
}

@Composable
fun CodeVerificationScreen(
    phoneNumber: String,
    countryCode: String,
    onBack: () -> Unit,
    onCodeVerified: (Boolean) -> Unit
) {
    var code by remember { mutableStateOf(List(5) { "" }) }
    var isError by remember { mutableStateOf(false) }
    var isLoading by remember { mutableStateOf(false) }
    var countdown by remember { mutableIntStateOf(60) }
    val focusRequesters = remember { List(5) { FocusRequester() } }
    val focusManager = LocalFocusManager.current

    // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞
    LaunchedEffect(countdown) {
        if (countdown > 0) {
            delay(1000)
            countdown--
        }
    }

    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
    LaunchedEffect(Unit) {
        focusRequesters[0].requestFocus()
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(TelegramColors.Background)
    ) {
        // –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 8.dp, vertical = 8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            IconButton(onClick = onBack) {
                Icon(
                    imageVector = Icons.AutoMirrored.Filled.ArrowBack,
                    contentDescription = "–ù–∞–∑–∞–¥",
                    tint = TelegramColors.Primary
                )
            }
        }

        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(horizontal = 32.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Spacer(modifier = Modifier.height(40.dp))

            // –ò–∫–æ–Ω–∫–∞ —Å –∫–æ–¥–æ–º
            Box(
                modifier = Modifier
                    .size(100.dp)
                    .clip(CircleShape)
                    .background(
                        brush = Brush.linearGradient(
                            colors = listOf(TelegramColors.GradientStart, TelegramColors.GradientEnd)
                        )
                    ),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = "üí¨",
                    fontSize = 48.sp
                )
            }

            Spacer(modifier = Modifier.height(24.dp))

            Text(
                text = "$countryCode $phoneNumber",
                style = MaterialTheme.typography.headlineMedium,
                color = TelegramColors.TextPrimary,
                fontWeight = FontWeight.Bold
            )

            Spacer(modifier = Modifier.height(12.dp))

            Text(
                text = "–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\n–Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä",
                style = MaterialTheme.typography.bodyMedium,
                color = TelegramColors.TextSecondary,
                textAlign = TextAlign.Center
            )

            Spacer(modifier = Modifier.height(40.dp))

            // –ü–æ–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
            Row(
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Spacer(modifier = Modifier.weight(1f))
                code.forEachIndexed { index, digit ->
                    CodeDigitField(
                        value = digit,
                        onValueChange = { newValue ->
                            if (newValue.length <= 1 && newValue.all { it.isDigit() }) {
                                isError = false
                                val newCode = code.toMutableList()
                                newCode[index] = newValue
                                code = newCode

                                if (newValue.isNotEmpty() && index < 4) {
                                    focusRequesters[index + 1].requestFocus()
                                }

                                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤—Å–µ—Ö –ø–æ–ª–µ–π
                                if (newCode.all { it.isNotEmpty() }) {
                                    isLoading = true
                                    // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ - –∫–æ–¥ "12345" –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                    val enteredCode = newCode.joinToString("")
                                    if (enteredCode == "12345") {
                                        onCodeVerified(true) // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                                    } else if (enteredCode == "11111") {
                                        onCodeVerified(false) // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                                    } else {
                                        isLoading = false
                                        isError = true
                                    }
                                }
                            }
                        },
                        isError = isError,
                        focusRequester = focusRequesters[index],
                        onBackspace = {
                            if (digit.isEmpty() && index > 0) {
                                focusRequesters[index - 1].requestFocus()
                                val newCode = code.toMutableList()
                                newCode[index - 1] = ""
                                code = newCode
                            }
                        }
                    )
                }
                Spacer(modifier = Modifier.weight(1f))
            }

            if (isError) {
                Spacer(modifier = Modifier.height(16.dp))
                Text(
                    text = "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",
                    style = MaterialTheme.typography.bodySmall,
                    color = TelegramColors.Error
                )
            }

            Spacer(modifier = Modifier.height(32.dp))

            // –¢–∞–π–º–µ—Ä –∏ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
            if (countdown > 0) {
                Text(
                    text = "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–µ—Ä–µ–∑ $countdown —Å–µ–∫",
                    style = MaterialTheme.typography.bodyMedium,
                    color = TelegramColors.TextSecondary
                )
            } else {
                Text(
                    text = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ",
                    style = MaterialTheme.typography.bodyMedium,
                    color = TelegramColors.Link,
                    modifier = Modifier.clickable {
                        countdown = 60
                        code = List(5) { "" }
                        isError = false
                        focusRequesters[0].requestFocus()
                    }
                )
            }

            Spacer(modifier = Modifier.height(16.dp))

            Text(
                text = "–ü–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–∞ –Ω–æ–º–µ—Ä",
                style = MaterialTheme.typography.bodyMedium,
                color = TelegramColors.Link,
                modifier = Modifier.clickable { /* TODO */ }
            )

            if (isLoading) {
                Spacer(modifier = Modifier.height(32.dp))
                CircularProgressIndicator(
                    color = TelegramColors.Primary,
                    modifier = Modifier.size(32.dp)
                )
            }

            Spacer(modifier = Modifier.height(24.dp))

            // –ü–æ–¥—Å–∫–∞–∑–∫–∞
            Card(
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(12.dp),
                colors = CardDefaults.cardColors(
                    containerColor = TelegramColors.Primary.copy(alpha = 0.1f)
                )
            ) {
                Row(
                    modifier = Modifier.padding(16.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        imageVector = Icons.Default.Info,
                        contentDescription = null,
                        tint = TelegramColors.Primary,
                        modifier = Modifier.size(20.dp)
                    )
                    Spacer(modifier = Modifier.width(12.dp))
                    Text(
                        text = "–î–ª—è —Ç–µ—Å—Ç–∞: 12345 ‚Äî –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\n11111 ‚Äî —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π",
                        style = MaterialTheme.typography.bodySmall,
                        color = TelegramColors.Primary
                    )
                }
            }
        }
    }
}

@Composable
fun CodeDigitField(
    value: String,
    onValueChange: (String) -> Unit,
    isError: Boolean,
    focusRequester: FocusRequester,
    onBackspace: () -> Unit
) {
    BasicTextField(
        value = value,
        onValueChange = onValueChange,
        modifier = Modifier
            .size(50.dp)
            .clip(RoundedCornerShape(12.dp))
            .background(TelegramColors.Surface)
            .border(
                width = 2.dp,
                color = when {
                    isError -> TelegramColors.Error
                    value.isNotEmpty() -> TelegramColors.Primary
                    else -> TelegramColors.Divider
                },
                shape = RoundedCornerShape(12.dp)
            )
            .focusRequester(focusRequester),
        textStyle = MaterialTheme.typography.headlineLarge.copy(
            color = TelegramColors.TextPrimary,
            textAlign = TextAlign.Center
        ),
        keyboardOptions = KeyboardOptions(
            keyboardType = KeyboardType.Number,
            imeAction = ImeAction.Next
        ),
        singleLine = true,
        cursorBrush = SolidColor(TelegramColors.Primary),
        decorationBox = { innerTextField ->
            Box(
                contentAlignment = Alignment.Center,
                modifier = Modifier.fillMaxSize()
            ) {
                innerTextField()
            }
        }
    )
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun RegistrationScreen(
    phoneNumber: String,
    userData: UserData,
    onUserDataChanged: (UserData) -> Unit,
    onBack: () -> Unit,
    onComplete: () -> Unit
) {
    var currentStep by remember { mutableIntStateOf(0) }
    var showDatePicker by remember { mutableStateOf(false) }

    val totalSteps = 3

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(TelegramColors.Background)
    ) {
        // –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 8.dp, vertical = 8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            IconButton(onClick = {
                if (currentStep > 0) {
                    currentStep--
                } else {
                    onBack()
                }
            }) {
                Icon(
                    imageVector = Icons.AutoMirrored.Filled.ArrowBack,
                    contentDescription = "–ù–∞–∑–∞–¥",
                    tint = TelegramColors.Primary
                )
            }
            Spacer(modifier = Modifier.weight(1f))
            Text(
                text = "–®–∞–≥ ${currentStep + 1} –∏–∑ $totalSteps",
                style = MaterialTheme.typography.bodyMedium,
                color = TelegramColors.TextSecondary
            )
            Spacer(modifier = Modifier.width(48.dp))
        }

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        LinearProgressIndicator(
            progress = { (currentStep + 1).toFloat() / totalSteps },
            modifier = Modifier
                .fillMaxWidth()
                .height(3.dp),
            color = TelegramColors.Primary,
            trackColor = TelegramColors.Divider,
        )

        AnimatedContent(
            targetState = currentStep,
            transitionSpec = {
                if (targetState > initialState) {
                    slideInHorizontally { it } + fadeIn() togetherWith
                            slideOutHorizontally { -it } + fadeOut()
                } else {
                    slideInHorizontally { -it } + fadeIn() togetherWith
                            slideOutHorizontally { it } + fadeOut()
                }
            },
            label = "step_transition"
        ) { step ->
            when (step) {
                0 -> NameInputStep(
                    userData = userData,
                    onUserDataChanged = onUserDataChanged,
                    onNext = { currentStep++ }
                )
                1 -> BirthdayInputStep(
                    userData = userData,
                    onUserDataChanged = onUserDataChanged,
                    onNext = { currentStep++ }
                )
                2 -> ProfilePhotoStep(
                    userData = userData,
                    onComplete = onComplete
                )
            }
        }
    }
}

@Composable
fun NameInputStep(
    userData: UserData,
    onUserDataChanged: (UserData) -> Unit,
    onNext: () -> Unit
) {
    var firstName by remember { mutableStateOf(userData.firstName) }
    var lastName by remember { mutableStateOf(userData.lastName) }
    val focusManager = LocalFocusManager.current

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(horizontal = 32.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Spacer(modifier = Modifier.height(40.dp))

        // –ò–∫–æ–Ω–∫–∞
        Box(
            modifier = Modifier
                .size(100.dp)
                .clip(CircleShape)
                .background(
                    brush = Brush.linearGradient(
                        colors = listOf(TelegramColors.GradientStart, TelegramColors.GradientEnd)
                    )
                ),
            contentAlignment = Alignment.Center
        ) {
            Text(text = "üë§", fontSize = 48.sp)
        }

        Spacer(modifier = Modifier.height(24.dp))

        Text(
            text = "–í–∞—à–µ –∏–º—è",
            style = MaterialTheme.typography.headlineLarge,
            color = TelegramColors.TextPrimary,
            fontWeight = FontWeight.Bold
        )

        Spacer(modifier = Modifier.height(12.dp))

        Text(
            text = "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é",
            style = MaterialTheme.typography.bodyMedium,
            color = TelegramColors.TextSecondary,
            textAlign = TextAlign.Center
        )

        Spacer(modifier = Modifier.height(40.dp))

        // –ü–æ–ª–µ –∏–º–µ–Ω–∏
        OutlinedTextField(
            value = firstName,
            onValueChange = { firstName = it },
            modifier = Modifier.fillMaxWidth(),
            label = { Text("–ò–º—è") },
            placeholder = { Text("–í–≤–µ–¥–∏—Ç–µ –∏–º—è") },
            leadingIcon = {
                Icon(
                    imageVector = Icons.Default.Person,
                    contentDescription = null,
                    tint = TelegramColors.Primary
                )
            },
            shape = RoundedCornerShape(12.dp),
            colors = OutlinedTextFieldDefaults.colors(
                focusedBorderColor = TelegramColors.Primary,
                unfocusedBorderColor = TelegramColors.Divider,
                focusedContainerColor = TelegramColors.Surface,
                unfocusedContainerColor = TelegramColors.Surface
            ),
            keyboardOptions = KeyboardOptions(imeAction = ImeAction.Next),
            keyboardActions = KeyboardActions(
                onNext = { focusManager.moveFocus(FocusDirection.Down) }
            ),
            singleLine = true
        )

        Spacer(modifier = Modifier.height(16.dp))

        // –ü–æ–ª–µ —Ñ–∞–º–∏–ª–∏–∏
        OutlinedTextField(
            value = lastName,
            onValueChange = { lastName = it },
            modifier = Modifier.fillMaxWidth(),
            label = { Text("–§–∞–º–∏–ª–∏—è") },
            placeholder = { Text("–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") },
            leadingIcon = {
                Icon(
                    imageVector = Icons.Default.Person,
                    contentDescription = null,
                    tint = TelegramColors.Primary
                )
            },
            shape = RoundedCornerShape(12.dp),
            colors = OutlinedTextFieldDefaults.colors(
                focusedBorderColor = TelegramColors.Primary,
                unfocusedBorderColor = TelegramColors.Divider,
                focusedContainerColor = TelegramColors.Surface,
                unfocusedContainerColor = TelegramColors.Surface
            ),
            keyboardOptions = KeyboardOptions(imeAction = ImeAction.Done),
            keyboardActions = KeyboardActions(
                onDone = { focusManager.clearFocus() }
            ),
            singleLine = true
        )

        Spacer(modifier = Modifier.weight(1f))

        Button(
            onClick = {
                onUserDataChanged(userData.copy(firstName = firstName, lastName = lastName))
                onNext()
            },
            modifier = Modifier
                .fillMaxWidth()
                .height(50.dp),
            shape = RoundedCornerShape(10.dp),
            colors = ButtonDefaults.buttonColors(containerColor = TelegramColors.Primary),
            enabled = firstName.isNotBlank()
        ) {
            Text(
                text = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                style = MaterialTheme.typography.titleMedium,
                color = Color.White
            )
        }

        Spacer(modifier = Modifier.height(32.dp))
    }
}

@Composable
fun BirthdayInputStep(
    userData: UserData,
    onUserDataChanged: (UserData) -> Unit,
    onNext: () -> Unit
) {
    var day by remember { mutableStateOf(userData.birthDay) }
    var month by remember { mutableStateOf(userData.birthMonth) }
    var year by remember { mutableStateOf(userData.birthYear) }
    var skipBirthday by remember { mutableStateOf(false) }
    val focusManager = LocalFocusManager.current

    val months = listOf(
        "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å",
        "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"
    )

    var showMonthPicker by remember { mutableStateOf(false) }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(horizontal = 32.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Spacer(modifier = Modifier.height(40.dp))

        // –ò–∫–æ–Ω–∫–∞
        Box(
            modifier = Modifier
                .size(100.dp)
                .clip(CircleShape)
                .background(
                    brush = Brush.linearGradient(
                        colors = listOf(TelegramColors.GradientStart, TelegramColors.GradientEnd)
                    )
                ),
            contentAlignment = Alignment.Center
        ) {
            Text(text = "üéÇ", fontSize = 48.sp)
        }

        Spacer(modifier = Modifier.height(24.dp))

        Text(
            text = "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è",
            style = MaterialTheme.typography.headlineLarge,
            color = TelegramColors.TextPrimary,
            fontWeight = FontWeight.Bold
        )

        Spacer(modifier = Modifier.height(12.dp))

        Text(
            text = "–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤–∞—à–µ–≥–æ —Ä–æ–∂–¥–µ–Ω–∏—è.\n–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–∑—å—è–º –Ω–∞–π—Ç–∏ –≤–∞—Å.",
            style = MaterialTheme.typography.bodyMedium,
            color = TelegramColors.TextSecondary,
            textAlign = TextAlign.Center
        )

        Spacer(modifier = Modifier.height(40.dp))

        // –ü–æ–ª—è –¥–∞—Ç—ã
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            // –î–µ–Ω—å
            OutlinedTextField(
                value = day,
                onValueChange = {
                    if (it.length <= 2 && it.all { char -> char.isDigit() }) {
                        day = it
                        if (it.length == 2) focusManager.moveFocus(FocusDirection.Right)
                    }
                },
                modifier = Modifier.weight(1f),
                label = { Text("–î–µ–Ω—å") },
                placeholder = { Text("–î–î") },
                shape = RoundedCornerShape(12.dp),
                colors = OutlinedTextFieldDefaults.colors(
                    focusedBorderColor = TelegramColors.Primary,
                    unfocusedBorderColor = TelegramColors.Divider,
                    focusedContainerColor = TelegramColors.Surface,
                    unfocusedContainerColor = TelegramColors.Surface
                ),
                keyboardOptions = KeyboardOptions(
                    keyboardType = KeyboardType.Number,
                    imeAction = ImeAction.Next
                ),
                singleLine = true,
                textStyle = MaterialTheme.typography.bodyLarge.copy(textAlign = TextAlign.Center)
            )

            // –ú–µ—Å—è—Ü
            Box(modifier = Modifier.weight(2f)) {
                OutlinedTextField(
                    value = if (month.isNotEmpty()) months[month.toInt() - 1] else "",
                    onValueChange = { },
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable { showMonthPicker = true },
                    label = { Text("–ú–µ—Å—è—Ü") },
                    placeholder = { Text("–í—ã–±–µ—Ä–∏—Ç–µ") },
                    readOnly = true,
                    enabled = false,
                    shape = RoundedCornerShape(12.dp),
                    colors = OutlinedTextFieldDefaults.colors(
                        disabledBorderColor = TelegramColors.Divider,
                        disabledContainerColor = TelegramColors.Surface,
                        disabledTextColor = TelegramColors.TextPrimary,
                        disabledLabelColor = TelegramColors.TextSecondary
                    ),
                    trailingIcon = {
                        Icon(
                            imageVector = Icons.Default.KeyboardArrowDown,
                            contentDescription = null,
                            tint = TelegramColors.TextSecondary
                        )
                    },
                    singleLine = true
                )
                // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π —Å–ª–æ–π
                Box(
                    modifier = Modifier
                        .matchParentSize()
                        .clickable { showMonthPicker = true }
                )
            }

            // –ì–æ–¥
            OutlinedTextField(
                value = year,
                onValueChange = {
                    if (it.length <= 4 && it.all { char -> char.isDigit() }) {
                        year = it
                    }
                },
                modifier = Modifier.weight(1.5f),
                label = { Text("–ì–æ–¥") },
                placeholder = { Text("–ì–ì–ì–ì") },
                shape = RoundedCornerShape(12.dp),
                colors = OutlinedTextFieldDefaults.colors(
                    focusedBorderColor = TelegramColors.Primary,
                    unfocusedBorderColor = TelegramColors.Divider,
                    focusedContainerColor = TelegramColors.Surface,
                    unfocusedContainerColor = TelegramColors.Surface
                ),
                keyboardOptions = KeyboardOptions(
                    keyboardType = KeyboardType.Number,
                    imeAction = ImeAction.Done
                ),
                keyboardActions = KeyboardActions(
                    onDone = { focusManager.clearFocus() }
                ),
                singleLine = true,
                textStyle = MaterialTheme.typography.bodyLarge.copy(textAlign = TextAlign.Center)
            )
        }

        Spacer(modifier = Modifier.height(24.dp))

        // –ß–µ–∫–±–æ–∫—Å –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .clickable(
                    indication = null,
                    interactionSource = remember { MutableInteractionSource() }
                ) { skipBirthday = !skipBirthday },
            verticalAlignment = Alignment.CenterVertically
        ) {
            Checkbox(
                checked = skipBirthday,
                onCheckedChange = { skipBirthday = it },
                colors = CheckboxDefaults.colors(
                    checkedColor = TelegramColors.Primary,
                    uncheckedColor = TelegramColors.TextSecondary
                )
            )
            Spacer(modifier = Modifier.width(8.dp))
            Text(
                text = "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —à–∞–≥",
                style = MaterialTheme.typography.bodyMedium,
                color = TelegramColors.TextPrimary
            )
        }

        Spacer(modifier = Modifier.weight(1f))

        Button(
            onClick = {
                onUserDataChanged(userData.copy(
                    birthDay = day,
                    birthMonth = month,
                    birthYear = year
                ))
                onNext()
            },
            modifier = Modifier
                .fillMaxWidth()
                .height(50.dp),
            shape = RoundedCornerShape(10.dp),
            colors = ButtonDefaults.buttonColors(containerColor = TelegramColors.Primary),
            enabled = skipBirthday || (day.isNotBlank() && month.isNotBlank() && year.length == 4)
        ) {
            Text(
                text = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                style = MaterialTheme.typography.titleMedium,
                color = Color.White
            )
        }

        Spacer(modifier = Modifier.height(32.dp))
    }

    // –î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –º–µ—Å—è—Ü–∞
    if (showMonthPicker) {
        MonthPickerDialog(
            months = months,
            selectedMonth = if (month.isNotEmpty()) month.toInt() - 1 else -1,
            onMonthSelected = { index ->
                month = (index + 1).toString()
                showMonthPicker = false
            },
            onDismiss = { showMonthPicker = false }
        )
    }
}

@Composable
fun MonthPickerDialog(
    months: List<String>,
    selectedMonth: Int,
    onMonthSelected: (Int) -> Unit,
    onDismiss: () -> Unit
) {
    Dialog(onDismissRequest = onDismiss) {
        Card(
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(containerColor = TelegramColors.Surface)
        ) {
            Column(modifier = Modifier.padding(vertical = 8.dp)) {
                Text(
                    text = "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü",
                    style = MaterialTheme.typography.titleMedium,
                    color = TelegramColors.TextPrimary,
                    fontWeight = FontWeight.Bold,
                    modifier = Modifier.padding(16.dp)
                )

                months.forEachIndexed { index, monthName ->
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable { onMonthSelected(index) }
                            .padding(horizontal = 16.dp, vertical = 12.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            text = monthName,
                            style = MaterialTheme.typography.bodyLarge,
                            color = if (index == selectedMonth) TelegramColors.Primary else TelegramColors.TextPrimary,
                            fontWeight = if (index == selectedMonth) FontWeight.SemiBold else FontWeight.Normal,
                            modifier = Modifier.weight(1f)
                        )
                        if (index == selectedMonth) {
                            Icon(
                                imageVector = Icons.Default.Check,
                                contentDescription = null,
                                tint = TelegramColors.Primary
                            )
                        }
                    }
                }
            }
        }
    }
}

@Composable
fun ProfilePhotoStep(
    userData: UserData,
    onComplete: () -> Unit
) {
    var bio by remember { mutableStateOf(userData.bio) }
    var username by remember { mutableStateOf(userData.username) }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(horizontal = 32.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Spacer(modifier = Modifier.height(40.dp))

        // –ê–≤–∞—Ç–∞—Ä —Å –∫–Ω–æ–ø–∫–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
        Box(
            contentAlignment = Alignment.Center
        ) {
            Box(
                modifier = Modifier
                    .size(120.dp)
                    .clip(CircleShape)
                    .background(
                        brush = Brush.linearGradient(
                            colors = listOf(TelegramColors.GradientStart, TelegramColors.GradientEnd)
                        )
                    )
                    .clickable { /* TODO: –û—Ç–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é */ },
                contentAlignment = Alignment.Center
            ) {
                if (userData.firstName.isNotEmpty()) {
                    Text(
                        text = userData.firstName.first().uppercase() +
                                (userData.lastName.firstOrNull()?.uppercase() ?: ""),
                        fontSize = 40.sp,
                        color = Color.White,
                        fontWeight = FontWeight.Bold
                    )
                } else {
                    Icon(
                        imageVector = Icons.Default.Person,
                        contentDescription = null,
                        tint = Color.White,
                        modifier = Modifier.size(60.dp)
                    )
                }
            }

            // –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã
            Box(
                modifier = Modifier
                    .align(Alignment.BottomEnd)
                    .offset(x = 4.dp, y = 4.dp)
                    .size(36.dp)
                    .clip(CircleShape)
                    .background(TelegramColors.Primary)
                    .clickable { /* TODO: –û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É */ },
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    imageVector = Icons.Default.Add,
                    contentDescription = "–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ",
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
            }
        }

        Spacer(modifier = Modifier.height(24.dp))

        Text(
            text = "–ü—Ä–æ—Ñ–∏–ª—å",
            style = MaterialTheme.typography.headlineLarge,
            color = TelegramColors.TextPrimary,
            fontWeight = FontWeight.Bold
        )

        Spacer(modifier = Modifier.height(12.dp))

        Text(
            text = "–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ",
            style = MaterialTheme.typography.bodyMedium,
            color = TelegramColors.TextSecondary,
            textAlign = TextAlign.Center
        )

        Spacer(modifier = Modifier.height(32.dp))

        // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        OutlinedTextField(
            value = username,
            onValueChange = {
                // –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ
                val filtered = it.filter { char ->
                    char.isLetterOrDigit() || char == '_'
                }.lowercase()
                if (filtered.length <= 32) {
                    username = filtered
                }
            },
            modifier = Modifier.fillMaxWidth(),
            label = { Text("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è") },
            placeholder = { Text("username") },
            prefix = { Text("@", color = TelegramColors.Primary) },
            leadingIcon = {
                Icon(
                    imageVector = Icons.Default.AccountCircle,
                    contentDescription = null,
                    tint = TelegramColors.Primary
                )
            },
            shape = RoundedCornerShape(12.dp),
            colors = OutlinedTextFieldDefaults.colors(
                focusedBorderColor = TelegramColors.Primary,
                unfocusedBorderColor = TelegramColors.Divider,
                focusedContainerColor = TelegramColors.Surface,
                unfocusedContainerColor = TelegramColors.Surface
            ),
            supportingText = {
                Text(
                    text = "–ú–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å a-z, 0-9 –∏ _",
                    style = MaterialTheme.typography.bodySmall,
                    color = TelegramColors.TextSecondary
                )
            },
            singleLine = true
        )

        Spacer(modifier = Modifier.height(16.dp))

        // –ë–∏–æ
        OutlinedTextField(
            value = bio,
            onValueChange = { if (it.length <= 70) bio = it },
            modifier = Modifier.fillMaxWidth(),
            label = { Text("–û —Å–µ–±–µ") },
            placeholder = { Text("–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...") },
            leadingIcon = {
                Icon(
                    imageVector = Icons.Default.Edit,
                    contentDescription = null,
                    tint = TelegramColors.Primary
                )
            },
            shape = RoundedCornerShape(12.dp),
            colors = OutlinedTextFieldDefaults.colors(
                focusedBorderColor = TelegramColors.Primary,
                unfocusedBorderColor = TelegramColors.Divider,
                focusedContainerColor = TelegramColors.Surface,
                unfocusedContainerColor = TelegramColors.Surface
            ),
            supportingText = {
                Text(
                    text = "${bio.length}/70",
                    style = MaterialTheme.typography.bodySmall,
                    color = TelegramColors.TextSecondary,
                    modifier = Modifier.fillMaxWidth(),
                    textAlign = TextAlign.End
                )
            },
            maxLines = 3
        )

        Spacer(modifier = Modifier.weight(1f))

        Button(
            onClick = onComplete,
            modifier = Modifier
                .fillMaxWidth()
                .height(50.dp),
            shape = RoundedCornerShape(10.dp),
            colors = ButtonDefaults.buttonColors(containerColor = TelegramColors.Primary)
        ) {
            Text(
                text = "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é",
                style = MaterialTheme.typography.titleMedium,
                color = Color.White
            )
        }

        Spacer(modifier = Modifier.height(16.dp))

        TextButton(onClick = onComplete) {
            Text(
                text = "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å",
                style = MaterialTheme.typography.bodyMedium,
                color = TelegramColors.Link
            )
        }

        Spacer(modifier = Modifier.height(32.dp))
    }
}

@Composable
fun SuccessScreen(
    userData: UserData,
    onLogout: () -> Unit
) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(TelegramColors.Background)
            .padding(horizontal = 32.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–∞–ª–æ—á–∫–∞
        Box(
            modifier = Modifier
                .size(120.dp)
                .clip(CircleShape)
                .background(TelegramColors.Success),
            contentAlignment = Alignment.Center
        ) {
            Icon(
                imageVector = Icons.Default.Check,
                contentDescription = "–£—Å–ø–µ—Ö",
                tint = Color.White,
                modifier = Modifier.size(60.dp)
            )
        }

        Spacer(modifier = Modifier.height(32.dp))

        Text(
            text = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
            style = MaterialTheme.typography.headlineLarge,
            color = TelegramColors.TextPrimary,
            fontWeight = FontWeight.Bold
        )

        Spacer(modifier = Modifier.height(16.dp))

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        Card(
            modifier = Modifier.fillMaxWidth(),
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(containerColor = TelegramColors.Surface)
        ) {
            Column(
                modifier = Modifier.padding(20.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                // –ê–≤–∞—Ç–∞—Ä
                Box(
                    modifier = Modifier
                        .size(80.dp)
                        .clip(CircleShape)
                        .background(
                            brush = Brush.linearGradient(
                                colors = listOf(TelegramColors.GradientStart, TelegramColors.GradientEnd)
                            )
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Text(
                        text = userData.firstName.firstOrNull()?.uppercase() ?: "?",
                        fontSize = 32.sp,
                        color = Color.White,
                        fontWeight = FontWeight.Bold
                    )
                }

                Spacer(modifier = Modifier.height(16.dp))

                Text(
                    text = "${userData.firstName} ${userData.lastName}".trim(),
                    style = MaterialTheme.typography.headlineMedium,
                    color = TelegramColors.TextPrimary,
                    fontWeight = FontWeight.Bold
                )

                if (userData.username.isNotEmpty()) {
                    Text(
                        text = "@${userData.username}",
                        style = MaterialTheme.typography.bodyLarge,
                        color = TelegramColors.Link
                    )
                }

                if (userData.birthDay.isNotEmpty() && userData.birthMonth.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(8.dp))
                    val months = listOf(
                        "—è–Ω–≤–∞—Ä—è", "—Ñ–µ–≤—Ä–∞–ª—è", "–º–∞—Ä—Ç–∞", "–∞–ø—Ä–µ–ª—è", "–º–∞—è", "–∏—é–Ω—è",
                        "–∏—é–ª—è", "–∞–≤–≥—É—Å—Ç–∞", "—Å–µ–Ω—Ç—è–±—Ä—è", "–æ–∫—Ç—è–±—Ä—è", "–Ω–æ—è–±—Ä—è", "–¥–µ–∫–∞–±—Ä—è"
                    )
                    val monthName = months.getOrElse(userData.birthMonth.toInt() - 1) { "" }
                    Text(
                        text = "üéÇ ${userData.birthDay} $monthName ${userData.birthYear}",
                        style = MaterialTheme.typography.bodyMedium,
                        color = TelegramColors.TextSecondary
                    )
                }

                if (userData.bio.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(12.dp))
                    Text(
                        text = userData.bio,
                        style = MaterialTheme.typography.bodyMedium,
                        color = TelegramColors.TextPrimary,
                        textAlign = TextAlign.Center
                    )
                }
            }
        }

        Spacer(modifier = Modifier.height(32.dp))

        Text(
            text = "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ.",
            style = MaterialTheme.typography.bodyMedium,
            color = TelegramColors.TextSecondary,
            textAlign = TextAlign.Center
        )

        Spacer(modifier = Modifier.height(48.dp))

        Button(
            onClick = { /* TODO: –ü–µ—Ä–µ–π—Ç–∏ –∫ —á–∞—Ç–∞–º */ },
            modifier = Modifier
                .fillMaxWidth()
                .height(50.dp),
            shape = RoundedCornerShape(10.dp),
            colors = ButtonDefaults.buttonColors(containerColor = TelegramColors.Primary)
        ) {
            Text(
                text = "–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ",
                style = MaterialTheme.typography.titleMedium,
                color = Color.White
            )
        }

        Spacer(modifier = Modifier.height(16.dp))

        TextButton(onClick = onLogout) {
            Text(
                text = "–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞",
                style = MaterialTheme.typography.bodyMedium,
                color = TelegramColors.Error
            )
        }
    }
}

@Composable
fun TelegramLogo() {
    Box(
        modifier = Modifier
            .size(100.dp)
            .clip(CircleShape)
            .background(
                brush = Brush.linearGradient(
                    colors = listOf(TelegramColors.GradientStart, TelegramColors.GradientEnd)
                )
            ),
        contentAlignment = Alignment.Center
    ) {
        Text(
            text = "‚úà",
            fontSize = 48.sp,
            color = Color.White
        )
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CountryPickerDialog(
    countries: List<Country>,
    selectedCountry: Country,
    onCountrySelected: (Country) -> Unit,
    onDismiss: () -> Unit
) {
    var searchQuery by remember { mutableStateOf("") }

    val filteredCountries = remember(searchQuery) {
        if (searchQuery.isEmpty()) {
            countries
        } else {
            countries.filter { country ->
                country.name.contains(searchQuery, ignoreCase = true) ||
                        country.phoneCode.contains(searchQuery)
            }
        }
    }

    Dialog(
        onDismissRequest = onDismiss,
        properties = DialogProperties(usePlatformDefaultWidth = false)
    ) {
        Surface(
            modifier = Modifier
                .fillMaxSize()
                .padding(top = 48.dp),
            shape = RoundedCornerShape(topStart = 16.dp, topEnd = 16.dp),
            color = TelegramColors.Background
        ) {
            Column {
                Surface(
                    color = TelegramColors.Surface,
                    shadowElevation = 2.dp
                ) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween,
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Text(
                                text = "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É",
                                style = MaterialTheme.typography.headlineMedium,
                                color = TelegramColors.TextPrimary,
                                fontWeight = FontWeight.Bold
                            )
                            TextButton(onClick = onDismiss) {
                                Text(text = "–û—Ç–º–µ–Ω–∞", color = TelegramColors.Link)
                            }
                        }

                        Spacer(modifier = Modifier.height(12.dp))

                        OutlinedTextField(
                            value = searchQuery,
                            onValueChange = { searchQuery = it },
                            modifier = Modifier.fillMaxWidth(),
                            placeholder = {
                                Text(text = "–ü–æ–∏—Å–∫", color = TelegramColors.TextSecondary)
                            },
                            leadingIcon = {
                                Icon(
                                    imageVector = Icons.Default.Search,
                                    contentDescription = "–ü–æ–∏—Å–∫",
                                    tint = TelegramColors.TextSecondary
                                )
                            },
                            shape = RoundedCornerShape(10.dp),
                            colors = OutlinedTextFieldDefaults.colors(
                                focusedBorderColor = TelegramColors.Primary,
                                unfocusedBorderColor = TelegramColors.Divider,
                                focusedContainerColor = TelegramColors.Surface,
                                unfocusedContainerColor = TelegramColors.Surface
                            ),
                            singleLine = true
                        )
                    }
                }

                LazyColumn(modifier = Modifier.fillMaxSize()) {
                    items(filteredCountries) { country ->
                        CountryItem(
                            country = country,
                            isSelected = country == selectedCountry,
                            onClick = { onCountrySelected(country) }
                        )
                    }
                }
            }
        }
    }
}

@Composable
fun CountryItem(
    country: Country,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    Surface(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick),
        color = if (isSelected) {
            TelegramColors.Primary.copy(alpha = 0.1f)
        } else {
            TelegramColors.Surface
        }
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 14.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(text = country.flag, fontSize = 28.sp)

            Spacer(modifier = Modifier.width(16.dp))

            Column(modifier = Modifier.weight(1f)) {
                Text(
                    text = country.name,
                    style = MaterialTheme.typography.bodyLarge,
                    color = TelegramColors.TextPrimary,
                    fontWeight = if (isSelected) FontWeight.SemiBold else FontWeight.Normal
                )
            }

            Text(
                text = country.phoneCode,
                style = MaterialTheme.typography.bodyMedium,
                color = TelegramColors.TextSecondary
            )

            if (isSelected) {
                Spacer(modifier = Modifier.width(12.dp))
                Icon(
                    imageVector = Icons.Default.Check,
                    contentDescription = "–í—ã–±—Ä–∞–Ω–æ",
                    tint = TelegramColors.Primary,
                    modifier = Modifier.size(20.dp)
                )
            }
        }
    }

    HorizontalDivider(
        modifier = Modifier.padding(start = 60.dp),
        color = TelegramColors.Divider,
        thickness = 0.5.dp
    )
}

package com.example.myapplication.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

val Typography = Typography(
    // –ë–æ–ª—å—à–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è "–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω", "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" –∏ —Ç.–¥.
    headlineLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Bold,
        fontSize = 26.sp,
        lineHeight = 34.sp,
        letterSpacing = 0.sp
    ),

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    headlineMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 22.sp,
        lineHeight = 30.sp,
        letterSpacing = 0.sp
    ),

    // –ú–∞–ª–µ–Ω—å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å–µ–∫—Ü–∏–π
    headlineSmall = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 18.sp,
        lineHeight = 26.sp,
        letterSpacing = 0.sp
    ),

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ —Å–ø–∏—Å–∫–æ–≤
    titleLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 20.sp,
        lineHeight = 28.sp,
        letterSpacing = 0.sp
    ),

    // –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫ –∏ –≤–∞–∂–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    titleMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.SemiBold,
        fontSize = 16.sp,
        lineHeight = 24.sp,
        letterSpacing = 0.15.sp
    ),

    // –ú–µ–ª–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    titleSmall = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 14.sp,
        lineHeight = 20.sp,
        letterSpacing = 0.1.sp
    ),

    // –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç - –ø–æ–ª—è –≤–≤–æ–¥–∞, —Å–ø–∏—Å–∫–∏
    bodyLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 16.sp,
        lineHeight = 24.sp,
        letterSpacing = 0.5.sp
    ),

    // –í—Ç–æ—Ä–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç - –æ–ø–∏—Å–∞–Ω–∏—è, –ø–æ–¥—Å–∫–∞–∑–∫–∏
    bodyMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 14.sp,
        lineHeight = 20.sp,
        letterSpacing = 0.25.sp
    ),

    // –ú–µ–ª–∫–∏–π —Ç–µ–∫—Å—Ç - –ø—Ä–∏–º–µ—á–∞–Ω–∏—è, —Å—á—ë—Ç—á–∏–∫–∏
    bodySmall = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 12.sp,
        lineHeight = 16.sp,
        letterSpacing = 0.4.sp
    ),

    // –ú–µ—Ç–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    labelLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 14.sp,
        lineHeight = 20.sp,
        letterSpacing = 0.1.sp
    ),

    // –ü–æ–¥–ø–∏—Å–∏ –∫ –ø–æ–ª—è–º
    labelMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 12.sp,
        lineHeight = 16.sp,
        letterSpacing = 0.5.sp
    ),

    // –ú–µ–ª–∫–∏–µ –ø–æ–¥–ø–∏—Å–∏
    labelSmall = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 10.sp,
        lineHeight = 14.sp,
        letterSpacing = 0.5.sp
    ),

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –∫—Ä—É–ø–Ω—ã–π —Ç–µ–∫—Å—Ç (–¥–ª—è —á–∏—Å–µ–ª –∫–æ–¥–∞)
    displayLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Bold,
        fontSize = 57.sp,
        lineHeight = 64.sp,
        letterSpacing = (-0.25).sp
    ),

    // –°—Ä–µ–¥–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
    displayMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Bold,
        fontSize = 45.sp,
        lineHeight = 52.sp,
        letterSpacing = 0.sp
    ),

    // –ú–∞–ª—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
    displaySmall = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Bold,
        fontSize = 36.sp,
        lineHeight = 44.sp,
        letterSpacing = 0.sp
    )
)



package com.example.myapplication.ui.theme

import android.app.Activity
import android.os.Build
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.dynamicDarkColorScheme
import androidx.compose.material3.dynamicLightColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.ui.platform.LocalContext

private val DarkColorScheme = darkColorScheme(
    primary = Purple80,
    secondary = PurpleGrey80,
    tertiary = Pink80
)

private val LightColorScheme = lightColorScheme(
    primary = Purple40,
    secondary = PurpleGrey40,
    tertiary = Pink40

    /* Other default colors to override
    background = Color(0xFFFFFBFE),
    surface = Color(0xFFFFFBFE),
    onPrimary = Color.White,
    onSecondary = Color.White,
    onTertiary = Color.White,
    onBackground = Color(0xFF1C1B1F),
    onSurface = Color(0xFF1C1B1F),
    */
)

@Composable
fun MyApplicationTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    // Dynamic color is available on Android 12+
    dynamicColor: Boolean = true,
    content: @Composable () -> Unit
) {
    val colorScheme = when {
        dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            val context = LocalContext.current
            if (darkTheme) dynamicDarkColorScheme(context) else dynamicLightColorScheme(context)
        }

        darkTheme -> DarkColorScheme
        else -> LightColorScheme
    }

    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        content = content
    )
}
