#include <windows.h>
#include <gdiplus.h>
#include <vector>
#include <string>
#include <chrono>
#include <sstream>

#pragma comment(lib, "gdiplus.lib")

using namespace Gdiplus;

constexpr int WIN_W = 360;
constexpr int WIN_H = 640;

struct AppIcon {
    std::wstring title;
    RectF rect;
};

ULONG_PTR gdiToken;
std::vector<AppIcon> apps;

std::wstring GetTime() {
    auto now = std::chrono::system_clock::now();
    time_t t = std::chrono::system_clock::to_time_t(now);
    tm tm{};
    localtime_s(&tm, &t);
    wchar_t buf[6];
    swprintf_s(buf, L"%02d:%02d", tm.tm_hour, tm.tm_min);
    return buf;
}

void InitApps() {
    float x = 40, y = 120;
    float size = 64, gap = 40;

    std::vector<std::wstring> names = {
        L"Phone", L"Browser", L"Music", L"Settings"
    };

    for (int i = 0; i < names.size(); i++) {
        apps.push_back({
            names[i],
            RectF(x + (i % 2) * (size + gap),
                  y + (i / 2) * (size + 60),
                  size, size)
        });
    }
}

LRESULT CALLBACK WndProc(HWND hWnd, UINT msg, WPARAM w, LPARAM l) {
    switch (msg) {

    case WM_PAINT: {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hWnd, &ps);
        Graphics g(hdc);

        g.SetSmoothingMode(SmoothingModeHighQuality);

        // Ð¤Ð¾Ð½
        SolidBrush bg(Color(255, 20, 20, 30));
        g.FillRectangle(&bg, 0, 0, WIN_W, WIN_H);

        // Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð°Ñ€
        SolidBrush bar(Color(255, 30, 30, 50));
        g.FillRectangle(&bar, 0, 0, WIN_W, 40);

        FontFamily ff(L"Segoe UI");
        Font font(&ff, 14);
        SolidBrush text(Color::White);

        // Ð’Ñ€ÐµÐ¼Ñ
        std::wstring time = GetTime();
        g.DrawString(time.c_str(), -1, &font, PointF(10, 10), &text);

        // Ð‘Ð°Ñ‚Ð°Ñ€ÐµÑ
        g.DrawString(L"ðŸ”‹ 85%", -1, &font, PointF(WIN_W - 80, 10), &text);

        // Ð˜ÐºÐ¾Ð½ÐºÐ¸
        Font iconFont(&ff, 12);
        for (auto& app : apps) {
            SolidBrush icon(Color(255, 80, 160, 255));
            g.FillRoundedRectangle(&icon, app.rect, 16);

            RectF txt;
            g.MeasureString(app.title.c_str(), -1, &iconFont, PointF(0, 0), &txt);
            g.DrawString(
                app.title.c_str(), -1, &iconFont,
                PointF(app.rect.X + (app.rect.Width - txt.Width) / 2,
                       app.rect.Y + app.rect.Height + 8),
                &text
            );
        }

        EndPaint(hWnd, &ps);
        return 0;
    }

    case WM_LBUTTONDOWN: {
        POINT p{ GET_X_LPARAM(l), GET_Y_LPARAM(l) };
        for (auto& app : apps) {
            if (app.rect.Contains((REAL)p.x, (REAL)p.y)) {
                MessageBox(hWnd,
                    (L"Launching " + app.title).c_str(),
                    L"App",
                    MB_OK);
            }
        }
        return 0;
    }

    case WM_DESTROY:
        PostQuitMessage(0);
        return 0;
    }
    return DefWindowProc(hWnd, msg, w, l);
}

int WINAPI WinMain(HINSTANCE hInst, HINSTANCE, LPSTR, int) {
    GdiplusStartupInput gdiSI;
    GdiplusStartup(&gdiToken, &gdiSI, nullptr);

    InitApps();

    WNDCLASS wc{};
    wc.lpfnWndProc = WndProc;
    wc.hInstance = hInst;
    wc.lpszClassName = L"MobileOS";
    wc.hCursor = LoadCursor(nullptr, IDC_ARROW);
    RegisterClass(&wc);

    HWND hWnd = CreateWindowEx(
        WS_EX_TOOLWINDOW,
        wc.lpszClassName,
        L"Orega Mobile OS",
        WS_POPUP | WS_VISIBLE,
        200, 100, WIN_W, WIN_H,
        nullptr, nullptr, hInst, nullptr
    );

    MSG msg;
    while (GetMessage(&msg, nullptr, 0, 0)) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    GdiplusShutdown(gdiToken);
    return 0;
}
