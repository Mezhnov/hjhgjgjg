using System;
using Avalonia;
using Avalonia.Controls;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;
using Avalonia.Media;
using Avalonia.Input;
using LibVLCSharp.Shared;
using LibVLCSharp.Avalonia;

class Program
{
    [STAThread]
    public static void Main(string[] args)
    {
        Core.Initialize();
        BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);
    }

    static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .LogToTrace();
}

class App : Application
{
    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
            desktop.MainWindow = new MainWindow();

        base.OnFrameworkInitializationCompleted();
    }
}

class MainWindow : Window
{
    private LibVLC _vlc;
    private MediaPlayer _player;

    public MainWindow()
    {
        var xaml = """
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vlc="clr-namespace:LibVLCSharp.Avalonia;assembly=LibVLCSharp.Avalonia"
        Background="#0D0D0D"
        Width="1280"
        Height="720"
        Title="TV Video Player">

    <DockPanel>

        <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ (Ð½Ð¸Ð· ÑÐºÑ€Ð°Ð½Ð°) -->
        <Border DockPanel.Dock="Bottom"
                Background="#000"
                Padding="24">
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Spacing="20">

                <Button Name="OpenBtn"
                        Content="ðŸ“‚ ÐžÐ¢ÐšÐ Ð«Ð¢Ð¬"
                        FontSize="28"
                        Padding="32,18"/>

                <Button Name="PlayBtn"
                        Content="â–¶ PLAY"
                        FontSize="28"
                        Padding="32,18"/>

                <Button Name="PauseBtn"
                        Content="â¸ PAUSE"
                        FontSize="28"
                        Padding="32,18"/>

                <Button Name="StopBtn"
                        Content="â¹ STOP"
                        FontSize="28"
                        Padding="32,18"/>
            </StackPanel>
        </Border>

        <!-- Ð’Ð¸Ð´ÐµÐ¾ -->
        <vlc:VideoView Name="Video"
                       HorizontalAlignment="Stretch"
                       VerticalAlignment="Stretch"/>
    </DockPanel>
</Window>
""";

        AvaloniaXamlLoader.Load(this, xaml);

        _vlc = new LibVLC();
        _player = new MediaPlayer(_vlc);

        var video = this.FindControl<VideoView>("Video");
        video.MediaPlayer = _player;

        this.FindControl<Button>("OpenBtn").Click += OpenVideo;
        this.FindControl<Button>("PlayBtn").Click += (_, _) => _player.Play();
        this.FindControl<Button>("PauseBtn").Click += (_, _) => _player.Pause();
        this.FindControl<Button>("StopBtn").Click += (_, _) => _player.Stop();

        // Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ Ð¿ÑƒÐ»ÑŒÑ‚Ð° / ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñ‹
        KeyDown += (_, e) =>
        {
            switch (e.Key)
            {
                case Key.Space:
                case Key.Enter:
                    _player.Pause();
                    break;
                case Key.P:
                    _player.Play();
                    break;
                case Key.S:
                    _player.Stop();
                    break;
            }
        };
    }

    private async void OpenVideo(object? sender, EventArgs e)
    {
        var dialog = new OpenFileDialog
        {
            Title = "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð²Ð¸Ð´ÐµÐ¾",
            Filters =
            {
                new FileDialogFilter
                {
                    Name = "Ð’Ð¸Ð´ÐµÐ¾",
                    Extensions = { "mp4", "mkv", "avi" }
                }
            }
        };

        var files = await dialog.ShowAsync(this);
        if (files?.Length > 0)
            _player.Play(new Media(_vlc, files[0]));
    }

    protected override void OnClosed(EventArgs e)
    {
        _player.Dispose();
        _vlc.Dispose();
        base.OnClosed(e);
    }
}
