using Avalonia;
using Avalonia.Controls;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Interactivity;
using Avalonia.Markup.Xaml;
using Avalonia.Styling;
using System.Collections.Generic;
using System.IO;
using System.Text;

namespace SingleFileAvaloniaApp;

public class App : Application
{
    public override void Initialize()
    {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º XAML –∏–∑ —Å—Ç—Ä–æ–∫–∏
        using var stream = new MemoryStream(Encoding.UTF8.GetBytes(Xaml));
        AvaloniaXamlLoader.Load(this, stream);
    }

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
            desktop.MainWindow = new MainWindow();

        base.OnFrameworkInitializationCompleted();
    }

    // XAML –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    private const string Xaml = @"
<Application xmlns=""https://github.com/avaloniaui"">
    <Application.Styles>
        <FluentTheme Mode=""Light""/>
    </Application.Styles>
</Application>";
}

public class MainWindow : Window
{
    private TextBlock _statusText;

    public MainWindow()
    {
        Title = "–ú–∞–≥–∞–∑–∏–Ω –∏–≥—Ä";
        Width = 500;
        Height = 400;

        var games = new List<Game>
        {
            new Game("Space Adventure", 499),
            new Game("Dungeon RPG", 799),
            new Game("Indie Puzzle", 299),
        };

        _statusText = new TextBlock
        {
            HorizontalAlignment = Avalonia.Layout.HorizontalAlignment.Center
        };

        // –°–ø–∏—Å–æ–∫ –∏–≥—Ä
        var listBox = new ListBox
        {
            ItemsSource = games, // –í Avalonia 11+ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ItemsSource
            ItemTemplate = new FuncDataTemplate<Game>((game, _) =>
            {
                var buyButton = new Button { Content = "–ö—É–ø–∏—Ç—å" };
                buyButton.Click += (_, _) => BuyGame(game); // += –¥–ª—è —Å–æ–±—ã—Ç–∏—è

                return new StackPanel
                {
                    Orientation = Avalonia.Layout.Orientation.Horizontal,
                    Spacing = 10,
                    Children =
                    {
                        new TextBlock { Text = game.Name, Width = 200 },
                        new TextBlock { Text = game.Price + " ‚ÇΩ", Width = 80 },
                        buyButton
                    }
                };
            })
        };

        Content = new StackPanel
        {
            Margin = new Thickness(20),
            Spacing = 10,
            Children =
            {
                new TextBlock
                {
                    Text = "üéÆ –ú–∞–≥–∞–∑–∏–Ω –∏–≥—Ä",
                    FontSize = 22,
                    HorizontalAlignment = Avalonia.Layout.HorizontalAlignment.Center
                },
                listBox,
                _statusText
            }
        };
    }

    private void BuyGame(Game game)
    {
        _statusText.Text = "–í—ã –∫—É–ø–∏–ª–∏: " + game.Name + " üéâ";
    }
}

// –ö–ª–∞—Å—Å –º–æ–¥–µ–ª–∏ –∏–≥—Ä—ã
public class Game
{
    public string Name { get; }
    public int Price { get; }

    public Game(string name, int price)
    {
        Name = name;
        Price = price;
    }
}

// –°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
class Program
{
    public static void Main(string[] args)
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .StartWithClassicDesktopLifetime(args);
}
