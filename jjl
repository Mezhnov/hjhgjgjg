using Avalonia;
using Avalonia.Controls;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Interactivity;
using Avalonia.Markup.Xaml;
using Avalonia.Markup.Xaml.Styling;
using Avalonia.Styling;
using System.Collections.Generic;
using System.IO;
using System.Text;

namespace SingleFileAvaloniaApp;

public class App : Application
{
    public override void Initialize()
    {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º XAML –ø—Ä—è–º–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏
        using var stream = new MemoryStream(Encoding.UTF8.GetBytes(Xaml));
        AvaloniaXamlLoader.Load(this, stream);
    }

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
            desktop.MainWindow = new MainWindow();

        base.OnFrameworkInitializationCompleted();
    }

    // –í–ï–°–¨ XAML –í–ù–£–¢–†–ò –§–ê–ô–õ–ê
    private const string Xaml = """
<Application xmlns="https://github.com/avaloniaui">
    <Application.Styles>
        <FluentTheme />
    </Application.Styles>
</Application>
""";
}

public class MainWindow : Window
{
    private TextBlock _statusText!;

    public MainWindow()
    {
        Title = "–ú–∞–≥–∞–∑–∏–Ω –∏–≥—Ä";
        Width = 500;
        Height = 400;

        var games = new List<Game>
        {
            new("Space Adventure", 499),
            new("Dungeon RPG", 799),
            new("Indie Puzzle", 299),
        };

        _statusText = new TextBlock
        {
            HorizontalAlignment = Avalonia.Layout.HorizontalAlignment.Center
        };

        Content = new StackPanel
        {
            Margin = new Thickness(20),
            Spacing = 10,
            Children =
            {
                new TextBlock
                {
                    Text = "üéÆ –ú–∞–≥–∞–∑–∏–Ω –∏–≥—Ä",
                    FontSize = 22,
                    HorizontalAlignment = Avalonia.Layout.HorizontalAlignment.Center
                },

                new ListBox
                {
                    Items = games,
                    ItemTemplate = new FuncDataTemplate<Game>((game, _) =>
                        new StackPanel
                        {
                            Orientation = Avalonia.Layout.Orientation.Horizontal,
                            Spacing = 10,
                            Children =
                            {
                                new TextBlock { Text = game.Name, Width = 200 },
                                new TextBlock { Text = $"{game.Price} ‚ÇΩ", Width = 80 },
                                new Button
                                {
                                    Content = "–ö—É–ø–∏—Ç—å",
                                    Command = new Avalonia.Controls.Primitives.RelayCommand(
                                        _ => BuyGame(game))
                                }
                            }
                        })
                },

                _statusText
            }
        };
    }

    private void BuyGame(Game game)
    {
        _statusText.Text = $"–í—ã –∫—É–ø–∏–ª–∏: {game.Name} üéâ";
    }
}

public record Game(string Name, int Price);

class Program
{
    public static void Main(string[] args)
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .StartWithClassicDesktopLifetime(args);
}
