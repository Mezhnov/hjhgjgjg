using System;
using Avalonia;
using Avalonia.Controls;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;
using Avalonia.Layout;
using LibVLCSharp.Shared;
using LibVLCSharp.Avalonia;

class Program
{
    [STAThread]
    public static void Main(string[] args)
    {
        Core.Initialize();
        BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);
    }

    static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .LogToTrace();
}

class App : Application
{
    public override void Initialize()
    {
        // XAML –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–º–∏–Ω–∏–º—É–º)
        AvaloniaXamlLoader.Load(this);
    }

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow();
        }
        base.OnFrameworkInitializationCompleted();
    }
}

class MainWindow : Window
{
    private LibVLC _libVLC;
    private MediaPlayer _player;
    private VideoView _video;

    public MainWindow()
    {
        // üîπ XAML –ø—Ä—è–º–æ –∑–¥–µ—Å—å
        var xaml = """
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vlc="clr-namespace:LibVLCSharp.Avalonia;assembly=LibVLCSharp.Avalonia"
        Width="800" Height="450"
        Title="Avalonia Video Player">

    <DockPanel>
        <StackPanel DockPanel.Dock="Top"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Margin="5">
            <Button Name="OpenBtn" Content="–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ"/>
        </StackPanel>

        <vlc:VideoView Name="Video"/>
    </DockPanel>
</Window>
""";

        AvaloniaXamlLoader.Load(this, xaml);

        _libVLC = new LibVLC();
        _player = new MediaPlayer(_libVLC);

        _video = this.FindControl<VideoView>("Video");
        _video.MediaPlayer = _player;

        var openBtn = this.FindControl<Button>("OpenBtn");
        openBtn.Click += OpenVideo;
    }

    private async void OpenVideo(object? sender, EventArgs e)
    {
        var dialog = new OpenFileDialog
        {
            Filters =
            {
                new FileDialogFilter
                {
                    Name = "Video",
                    Extensions = { "mp4", "mkv", "avi" }
                }
            }
        };

        var files = await dialog.ShowAsync(this);
        if (files?.Length > 0)
        {
            _player.Play(new Media(_libVLC, files[0]));
        }
    }

    protected override void OnClosed(EventArgs e)
    {
        _player.Dispose();
        _libVLC.Dispose();
        base.OnClosed(e);
    }
}
