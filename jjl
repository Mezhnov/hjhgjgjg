#include <windows.h>
#include <gdiplus.h>
#include <urlmon.h>
#include <shellapi.h>
#include <dwmapi.h>
#include <wchar.h>

#pragma comment(lib, "gdiplus.lib")
#pragma comment(lib, "urlmon.lib")
#pragma comment(lib, "dwmapi.lib")

using namespace Gdiplus;

// ================= CONFIG =================
const int W = 1200;
const int H = 700;

const wchar_t* BG_URL   = L"https://avatars.mds.yandex.net/i?id=36cbb9eb6253b776b00360ca303f84d7_l-12608381-images-thumbs&n=13";
const wchar_t* BG_FILE  = L"background.jpg";
const wchar_t* LOGO_URL = L"https://i.imgur.com/placeholder.png"; // замените
const wchar_t* LOGO_FILE = L"logo.png";

const wchar_t* GTA_PATH = L"C:\\Games\\GTA5\\GTA5.exe";

// ================= ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =================
ULONG_PTR gdiToken;
Image* background = nullptr;
Image* logo = nullptr;
bool isFullscreen = false;
RECT normalRect;
float progress = 0.0f;
bool showNews    = false;
bool showSettings = false;
int currentNewsIndex = 0;

// ================= НОВОСТИ =================
struct NewsItem {
    const wchar_t* title;
    const wchar_t* description;
    const wchar_t* imageUrl;
    const wchar_t* imageFile;
};

NewsItem newsItems[] = {
    { L"Обновление 1.5: Новые машины!", L"Добавлены новые автомобили и миссии.", L"https://example.com/news1.jpg", L"news1.jpg" },
    { L"Конкурс на лучший билд", L"Участвуйте и выигрывайте призы!", L"https://example.com/news2.jpg", L"news2.jpg" },
    { L"Бан волна читеров", L"Очищаем сервер от нарушителей.", L"https://example.com/news3.jpg", L"news3.jpg" },
};
const int numNews = sizeof(newsItems) / sizeof(NewsItem);
Image* newsImages[3] = {};

// ================= ПРИМЕР НАСТРОЕК (можно расширять) =================
bool settingFullscreen = false;
bool settingAutoUpdate = true;
bool settingSoundEffects = true;
int  settingVolume = 75;           // 0–100

// ================= UI СТРУКТУРЫ =================
struct Button {
    RECT rect;
    const wchar_t* text;
    bool hover;
    Color normalColor;
    Color hoverColor;
    int fontSize;
    const wchar_t* tooltip;
};

struct Panel {
    RECT rect;
    Color bgColor;
    int borderRadius;
};

// ================= КНОПКИ =================
Button btnPlay     = {{450,500,750,580}, L"ЗАПУСТИТЬ ИГРУ", false, Color(80, 255,140,0),  Color(255,255,165,0), 24, L"Запустить GTA V"};
Button btnNews     = {{50, 180,350,250}, L"НОВОСТИ",        false, Color(120,30,30,35),   Color(180,40,40,45),   18, L"Последние новости"};
Button btnSettings = {{50, 270,350,340}, L"НАСТРОЙКИ",      false, Color(120,30,30,35),   Color(180,40,40,45),   18, L"Настройки лаунчера"};
Button btnDiscord  = {{50, 360,350,430}, L"DISCORD",        false, Color(120,88,101,242), Color(200,88,101,242), 18, L"Discord сообщество"};
Button btnForum    = {{50, 450,350,520}, L"ФОРУМ",          false, Color(120,30,30,35),   Color(180,40,40,45),   18, L"Форум Majestic"};
Button btnDonate   = {{850,180,1150,250},L"ДОНАТ",          false, Color(120,255,215,0),  Color(200,255,215,0),  18, L"Поддержать проект"};
Button btnStats    = {{850,270,1150,340},L"СТАТИСТИКА",     false, Color(120,30,30,35),   Color(180,40,40,45),   18, L"Статистика"};
Button btnRules    = {{850,360,1150,430},L"ПРАВИЛА",        false, Color(120,200,0,0),    Color(180,220,20,20),  18, L"Правила сервера"};
Button btnEvents   = {{50, 540,350,610}, L"СОБЫТИЯ",        false, Color(120,0,200,200),  Color(180,20,220,220), 18, L"События"};

Button btnMinimize = {{W-140,10,W-100,40}, L"—", false, Color(0,0,0,0), Color(100,255,255,255), 20, L"Свернуть"};
Button btnMaximize = {{W-90, 10,W-50, 40}, L"□", false, Color(0,0,0,0), Color(100,255,255,255), 20, L"Развернуть"};
Button btnClose    = {{W-40, 10,W-10, 40}, L"✕", false, Color(0,0,0,0), Color(200,255,0,0),     20, L"Закрыть"};

Button btnNewsBack    = {{50,  50, 150,100}, L"НАЗАД", false, Color(120,30,30,35), Color(180,40,40,45), 18, L"Вернуться"};
Button btnNewsPrev    = {{400,600,500,650},  L"<",    false, Color(120,30,30,35), Color(180,40,40,45), 24, L"Предыдущая"};
Button btnNewsNext    = {{700,600,800,650},  L">",    false, Color(120,30,30,35), Color(180,40,40,45), 24, L"Следующая"};

Button btnSettingsBack = {{50,  50, 150,100}, L"НАЗАД", false, Color(120,30,30,35), Color(180,40,40,45), 18, L"Вернуться"};

// Чекбоксы и слайдер (имитация)
Button btnCheckFullscreen  = {{250,180,700,220}, L"Запускать игру в полноэкранном режиме", false, Color(0,0,0,0), Color(80,80,80,120), 16, L""};
Button btnCheckAutoUpdate  = {{250,240,700,280}, L"Автоматически проверять обновления",     false, Color(0,0,0,0), Color(80,80,80,120), 16, L""};
Button btnCheckSound       = {{250,300,700,340}, L"Включить звуковые эффекты лаунчера",     false, Color(0,0,0,0), Color(80,80,80,120), 16, L""};

// ================= ПАНЕЛИ =================
Panel mainPanel  = {{30,  150,370,640}, Color(140,15,15,20), 15};
Panel rightPanel = {{830, 150,1170,460},Color(140,15,15,20), 15};
Panel playPanel  = {{430, 480,770,600}, Color(0,0,0,0),      20};
Panel newsPanel  = {{200, 100,1000,550},Color(140,15,15,20), 20};
Panel settingsPanel = {{200,100,1000,550},Color(140,15,15,20), 20};

// ================= УТИЛИТЫ =================
bool InRect(const POINT& p, const RECT& r) {
    return p.x >= r.left && p.x <= r.right && p.y >= r.top && p.y <= r.bottom;
}

void DrawRoundedRect(Graphics& g, Brush* brush, const RectF& rect, float radius) {
    GraphicsPath path;
    path.AddArc(rect.X, rect.Y, radius*2, radius*2, 180, 90);
    path.AddArc(rect.X + rect.Width - radius*2, rect.Y, radius*2, radius*2, 270, 90);
    path.AddArc(rect.X + rect.Width - radius*2, rect.Y + rect.Height - radius*2, radius*2, radius*2, 0, 90);
    path.AddArc(rect.X, rect.Y + rect.Height - radius*2, radius*2, radius*2, 90, 90);
    path.CloseFigure();
    g.FillPath(brush, &path);
}

void DrawPanel(Graphics& g, const Panel& p) {
    SolidBrush brush(p.bgColor);
    RectF rect((REAL)p.rect.left, (REAL)p.rect.top, (REAL)(p.rect.right-p.rect.left), (REAL)(p.rect.bottom-p.rect.top));
    if (p.borderRadius > 0) DrawRoundedRect(g, &brush, rect, (float)p.borderRadius);
    else g.FillRectangle(&brush, rect);

    Pen shadow(Color(50,0,0,0), 2);
    GraphicsPath sp; sp.AddRectangle(rect);
    g.TranslateTransform(2,2);
    g.DrawPath(&shadow, &sp);
    g.ResetTransform();
}

void DrawButton(Graphics& g, const Button& b) {
    Color bg = b.hover ? b.hoverColor : b.normalColor;
    SolidBrush brush(bg);
    RectF r((REAL)b.rect.left, (REAL)b.rect.top, (REAL)(b.rect.right-b.rect.left), (REAL)(b.rect.bottom-b.rect.top));
    DrawRoundedRect(g, &brush, r, 10);

    if (b.hover) {
        Pen pen(Color(180,255,255,255), 2.5f);
        pen.SetDashStyle(DashStyleDot);
        GraphicsPath path; path.AddRectangle(r);
        g.DrawPath(&pen, &path);
    }

    FontFamily ff(L"Segoe UI");
    Font font(&ff, (REAL)b.fontSize, FontStyleBold);
    SolidBrush text(Color::White);
    StringFormat fmt;
    fmt.SetAlignment(StringAlignmentCenter);
    fmt.SetLineAlignment(StringAlignmentCenter);
    g.DrawString(b.text, -1, &font, r, &fmt, &text);
}

void DrawCheckbox(Graphics& g, const Button& b, bool checked) {
    RectF r((REAL)b.rect.left, (REAL)b.rect.top, (REAL)(b.rect.right-b.rect.left), (REAL)(b.rect.bottom-b.rect.top));

    // Фон
    SolidBrush bg(b.hover ? Color(60,60,60,180) : Color(40,40,40,140));
    g.FillRectangle(&bg, r);

    // Квадрат чекбокса
    RectF box(r.X + 10, r.Y + (r.Height-20)/2, 20, 20);
    SolidBrush border(Color::White);
    Pen pen(&border, 2);
    g.DrawRectangle(&pen, box);

    if (checked) {
        SolidBrush fill(Color(0, 180, 80));
        g.FillRectangle(&fill, box.X+3, box.Y+3, box.Width-6, box.Height-6);
    }

    // Текст
    FontFamily ff(L"Segoe UI");
    Font font(&ff, 16, FontStyleRegular);
    SolidBrush text(Color::White);
    RectF textRect(r.X + 40, r.Y, r.Width - 50, r.Height);
    StringFormat fmt;
    fmt.SetLineAlignment(StringAlignmentCenter);
    g.DrawString(b.text, -1, &font, textRect, &fmt, &text);
}

void DrawVolumeSlider(Graphics& g, int volume) {
    RectF track(250, 380, 500, 8);
    SolidBrush trackBg(Color(80,80,80));
    g.FillRectangle(&trackBg, track);

    float pos = (float)volume / 100.0f;
    RectF fill(250, 380, 500 * pos, 8);
    LinearGradientBrush grad(PointF(250,380), PointF(750,380), Color(40,180,255), Color(0,120,255));
    g.FillRectangle(&grad, fill);

    // Круглый ползунок
    REAL x = 250 + 500 * pos - 12;
    EllipseF circle(x, 380 - 12, 24, 24);
    SolidBrush circleBrush(Color::White);
    g.FillEllipse(&circleBrush, circle);
    Pen border(Color(200,200,200), 2);
    g.DrawEllipse(&border, circle);

    // Подпись
    wchar_t txt[32];
    swprintf(txt, 32, L"Громкость: %d%%", volume);
    FontFamily ff(L"Segoe UI");
    Font font(&ff, 14);
    SolidBrush text(Color::White);
    g.DrawString(txt, -1, &font, PointF(250, 410), &text);
}

// ... (остальные функции DrawHeader, DrawServerInfo, DrawInfoBoxes, DrawProgressBar, DrawNews остаются без изменений)

void DrawSettings(Graphics& g) {
    DrawPanel(g, settingsPanel);

    FontFamily ff(L"Segoe UI");
    Font titleFont(&ff, 28, FontStyleBold);
    SolidBrush white(Color::White);
    g.DrawString(L"НАСТРОЙКИ ЛАУНЧЕРА", -1, &titleFont, PointF(250, 120), &white);

    DrawCheckbox(g, btnCheckFullscreen,  settingFullscreen);
    DrawCheckbox(g, btnCheckAutoUpdate,  settingAutoUpdate);
    DrawCheckbox(g, btnCheckSound,       settingSoundEffects);

    DrawVolumeSlider(g, settingVolume);

    DrawButton(g, btnSettingsBack);
}

// ================= WINDOW PROC =================
LRESULT CALLBACK WndProc(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)
{
    static POINT mousePos;
    static const Button* hovered = nullptr;

    switch (msg)
    {
    case WM_CREATE:
    {
        DWM_WINDOW_CORNER_PREFERENCE pref = DWMWCP_ROUND;
        DwmSetWindowAttribute(hwnd, DWMWA_WINDOW_CORNER_PREFERENCE, &pref, sizeof(pref));

        URLDownloadToFileW(0, BG_URL,   BG_FILE,   0, 0);
        URLDownloadToFileW(0, LOGO_URL, LOGO_FILE, 0, 0);
        background = Image::FromFile(BG_FILE);
        logo = Image::FromFile(LOGO_FILE);

        for (int i = 0; i < numNews; i++) {
            URLDownloadToFileW(0, newsItems[i].imageUrl, newsItems[i].imageFile, 0, 0);
            newsImages[i] = Image::FromFile(newsItems[i].imageFile);
        }

        SetTimer(hwnd, 1, 50, 0);
        break;
    }

    case WM_TIMER:
        if (wParam == 1) {
            progress += 0.005f;
            if (progress > 1) progress = 0;
            InvalidateRect(hwnd, 0, FALSE);
        }
        break;

    case WM_PAINT:
    {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        HDC mem = CreateCompatibleDC(hdc);
        HBITMAP bmp = CreateCompatibleBitmap(hdc, W, H);
        SelectObject(mem, bmp);

        Graphics g(mem);
        g.SetSmoothingMode(SmoothingModeAntiAlias);
        g.SetTextRenderingHint(TextRenderingHintAntiAlias);

        if (background) g.DrawImage(background, 0,0,W,H);
        // DrawGradientOverlay(g);  // если нужен
        DrawHeader(g);
        DrawServerInfo(g);

        if (!showNews && !showSettings) {
            DrawPanel(g, mainPanel);
            DrawPanel(g, rightPanel);
            DrawButton(g, btnNews);
            DrawButton(g, btnSettings);
            DrawButton(g, btnDiscord);
            DrawButton(g, btnForum);
            DrawButton(g, btnDonate);
            DrawButton(g, btnStats);
            DrawButton(g, btnRules);
            DrawButton(g, btnEvents);
            DrawInfoBoxes(g);
            DrawButton(g, btnPlay);
            DrawProgressBar(g, progress);
        }
        else if (showNews) {
            DrawNews(g);
        }
        else if (showSettings) {
            DrawSettings(g);
        }

        DrawButton(g, btnMinimize);
        DrawButton(g, btnMaximize);
        DrawButton(g, btnClose);

        if (hovered) DrawTooltip(g, hovered->tooltip, mousePos);

        BitBlt(hdc,0,0,W,H,mem,0,0,SRCCOPY);
        DeleteObject(bmp);
        DeleteDC(mem);
        EndPaint(hwnd, &ps);
        break;
    }

    case WM_MOUSEMOVE:
    {
        POINT p; GetCursorPos(&p); ScreenToClient(hwnd, &p);
        mousePos = p;

        static Button* mainBtns[] = {
            &btnPlay, &btnNews, &btnSettings, &btnDiscord, &btnForum,
            &btnDonate, &btnStats, &btnRules, &btnEvents,
            &btnMinimize, &btnMaximize, &btnClose
        };

        static Button* newsBtns[] = {
            &btnNewsBack, &btnNewsPrev, &btnNewsNext,
            &btnMinimize, &btnMaximize, &btnClose
        };

        static Button* settingsBtns[] = {
            &btnSettingsBack, &btnCheckFullscreen, &btnCheckAutoUpdate,
            &btnCheckSound, &btnMinimize, &btnMaximize, &btnClose
        };

        Button** btns = nullptr;
        int cnt = 0;

        if (showSettings)      { btns = settingsBtns;   cnt = sizeof(settingsBtns)/sizeof(Button*); }
        else if (showNews)     { btns = newsBtns;       cnt = sizeof(newsBtns)/sizeof(Button*); }
        else                   { btns = mainBtns;       cnt = sizeof(mainBtns)/sizeof(Button*); }

        bool redraw = false;
        const Button* newHover = nullptr;

        for (int i = 0; i < cnt; i++) {
            Button* b = btns[i];
            bool was = b->hover;
            b->hover = InRect(p, b->rect);
            if (was != b->hover) redraw = true;
            if (b->hover) newHover = b;
        }

        if (hovered != newHover) {
            hovered = newHover;
            redraw = true;
        }

        if (redraw) InvalidateRect(hwnd, 0, FALSE);

        TRACKMOUSEEVENT tme = {sizeof(tme), TME_LEAVE, hwnd, 0};
        TrackMouseEvent(&tme);
        break;
    }

    case WM_MOUSELEAVE:
        hovered = nullptr;
        InvalidateRect(hwnd, 0, FALSE);
        break;

    case WM_LBUTTONDOWN:
    {
        POINT p; GetCursorPos(&p); ScreenToClient(hwnd, &p);

        // Системные кнопки всегда
        if (InRect(p, btnClose.rect))    { PostQuitMessage(0); return 0; }
        if (InRect(p, btnMinimize.rect)) { ShowWindow(hwnd, SW_MINIMIZE); return 0; }
        if (InRect(p, btnMaximize.rect)) {
            // ... (код полноэкранного режима без изменений)
            if (!isFullscreen) {
                GetWindowRect(hwnd, &normalRect);
                MONITORINFO mi{sizeof(mi)};
                GetMonitorInfo(MonitorFromWindow(hwnd, MONITOR_DEFAULTTONEAREST), &mi);
                SetWindowPos(hwnd, HWND_TOP, mi.rcMonitor.left, mi.rcMonitor.top,
                             mi.rcMonitor.right-mi.rcMonitor.left, mi.rcMonitor.bottom-mi.rcMonitor.top, SWP_FRAMECHANGED);
                isFullscreen = true;
            } else {
                SetWindowPos(hwnd, HWND_TOP, normalRect.left, normalRect.top,
                             normalRect.right-normalRect.left, normalRect.bottom-normalRect.top, SWP_FRAMECHANGED);
                isFullscreen = false;
            }
            return 0;
        }

        if (!showNews && !showSettings) {
            if (InRect(p, btnPlay.rect)) {
                ShellExecuteW(0, L"open", GTA_PATH, 0, 0, SW_SHOW);
            }
            else if (InRect(p, btnNews.rect)) {
                showNews = true;
                showSettings = false;
                InvalidateRect(hwnd, 0, FALSE);
            }
            else if (InRect(p, btnSettings.rect)) {
                showSettings = true;
                showNews = false;
                InvalidateRect(hwnd, 0, FALSE);
            }
            // ... остальные клики по кнопкам (discord, forum и т.д.)
            else if (InRect(p, btnDiscord.rect)) {
                ShellExecuteW(0, L"open", L"https://discord.gg/majestic", 0, 0, SW_SHOW);
            }
            // и т.д.
        }
        else if (showNews) {
            if (InRect(p, btnNewsBack.rect)) {
                showNews = false;
                InvalidateRect(hwnd, 0, FALSE);
            }
            else if (InRect(p, btnNewsPrev.rect)) {
                currentNewsIndex = (currentNewsIndex - 1 + numNews) % numNews;
                InvalidateRect(hwnd, 0, FALSE);
            }
            else if (InRect(p, btnNewsNext.rect)) {
                currentNewsIndex = (currentNewsIndex + 1) % numNews;
                InvalidateRect(hwnd, 0, FALSE);
            }
        }
        else if (showSettings) {
            if (InRect(p, btnSettingsBack.rect)) {
                showSettings = false;
                InvalidateRect(hwnd, 0, FALSE);
            }
            else if (InRect(p, btnCheckFullscreen.rect)) {
                settingFullscreen = !settingFullscreen;
                InvalidateRect(hwnd, 0, FALSE);
            }
            else if (InRect(p, btnCheckAutoUpdate.rect)) {
                settingAutoUpdate = !settingAutoUpdate;
                InvalidateRect(hwnd, 0, FALSE);
            }
            else if (InRect(p, btnCheckSound.rect)) {
                settingSoundEffects = !settingSoundEffects;
                InvalidateRect(hwnd, 0, FALSE);
            }
            // Здесь можно добавить обработку клика по слайдеру громкости (пока без реализации)
        }
        break;
    }

    case WM_DESTROY:
        delete background;
        delete logo;
        for (int i = 0; i < numNews; i++) delete newsImages[i];
        GdiplusShutdown(gdiToken);
        PostQuitMessage(0);
        break;

    default:
        return DefWindowProcW(hwnd, msg, wParam, lParam);
    }
    return 0;
}

// WinMain без изменений (как в предыдущей версии)
int WINAPI WinMain(HINSTANCE h, HINSTANCE, LPSTR, int nCmdShow)
{
    GdiplusStartupInput gdi;
    GdiplusStartup(&gdiToken, &gdi, nullptr);

    WNDCLASSW wc{};
    wc.lpfnWndProc = WndProc;
    wc.hInstance = h;
    wc.lpszClassName = L"MajesticLauncher";
    wc.hCursor = LoadCursor(0, IDC_ARROW);
    wc.hbrBackground = (HBRUSH)GetStockObject(BLACK_BRUSH);
    RegisterClassW(&wc);

    HWND hwnd = CreateWindowExW(WS_EX_LAYERED, wc.lpszClassName, L"Majestic RP",
        WS_POPUP, (GetSystemMetrics(SM_CXSCREEN)-W)/2, (GetSystemMetrics(SM_CYSCREEN)-H)/2,
        W, H, 0, 0, h, 0);

    SetLayeredWindowAttributes(hwnd, 0, 255, LWA_ALPHA);
    ShowWindow(hwnd, SW_SHOW);
    UpdateWindow(hwnd);

    MSG msg;
    while (GetMessage(&msg, 0, 0, 0)) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    return (int)msg.wParam;
}
