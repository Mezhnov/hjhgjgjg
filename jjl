#include <windows.h>
#include <gdiplus.h>
#include <urlmon.h>
#include <shellapi.h>
#include <vector>
#include <string>

#pragma comment(lib, "gdiplus.lib")
#pragma comment(lib, "urlmon.lib")

using namespace Gdiplus;

// ================= CONFIG =================
int WINDOW_WIDTH  = 1000;
int WINDOW_HEIGHT = 600;

const wchar_t* BG_URL  = L"https://avatars.mds.yandex.net/i?id=36cbb9eb6253b776b00360ca303f84d7_l-12608381-images-thumbs&n=13";
const wchar_t* BG_FILE = L"background.jpg";

ULONG_PTR gdiToken;
Image* background = nullptr;

// ================= UI =================
struct Button
{
    RECT rect;
    const wchar_t* text;
    bool hover;
    float glowAlpha;
};

// Основные кнопки лаунчера
Button btnPlay     = { {400, 400, 600, 460}, L"ИГРАТЬ", false, 0.0f };
Button btnSettings = { {30, 520, 180, 560},  L"НАСТРОЙКИ", false, 0.0f };
Button btnDiscord  = { {200, 520, 360, 560}, L"DISCORD", false, 0.0f };
Button btnNews     = { {650, 520, 830, 560}, L"НОВОСТИ", false, 0.0f };

std::vector<Button*> buttons = { &btnPlay, &btnSettings, &btnDiscord, &btnNews };

// Новости
struct NewsItem {
    std::wstring title;
    std::wstring text;
    std::wstring imageURL;
};
std::vector<NewsItem> newsItems = {
    { L"Зимний фестиваль!", L"Присоединяйтесь к зимнему событию в Majestic RP!", L"https://avatars.mds.yandex.net/i?id=36cbb9eb6253b776b00360ca303f84d7_l-12608381-images-thumbs&n=13" },
    { L"Исправлены баги", L"Исправлены баги транспорта и улучшена стабильность.", L"https://avatars.mds.yandex.net/i?id=36cbb9eb6253b776b00360ca303f84d7_l-12608381-images-thumbs&n=13" }
};
int currentNewsIndex = 0;

// Ссылка на соц сети
struct SocialIcon {
    RECT rect;
    const wchar_t* url;
};
SocialIcon iconDiscord = { {20, 500, 60, 540}, L"https://discord.gg/majestic" };
SocialIcon iconVK      = { {70, 500, 110, 540}, L"https://vk.com/majestic" };
SocialIcon iconTG      = { {120, 500, 160, 540}, L"https://t.me/majestic" };
std::vector<SocialIcon> socialIcons = { iconDiscord, iconVK, iconTG };

// ================= HELPERS =================
bool InRect(const POINT& p, const RECT& r)
{
    return p.x >= r.left && p.x <= r.right &&
           p.y >= r.top  && p.y <= r.bottom;
}

// ================= DRAW =================
void DrawButton(Graphics& g, Button& b)
{
    RectF r((REAL)b.rect.left, (REAL)b.rect.top,
            (REAL)(b.rect.right - b.rect.left),
            (REAL)(b.rect.bottom - b.rect.top));

    Color c1 = b.hover ? Color(255, 255, 180, 0) : Color(255, 180, 140, 0);
    Color c2 = b.hover ? Color(255, 255, 220, 50) : Color(255, 140, 80, 0);

    LinearGradientBrush grad(r, c1, c2, LinearGradientModeVertical);
    GraphicsPath path;
    float radius = 12.0f;

    path.AddArc(r.X, r.Y, radius, radius, 180, 90);
    path.AddArc(r.X + r.Width - radius, r.Y, radius, radius, 270, 90);
    path.AddArc(r.X + r.Width - radius, r.Y + r.Height - radius, radius, radius, 0, 90);
    path.AddArc(r.X, r.Y + r.Height - radius, radius, radius, 90, 90);
    path.CloseFigure();

    g.FillPath(&grad, &path);

    if (b.hover)
    {
        b.glowAlpha += 10.0f; if (b.glowAlpha > 255.0f) b.glowAlpha = 255.0f;
    }
    else
    {
        b.glowAlpha -= 10.0f; if (b.glowAlpha < 0.0f) b.glowAlpha = 0.0f;
    }

    if (b.glowAlpha > 0.0f)
    {
        Color glowColor((BYTE)b.glowAlpha, 255, 255, 255);
        Pen glow(glowColor, 3.0f);
        g.DrawPath(&glow, &path);
    }

    FontFamily ff(L"Segoe UI");
    Font font(&ff, 22.0f, FontStyleBold);
    SolidBrush text(Color::White);
    PointF textPos(r.X + 20.0f, r.Y + 14.0f);
    g.DrawString(b.text, -1, &font, textPos, &text);
}

// ================= NEWS WINDOW =================
LRESULT CALLBACK NewsWndProc(HWND hwnd, UINT msg, WPARAM w, LPARAM l)
{
    switch(msg)
    {
    case WM_PAINT:
    {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        Graphics g(hdc);
        g.SetSmoothingMode(SmoothingModeAntiAlias);
        g.SetInterpolationMode(InterpolationModeHighQualityBicubic);

        NewsItem& n = newsItems[currentNewsIndex];

        // фон новости
        Image* img = Image::FromFile(L"news.jpg"); // Для простоты локальный файл
        if(img) g.DrawImage(img, 0, 0, 600, 400);

        // прозрачный оверлей
        SolidBrush overlay(Color(150, 0, 0, 0));
        g.FillRectangle(&overlay, 0, 0, 600, 400);

        // текст
        FontFamily ff(L"Segoe UI");
        Font title(&ff, 26.0f, FontStyleBold);
        Font info(&ff, 16.0f, FontStyleRegular);
        SolidBrush white(Color::White);

        g.DrawString(n.title.c_str(), -1, &title, PointF(20, 20), &white);
        g.DrawString(n.text.c_str(), -1, &info, PointF(20, 60), &white);

        // соц сети
        SolidBrush iconBrush(Color(0, 255, 255, 255));
        for(auto& s : socialIcons)
            g.FillEllipse(&iconBrush, (REAL)s.rect.left, (REAL)s.rect.top, (REAL)(s.rect.right - s.rect.left), (REAL)(s.rect.bottom - s.rect.top));

        delete img;
        EndPaint(hwnd, &ps);
        break;
    }
    case WM_LBUTTONDOWN:
    {
        POINT p; GetCursorPos(&p); ScreenToClient(hwnd, &p);
        for(auto& s : socialIcons)
        {
            if(InRect(p, s.rect))
                ShellExecuteW(nullptr, L"open", s.url, nullptr, nullptr, SW_SHOW);
        }
        break;
    }
    case WM_DESTROY:
        PostQuitMessage(0);
        break;
    default: return DefWindowProcW(hwnd, msg, w, l);
    }
    return 0;
}

// ================= MAIN WINDOW PROC =================
LRESULT CALLBACK WndProc(HWND hwnd, UINT msg, WPARAM w, LPARAM l)
{
    switch(msg)
    {
    case WM_CREATE:
        URLDownloadToFileW(nullptr, BG_URL, BG_FILE, 0, nullptr);
        background = Image::FromFile(BG_FILE);
        break;

    case WM_PAINT:
    {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        Graphics g(hdc);
        g.SetSmoothingMode(SmoothingModeAntiAlias);
        g.SetInterpolationMode(InterpolationModeHighQualityBicubic);

        if(background) g.DrawImage(background, 0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

        // оверлей
        SolidBrush overlay(Color(120, 0, 0, 0));
        g.FillRectangle(&overlay, 0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

        // текст лаунчера
        FontFamily ff(L"Segoe UI");
        Font title(&ff, 34.0f, FontStyleBold);
        Font info(&ff, 16.0f, FontStyleRegular);
        SolidBrush white(Color::White);
        SolidBrush green(Color(255, 0, 200, 0));

        g.DrawString(L"MAJESTIC ROLEPLAY", -1, &title, PointF(30,30), &white);
        g.DrawString(L"STATUS: ONLINE", -1, &info, PointF(30,80), &green);
        g.DrawString(L"Launcher v1.0", -1, &info, PointF(30,110), &white);

        // кнопки
        for(auto* b : buttons)
            DrawButton(g, *b);

        EndPaint(hwnd, &ps);
        break;
    }

    case WM_MOUSEMOVE:
    {
        POINT p; GetCursorPos(&p); ScreenToClient(hwnd, &p);
        for(auto* b : buttons)
        {
            bool old = b->hover;
            b->hover = InRect(p, b->rect);
            if(old != b->hover) InvalidateRect(hwnd, nullptr, FALSE);
        }
        break;
    }

    case WM_LBUTTONDOWN:
    {
        POINT p; GetCursorPos(&p); ScreenToClient(hwnd, &p);

        if(InRect(p, btnNews.rect))
        {
            // открыть окно новости
            WNDCLASSW wc{};
            wc.lpfnWndProc = NewsWndProc;
            wc.hInstance = GetModuleHandle(nullptr);
            wc.lpszClassName = L"NEWS_WINDOW";
            wc.hCursor = LoadCursor(nullptr, IDC_ARROW);
            RegisterClassW(&wc);

            HWND newsHWND = CreateWindowExW(0, L"NEWS_WINDOW", L"Новости Majestic RP", WS_OVERLAPPEDWINDOW | WS_VISIBLE,
                                            100,100,600,400,
                                            nullptr,nullptr,GetModuleHandle(nullptr),nullptr);
            ShowWindow(newsHWND, SW_SHOW);
        }
        else if(InRect(p, btnPlay.rect))
        {
            ShellExecuteW(nullptr, L"open", L"C:\\Games\\GTA5\\GTA5.exe", nullptr, nullptr, SW_SHOW);
        }
        else if(InRect(p, btnDiscord.rect))
        {
            ShellExecuteW(nullptr, L"open", L"https://discord.gg/majestic", nullptr, nullptr, SW_SHOW);
        }
        else if(InRect(p, btnSettings.rect))
        {
            MessageBoxW(hwnd, L"Настройки в разработке", L"Info", MB_ICONINFORMATION);
        }
        break;
    }

    case WM_DESTROY:
        delete background;
        GdiplusShutdown(gdiToken);
        PostQuitMessage(0);
        break;

    default: return DefWindowProcW(hwnd,msg,w,l);
    }
    return 0;
}

// ================= WINMAIN =================
int WINAPI WinMain(HINSTANCE h, HINSTANCE, LPSTR, int)
{
    GdiplusStartupInput gdi;
    GdiplusStartup(&gdiToken, &gdi, nullptr);

    WNDCLASSW wc{};
    wc.lpfnWndProc = WndProc;
    wc.hInstance = h;
    wc.lpszClassName = L"MAJESTIC_LAUNCHER";
    wc.hCursor = LoadCursor(nullptr, IDC_ARROW);
    RegisterClassW(&wc);

    HWND hwnd = CreateWindowExW(WS_EX_LAYERED | WS_EX_TOPMOST, wc.lpszClassName, L"Majestic RP Launcher",
                                WS_POPUP, 100,50,WINDOW_WIDTH,WINDOW_HEIGHT,
                                nullptr,nullptr,h,nullptr);
    ShowWindow(hwnd, SW_SHOW);

    MSG msg{};
    while(GetMessageW(&msg,nullptr,0,0))
    {
        TranslateMessage(&msg);
        DispatchMessageW(&msg);
    }

    return 0;
}
