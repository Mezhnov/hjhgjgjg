#define UNICODE
#define _UNICODE
#include <windows.h>
#include <commctrl.h>
#include <gdiplus.h>
#include <wininet.h>
#include <string>
#include <vector>
#include <memory>
#include <shlwapi.h>
#include <commdlg.h>
#include <shlobj.h>

#pragma comment(lib, "comctl32.lib")
#pragma comment(lib, "gdiplus.lib")
#pragma comment(lib, "wininet.lib")
#pragma comment(lib, "shlwapi.lib")
#pragma comment(linker, " /manifestdependency:\"type='win32' name='Microsoft.Windows.Common-Controls' version='6.0.0.0' processorArchitecture='*' publicKeyToken='6595b64144ccf1df' language='*'\"")
using namespace Gdiplus;

// ==================== –¶–≤–µ—Ç–∞ –∏ —Å—Ç–∏–ª–∏ ====================
// –î–ª—è –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —è—Ä–∫–∏–π, –ø–ª–∞–≤–Ω—ã–π —Å—Ç–∏–ª—å
#define COLOR_BG_DARK       RGB(25, 25, 25)
#define COLOR_ACCENT        RGB(100, 200, 255)
#define COLOR_PRIMARY       RGB(0, 255, 136)
#define COLOR_PRIMARY_DARK  RGB(0, 180, 100)
#define COLOR_TEXT_LIGHT    RGB(255, 255, 255)
#define COLOR_TEXT_MEDIUM   RGB(200, 200, 200)
#define COLOR_BTN_BG        RGB(50, 50, 50)
#define COLOR_BTN_HOVER     RGB(70, 70, 70)
#define COLOR_BTN_ACTIVE    RGB(0, 255, 136)
#define COLOR_BORDER        RGB(40, 40, 40)

// ==================== –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ ====================
#define ID_TOOLBAR           1001

// ==================== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ====================
HINSTANCE g_hInst;
HWND g_hWnd, g_hMainWnd;
HDC g_hDcBuffer;
ULONGLONG g_gdiplusToken;

HFONT g_hFontLogo, g_hFontMenu, g_hFontIcons, g_hFontTitle;
HCURSOR g_hCursorArrow, g_hCursorHand, g_hCursorResize;

int g_ribbonHeight = 70;
int g_logoWidth = 250;
int g_margin = 10;
int g_iconSize = 24;

int g_activeTabIndex = 0;
struct RibbonTab {
    std::wstring name;
    RECT rect;
    bool active;
};
std::vector<RibbonTab> g_ribbonTabs;

int g_width, g_height;

// ==================== –ü–†–û–¢–û–¢–ò–ü–´ —Ñ—É–Ω–∫—Ü–∏–π ====================
LRESULT CALLBACK WndProc(HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam);
void InitApp(HINSTANCE hInst);
void Cleanup();
void LoadFonts();
void DrawHeader(HDC hdc, RECT& clientRect);
void DrawRibbon(HDC hdc);
void DrawRibbonTab(HDC hdc, const RibbonTab& tab, int index);
int HitTestRibbonTabs(int x, int y);
void SetActiveTab(int index);
void ResizeWindow(int width, int height);
void OnPaint();
void InitCursors();

int WINAPI WinMain(HINSTANCE hInst, HINSTANCE, LPSTR, int nCmdShow) {
    g_hInst = hInst;
    LoadFonts();
    InitCursors();

    WNDCLASSEX wc = { sizeof(WNDCLASSEX) };
    wc.style = CS_HREDRAW | CS_VREDRAW | CS_DBLCLKS;
    wc.cbClsExtra = 0;
    wc.cbWndExtra = 0;
    wc.hInstance = hInst;
    wc.hbrBackground = (HBRUSH)(COLOR_WINDOW+1);
    wc.lpszClassName = L"ModernHeaderApp";
    wc.lpfnWndProc = WndProc;
    wc.hIcon = LoadIcon(NULL, IDI_APPLICATION);
    wc.hCursor = LoadCursor(NULL, IDC_ARROW);
    RegisterClassEx(&wc);

    g_hMainWnd = CreateWindow(wc.lpszClassName, L"–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —à–∞–ø–∫–∞ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å",
        WS_OVERLAPPEDWINDOW, CW_USEDEFAULT, CW_USEDEFAULT, 1280, 720,
        NULL, NULL, hInst, NULL);

    ShowWindow(g_hMainWnd, nCmdShow);

    MSG msg;
    while (GetMessage(&msg, NULL, 0, 0)) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }
    return (int)msg.wParam;
}

// ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====================
void LoadFonts() {
    g_hFontLogo = CreateFont(30, 0, 0, 0, FW_BOLD, FALSE, FALSE, FALSE,
        DEFAULT_CHARSET, OUT_DEFAULT_PRECIS, CLIP_DEFAULT_PRECIS,
        CLEARTYPE_QUALITY, VARIABLE_PITCH, L"Segoe UI");

    g_hFontMenu = CreateFont(16, 0, 0, 0, FW_SEMIBOLD, FALSE, FALSE, FALSE,
        DEFAULT_CHARSET, OUT_DEFAULT_PRECIS, CLIP_DEFAULT_PRECIS,
        CLEARTYPE_QUALITY, VARIABLE_PITCH, L"Segoe UI");

    g_hFontIcons = CreateFont(24, 0, 0, 0, FW_NORMAL, FALSE, FALSE, FALSE,
        DEFAULT_CHARSET, OUT_DEFAULT_PRECIS, CLIP_DEFAULT_PRECIS,
        CLEARTYPE_QUALITY, DEFAULT_PITCH, L"Segoe UI Symbol");
}

void InitCursors() {
    g_hCursorArrow = LoadCursor(NULL, IDC_ARROW);
    g_hCursorHand = LoadCursor(NULL, IDC_HAND);
    g_hCursorResize = LoadCursor(NULL, IDC_SIZEALL);
}

// ==================== –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ ====================
void Cleanup() {
    if (g_hFontLogo) DeleteObject(g_hFontLogo);
    if (g_hFontMenu) DeleteObject(g_hFontMenu);
    if (g_hFontIcons) DeleteObject(g_hFontIcons);
    GdiplusShutdown((ULONG_PTR*)&g_gdiplusToken);
}

// ==================== –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ====================
LRESULT CALLBACK WndProc(HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam) {
    switch (msg) {
        case WM_CREATE:
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GDI+
            {
                GdiplusStartupInput si;
                GdiplusStartup(&g_gdiplusToken, &si, NULL);
            }
            return 0;
        case WM_SIZE:
            g_width = LOWORD(lParam);
            g_height = HIWORD(lParam);
            ResizeWindow(g_width, g_height);
            InvalidateRect(hWnd, NULL, TRUE);
            return 0;
        case WM_PAINT:
            OnPaint();
            return 0;
        case WM_DESTROY:
            Cleanup();
            PostQuitMessage(0);
            return 0;
        case WM_MOUSEMOVE:
        {
            int x = LOWORD(lParam);
            int y = HIWORD(lParam);
            bool needRedraw = false;
            for (size_t i = 0; i < g_ribbonTabs.size(); ++i) {
                if (PtInRect(&g_ribbonTabs[i].rect, {x,y})) {
                    // –ù–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã
                }
            }
            if (needRedraw) InvalidateRect(hWnd, NULL, FALSE);
            return 0;
        }
        case WM_LBUTTONDOWN:
        {
            int x = LOWORD(lParam);
            int y = HIWORD(lParam);
            int tabIndex = HitTestRibbonTabs(x,y);
            if (tabIndex >=0) {
                SetActiveTab(tabIndex);
            }
            break;
        }
        default:
            return DefWindowProc(hWnd, msg, wParam, lParam);
    }
    return 0;
}

// ==================== —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ ====================
void OnPaint() {
    PAINTSTRUCT ps;
    HDC hdc = BeginPaint(g_hMainWnd, &ps);
    RECT r;
    GetClientRect(g_hMainWnd, &r);

    // –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    g_hDcBuffer = CreateCompatibleDC(hdc);
    HBITMAP hBmpBuffer = CreateCompatibleBitmap(hdc, r.right, r.bottom);
    HBITMAP hOldBmp = (HBITMAP)SelectObject(g_hDcBuffer, hBmpBuffer);

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ–Ω–∞ –∏ —à–∞–ø–∫–∏
    FillRect(g_hDcBuffer, &r, (HBRUSH)CreateSolidBrush(COLOR_BG_DARK));
    DrawHeader(g_hDcBuffer, r);

    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ‚Äî —Å–ª–∞–π–¥—ã, –º–∏–Ω–∏–∞—Ç—é—Ä—ã, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

    // –ö–æ–ø–∏—Ä—É–µ–º –±—É—Ñ–µ—Ä –Ω–∞ —ç–∫—Ä–∞–Ω
    BitBlt(hdc, 0, 0, r.right, r.bottom, g_hDcBuffer, 0, 0, SRCCOPY);

    // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
    SelectObject(g_hDcBuffer, hOldBmp);
    DeleteObject(hBmpBuffer);
    DeleteDC(g_hDcBuffer);
    EndPaint(g_hMainWnd, &ps);
}

// ==================== —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —à–∞–ø–∫–∏ ====================
void DrawHeader(HDC hdc, RECT& clientRect) {
    // –§–æ–Ω —à–∞–ø–∫–∏
    RECT headerRect = {0, 0, clientRect.right, g_ribbonHeight};
    FillRect(hdc, &headerRect, (HBRUSH)CreateSolidBrush(COLOR_BG_DARK));

    // –õ–æ–≥–æ—Ç–∏–ø —Å–ª–µ–≤–∞
    HFONT oldFont = (HFONT)SelectObject(hdc, g_hFontLogo);
    SetBkMode(hdc, TRANSPARENT);
    SetTextColor(hdc, COLOR_TEXT_LIGHT);
    RECT logoRect = {g_margin, 0, g_logoWidth, g_ribbonHeight};
    DrawText(hdc, L"PowerPoint +", -1, &logoRect, DT_VCENTER | DT_LEFT | DT_SINGLELINE);
    SelectObject(hdc, oldFont);

    // –ò–∫–æ–Ω–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ (–Ω–æ–≤—ã–π, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
    int btnSize = 40;
    int x = clientRect.right - g_margin - btnSize;
    int y = (g_ribbonHeight - btnSize) / 2;

    //–°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–∏—Å—Ç–∏ –∏ —Ä–∞–º–∫–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    // –ö–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞
    auto DrawIconButton = [&](const std::wstring& iconSymbol, const std::wstring& tooltip) {
        RECT rectBtn = {x, y, x + btnSize, y + btnSize};
        // –§–æ–Ω
        HBRUSH brush = (HBRUSH)CreateSolidBrush(COLOR_BTN_BG);
        FillRect(hdc, &rectBtn, brush);
        DeleteObject(brush);
        // –ò–∫–æ–Ω–∫–∞
        HFONT hIconFont = CreateFont(btnSize, 0, 0, 0, FW_NORMAL, FALSE, FALSE, FALSE,
            DEFAULT_CHARSET, OUT_DEFAULT_PRECIS, CLIP_DEFAULT_PRECIS,
            CLEARTYPE_QUALITY, VARIABLE_PITCH, L"Segoe UI Symbol");
        HFONT oldFnt = (HFONT)SelectObject(hdc, hIconFont);
        SetTextColor(hdc, COLOR_ACCENT);
        SetBkMode(hdc, TRANSPARENT);
        DrawText(hdc, iconSymbol.c_str(), -1, &rectBtn, DT_CENTER | DT_VCENTER | DT_SINGLELINE);
        SelectObject(hdc, oldFnt);
        DeleteObject(hIconFont);
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç hover/pressed, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        x -= btnSize + g_margin;
    };

    // –ò–∫–æ–Ω–∫–∏ —Å–ø—Ä–∞–≤–∞
    DrawIconButton(L"üîî", L"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è");
    DrawIconButton(L"üí¨", L"–°–æ–æ–±—â–µ–Ω–∏—è");
    DrawIconButton(L"‚ûï", L"–°–æ–∑–¥–∞—Ç—å");
}

// ==================== —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ ====================
int HitTestRibbonTabs(int x, int y) {
    for (size_t i=0; i<g_ribbonTabs.size(); ++i) {
        if (PtInRect(&g_ribbonTabs[i].rect, {x,y})) return (int)i;
    }
    return -1;
}

// ==================== —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ ====================
void SetActiveTab(int index) {
    if (index >=0 && index<(int)g_ribbonTabs.size()) {
        g_activeTabIndex = index;
        for (size_t i=0; i<g_ribbonTabs.size(); ++i) g_ribbonTabs[i].active = (i==index);
        InvalidateRect(g_hMainWnd, NULL, TRUE);
    }
}

// ==================== –æ–∫–Ω–æ resize ====================
void ResizeWindow(int width, int height) {
    g_width = width;
    g_height = height;
}

// ==================== –æ—Å—Ç–∞–ª—å–Ω–æ–µ - –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –º–∏–Ω–∏–∞—Ç—é—Ä—ã, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ/
// –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Ü–µ–Ω—Ç—Ä —Ä–∞–±–æ—Ç—ã, –∏–∫–æ–Ω–∫–∏, —Ñ–æ—Ä–º—ã, –∞–Ω–∏–º–∞—Ü–∏–∏ ‚Äî –≤—Å–µ –≤ —Å—Ç–∏–ª–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ +
// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã, –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —Å–ª–æ–∏, –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å.
