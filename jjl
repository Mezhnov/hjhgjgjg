#include <windows.h>
#include <gdiplus.h>
#include <urlmon.h>
#include <shellapi.h>

#pragma comment(lib, "gdiplus.lib")
#pragma comment(lib, "urlmon.lib")

// ================= CONFIG =================
const int WINDOW_WIDTH  = 1000;
const int WINDOW_HEIGHT = 600;

const wchar_t* BG_URL  = L"https://avatars.mds.yandex.net/i?id=36cbb9eb6253b776b00360ca303f84d7_l-12608381-images-thumbs&n=13";
const wchar_t* BG_FILE = L"background.jpg";

const wchar_t* GTA_PATH = L"C:\\Games\\GTA5\\GTA5.exe";
// =========================================

ULONG_PTR gdiToken;
Gdiplus::Image* background = nullptr;

// ================= UI =================
struct Button
{
    RECT rect;
    const wchar_t* text;
    bool hover;
    bool isControl; // true для X, _, □
};

Button btnPlay     = { {400, 400, 600, 460}, L"ИГРАТЬ", false, false };
Button btnSettings = { {30, 520, 180, 560},  L"НАСТРОЙКИ", false, false };
Button btnDiscord  = { {200, 520, 360, 560}, L"DISCORD", false, false };

// Верхние окна-кнопки управления
Button btnClose     = { {960, 10, 990, 40}, L"X", false, true };
Button btnMinimize  = { {910, 10, 940, 40}, L"_", false, true };
Button btnMaximize  = { {860, 10, 890, 40}, L"□", false, true };
// ======================================

// Проверка попадания курсора в прямоугольник
bool InRect(const POINT& p, const RECT& r)
{
    return p.x >= r.left && p.x <= r.right &&
           p.y >= r.top  && p.y <= r.bottom;
}

// Наложение затемнения
void DrawOverlay(Gdiplus::Graphics& g)
{
    Gdiplus::SolidBrush overlay(Gdiplus::Color(120, 0, 0, 0));
    g.FillRectangle(&overlay, 0.0f, 0.0f, (Gdiplus::REAL)WINDOW_WIDTH, (Gdiplus::REAL)WINDOW_HEIGHT);
}

// Рисуем кнопку с градиентом
void DrawButton(Gdiplus::Graphics& g, const Button& b)
{
    Gdiplus::Color c1 = b.hover ? Gdiplus::Color(255, 255, 200, 0) : Gdiplus::Color(255, 180, 140, 0);
    Gdiplus::Color c2 = b.hover ? Gdiplus::Color(255, 255, 150, 0) : Gdiplus::Color(255, 140, 80, 0);

    Gdiplus::RectF r(
        (Gdiplus::REAL)b.rect.left,
        (Gdiplus::REAL)b.rect.top,
        (Gdiplus::REAL)(b.rect.right - b.rect.left),
        (Gdiplus::REAL)(b.rect.bottom - b.rect.top)
    );

    Gdiplus::LinearGradientBrush grad(r, c1, c2, Gdiplus::LinearGradientModeVertical);
    g.FillRectangle(&grad, r);

    Gdiplus::FontFamily ff(L"Segoe UI");
    Gdiplus::Font font(&ff, b.isControl ? 14.0f : 18.0f, Gdiplus::FontStyleBold);
    Gdiplus::SolidBrush text(Gdiplus::Color::White);

    Gdiplus::PointF textPos(r.X + (b.isControl ? 3.0f : 20.0f), r.Y + (b.isControl ? 2.0f : 10.0f));
    g.DrawString(b.text, -1, &font, textPos, &text);
}

// Рисуем текст лаунчера
void DrawLauncherText(Gdiplus::Graphics& g)
{
    Gdiplus::FontFamily ff(L"Segoe UI");
    Gdiplus::Font title(&ff, 32.0f, Gdiplus::FontStyleBold);
    Gdiplus::Font info(&ff, 16.0f, Gdiplus::FontStyleRegular);

    Gdiplus::SolidBrush white(Gdiplus::Color::White);
    Gdiplus::SolidBrush green(Gdiplus::Color(255, 0, 200, 0));

    g.DrawString(L"MAJESTIC ROLEPLAY", -1, &title, Gdiplus::PointF(30.0f, 30.0f), &white);
    g.DrawString(L"STATUS: ONLINE", -1, &info, Gdiplus::PointF(30.0f, 80.0f), &green);
    g.DrawString(L"Launcher v1.0", -1, &info, Gdiplus::PointF(30.0f, 110.0f), &white);
}

// ================= WINDOW PROC =================
LRESULT CALLBACK WndProc(HWND hwnd, UINT msg, WPARAM w, LPARAM l)
{
    switch (msg)
    {
    case WM_CREATE:
        URLDownloadToFileW(nullptr, BG_URL, BG_FILE, 0, nullptr);
        background = Gdiplus::Image::FromFile(BG_FILE);
        break;

    case WM_PAINT:
    {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        Gdiplus::Graphics g(hdc);
        g.SetInterpolationMode(Gdiplus::InterpolationModeHighQualityBicubic);

        if (background)
            g.DrawImage(background, 0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

        DrawOverlay(g);
        DrawLauncherText(g);

        DrawButton(g, btnPlay);
        DrawButton(g, btnSettings);
        DrawButton(g, btnDiscord);

        DrawButton(g, btnClose);
        DrawButton(g, btnMinimize);
        DrawButton(g, btnMaximize);

        EndPaint(hwnd, &ps);
        break;
    }

    case WM_MOUSEMOVE:
    {
        POINT p;
        GetCursorPos(&p);
        ScreenToClient(hwnd, &p);

        Button* buttons[] = { &btnPlay, &btnSettings, &btnDiscord, &btnClose, &btnMinimize, &btnMaximize };
        for (Button* b : buttons)
        {
            bool old = b->hover;
            b->hover = InRect(p, b->rect);
            if (old != b->hover)
                InvalidateRect(hwnd, nullptr, FALSE);
        }
        break;
    }

    case WM_LBUTTONDOWN:
    {
        POINT p;
        GetCursorPos(&p);
        ScreenToClient(hwnd, &p);

        if (InRect(p, btnPlay.rect))
            ShellExecuteW(nullptr, L"open", GTA_PATH, nullptr, nullptr, SW_SHOW);
        else if (InRect(p, btnDiscord.rect))
            ShellExecuteW(nullptr, L"open", L"https://discord.gg/majestic", nullptr, nullptr, SW_SHOW);
        else if (InRect(p, btnSettings.rect))
            MessageBoxW(hwnd, L"Настройки в разработке", L"Info", MB_ICONINFORMATION);
        else if (InRect(p, btnClose.rect))
            PostQuitMessage(0);
        else if (InRect(p, btnMinimize.rect))
            ShowWindow(hwnd, SW_MINIMIZE);
        else if (InRect(p, btnMaximize.rect))
        {
            static bool maximized = false;
            maximized = !maximized;
            ShowWindow(hwnd, maximized ? SW_MAXIMIZE : SW_RESTORE);
        }
        else
            SendMessage(hwnd, WM_NCLBUTTONDOWN, HTCAPTION, 0); // перетаскивание окна

        break;
    }

    case WM_DESTROY:
        delete background;
        Gdiplus::GdiplusShutdown(gdiToken);
        PostQuitMessage(0);
        break;

    default:
        return DefWindowProcW(hwnd, msg, w, l);
    }
    return 0;
}

// ================= WINMAIN =================
int WINAPI WinMain(HINSTANCE h, HINSTANCE, LPSTR, int)
{
    Gdiplus::GdiplusStartupInput gdi;
    Gdiplus::GdiplusStartup(&gdiToken, &gdi, nullptr);

    WNDCLASSW wc{};
    wc.lpfnWndProc = WndProc;
    wc.hInstance = h;
    wc.lpszClassName = L"MAJESTIC_LAUNCHER";
    wc.hCursor = LoadCursor(nullptr, IDC_ARROW);

    RegisterClassW(&wc);

    HWND hwnd = CreateWindowExW(
        WS_EX_TOPMOST,
        wc.lpszClassName,
        L"Majestic RP Launcher",
        WS_POPUP, // Borderless
        100, 50,
        WINDOW_WIDTH,
        WINDOW_HEIGHT,
        nullptr,
        nullptr,
        h,
        nullptr
    );

    ShowWindow(hwnd, SW_SHOW);

    MSG msg{};
    while (GetMessageW(&msg, nullptr, 0, 0))
    {
        TranslateMessage(&msg);
        DispatchMessageW(&msg);
    }
    return 0;
}
