#include <windows.h>
#include <gdiplus.h>
#include <urlmon.h>
#include <shellapi.h>

#pragma comment(lib, "gdiplus.lib")
#pragma comment(lib, "urlmon.lib")

using namespace Gdiplus;

// ================= НАСТРОЙКИ =================
const int W = 900;
const int H = 520;

const wchar_t* BG_URL  = L"https://avatars.mds.yandex.net/i?id=36cbb9eb6253b776b00360ca303f84d7_l-12608381-images-thumbs&n=13";
const wchar_t* BG_FILE = L"background.jpg";

const wchar_t* GTA_PATH = L"C:\\Games\\GTA5\\GTA5.exe";
// =============================================

ULONG_PTR gdiToken;
Image* bg = nullptr;

// ---------------- КНОПКИ ----------------
struct UIButton {
    RECT rect;
    const wchar_t* text;
    bool hover;
};

UIButton btnPlay     = { {350, 360, 550, 415}, L"ИГРАТЬ", false };
UIButton btnSettings = { {30, 460, 170, 500}, L"НАСТРОЙКИ", false };
UIButton btnDiscord  = { {190, 460, 330, 500}, L"DISCORD", false };
UIButton btnExit     = { {760, 20, 880, 55},  L"X", false };

// ---------------------------------------

bool InRect(POINT p, RECT r)
{
    return p.x >= r.left && p.x <= r.right &&
           p.y >= r.top  && p.y <= r.bottom;
}

void DrawButton(Graphics& g, UIButton& btn)
{
    Color bg = btn.hover
        ? Color(200, 255, 180, 0)
        : Color(160, 0, 0, 0);

    SolidBrush brush(bg);

    RectF r(
        (REAL)btn.rect.left,
        (REAL)btn.rect.top,
        (REAL)(btn.rect.right - btn.rect.left),
        (REAL)(btn.rect.bottom - btn.rect.top)
    );

    g.FillRectangle(&brush, r);

    FontFamily ff(L"Segoe UI");
    Font font(&ff, btn.text == L"X" ? 18 : 16, FontStyleBold);
    SolidBrush text(Color::White);

    g.DrawString(
        btn.text,
        -1,
        &font,
        PointF(r.X + 15, r.Y + 8),
        &text
    );
}

void DrawText(Graphics& g)
{
    FontFamily ff(L"Segoe UI");

    Font title(&ff, 28, FontStyleBold);
    Font small(&ff, 14, FontStyleRegular);

    SolidBrush white(Color::White);
    SolidBrush green(Color(255, 0, 200, 0));

    g.DrawString(L"MAJESTIC ROLEPLAY", -1, &title, PointF(30, 25), &white);
    g.DrawString(L"SERVER STATUS: ONLINE", -1, &small, PointF(30, 70), &green);
    g.DrawString(L"Launcher v1.0", -1, &small, PointF(30, 95), &white);
}

void DrawOverlay(Graphics& g)
{
    SolidBrush overlay(Color(120, 0, 0, 0));
    g.FillRectangle(&overlay, 0, 0, W, H);
}

// ================= WINDOW PROC =================
LRESULT CALLBACK WndProc(HWND hwnd, UINT msg, WPARAM w, LPARAM l)
{
    switch (msg)
    {
    case WM_CREATE:
        URLDownloadToFileW(nullptr, BG_URL, BG_FILE, 0, nullptr);
        bg = Image::FromFile(BG_FILE);
        break;

    case WM_PAINT:
    {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        Graphics g(hdc);

        g.SetInterpolationMode(InterpolationModeHighQualityBicubic);

        if (bg)
            g.DrawImage(bg, 0, 0, W, H);

        DrawOverlay(g);
        DrawText(g);

        DrawButton(g, btnPlay);
        DrawButton(g, btnSettings);
        DrawButton(g, btnDiscord);
        DrawButton(g, btnExit);

        EndPaint(hwnd, &ps);
        break;
    }

    case WM_MOUSEMOVE:
    {
        POINT p;
        GetCursorPos(&p);
        ScreenToClient(hwnd, &p);

        UIButton* buttons[] = { &btnPlay, &btnSettings, &btnDiscord, &btnExit };

        for (auto& b : buttons)
        {
            bool old = b->hover;
            b->hover = InRect(p, b->rect);
            if (old != b->hover)
                InvalidateRect(hwnd, nullptr, TRUE);
        }
        break;
    }

    case WM_LBUTTONDOWN:
    {
        POINT p;
        GetCursorPos(&p);
        ScreenToClient(hwnd, &p);

        if (InRect(p, btnPlay.rect))
        {
            ShellExecuteW(nullptr, L"open", GTA_PATH, nullptr, nullptr, SW_SHOW);
        }
        else if (InRect(p, btnDiscord.rect))
        {
            ShellExecuteW(nullptr, L"open", L"https://discord.gg/majestic", nullptr, nullptr, SW_SHOW);
        }
        else if (InRect(p, btnSettings.rect))
        {
            MessageBoxW(hwnd, L"Настройки в разработке", L"Info", MB_ICONINFORMATION);
        }
        else if (InRect(p, btnExit.rect))
        {
            PostQuitMessage(0);
        }
        else
        {
            SendMessage(hwnd, WM_NCLBUTTONDOWN, HTCAPTION, 0);
        }
        break;
    }

    case WM_DESTROY:
        delete bg;
        GdiplusShutdown(gdiToken);
        PostQuitMessage(0);
        break;

    default:
        return DefWindowProcW(hwnd, msg, w, l);
    }
    return 0;
}

// ================= WINMAIN =================
int WINAPI WinMain(HINSTANCE h, HINSTANCE, LPSTR, int)
{
    GdiplusStartupInput gdi;
    GdiplusStartup(&gdiToken, &gdi, nullptr);

    WNDCLASSW wc{};
    wc.lpfnWndProc = WndProc;
    wc.hInstance = h;
    wc.lpszClassName = L"MAJESTIC_LAUNCHER";
    wc.hCursor = LoadCursor(nullptr, IDC_ARROW);

    RegisterClassW(&wc);

    HWND hwnd = CreateWindowExW(
        0,
        wc.lpszClassName,
        L"Majestic RP Launcher",
        WS_POPUP,
        250, 150,
        W, H,
        nullptr,
        nullptr,
        h,
        nullptr
    );

    ShowWindow(hwnd, SW_SHOW);

    MSG msg{};
    while (GetMessageW(&msg, nullptr, 0, 0))
    {
        TranslateMessage(&msg);
        DispatchMessageW(&msg);
    }
    return 0;
}
