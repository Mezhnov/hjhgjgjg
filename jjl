#include <windows.h>
#include <gdiplus.h>
#include <urlmon.h>
#include <shellapi.h>
#include <vector>
#include <string>

#pragma comment(lib, "gdiplus.lib")
#pragma comment(lib, "urlmon.lib")

using namespace Gdiplus;

// ================= CONFIG =================
int WINDOW_WIDTH  = 1000;
int WINDOW_HEIGHT = 600;

ULONG_PTR gdiToken;
Image* background = nullptr;

// ================= UI =================
struct Button {
    RECT rect;
    const wchar_t* text;
    bool hover;
};

Button btnPlay     = { {400, 400, 600, 460}, L"ИГРАТЬ", false };
Button btnSettings = { {30, 520, 180, 560},  L"НАСТРОЙКИ", false };
Button btnNews     = { {650, 520, 830, 560}, L"НОВОСТИ", false };

std::vector<Button*> buttons = { &btnPlay, &btnSettings, &btnNews };

// Новости
struct NewsItem {
    std::wstring title;
    std::wstring text;
    std::wstring imageFile;
};
std::vector<NewsItem> newsItems = {
    { L"Зимний фестиваль!", L"Присоединяйтесь к зимнему событию в Majestic RP!", L"news1.jpg" },
    { L"Исправлены баги", L"Исправлены баги транспорта и улучшена стабильность.", L"news2.jpg" }
};
int currentNewsIndex = 0;

// Соцсети
struct SocialIcon {
    RECT rect;
    const wchar_t* url;
};
SocialIcon iconDiscord = { {20, 340, 60, 380}, L"https://discord.gg/majestic" };
SocialIcon iconVK      = { {70, 340, 110, 380}, L"https://vk.com/majestic" };
SocialIcon iconTG      = { {120, 340, 160, 380}, L"https://t.me/majestic" };
std::vector<SocialIcon> socialIcons = { iconDiscord, iconVK, iconTG };

// ================= HELPERS =================
bool InRect(POINT p, RECT r) {
    return p.x >= r.left && p.x <= r.right && p.y >= r.top && p.y <= r.bottom;
}

void DrawButton(Graphics& g, Button& b) {
    RectF r((REAL)b.rect.left, (REAL)b.rect.top,
            (REAL)(b.rect.right - b.rect.left),
            (REAL)(b.rect.bottom - b.rect.top));
    Color c = b.hover ? Color(255, 255, 180, 0) : Color(255, 180, 140, 0);
    SolidBrush brush(c);
    g.FillRectangle(&brush, r);
    FontFamily ff(L"Segoe UI");
    Font font(&ff, 22, FontStyleBold);
    SolidBrush text(Color::White);
    g.DrawString(b.text, -1, &font, PointF(r.X + 20, r.Y + 14), &text);
}

// ================= NEWS WINDOW =================
LRESULT CALLBACK NewsWndProc(HWND hwnd, UINT msg, WPARAM w, LPARAM l)
{
    switch(msg)
    {
    case WM_PAINT:
    {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        Graphics g(hdc);
        g.SetSmoothingMode(SmoothingModeAntiAlias);
        g.SetInterpolationMode(InterpolationModeHighQualityBicubic);

        NewsItem& n = newsItems[currentNewsIndex];

        // фон новости
        Image* img = Image::FromFile(n.imageFile.c_str());
        if(img) g.DrawImage(img, 0, 0, 600, 400);

        // прозрачный оверлей
        SolidBrush overlay(Color(150, 0, 0, 0));
        g.FillRectangle(&overlay, 0, 0, 600, 400);

        // текст
        FontFamily ff(L"Segoe UI");
        Font title(&ff, 26.0f, FontStyleBold);
        Font info(&ff, 16.0f, FontStyleRegular);
        SolidBrush white(Color::White);

        g.DrawString(n.title.c_str(), -1, &title, PointF(20, 20), &white);
        g.DrawString(n.text.c_str(), -1, &info, PointF(20, 60), &white);

        // соцсети
        SolidBrush iconBrush(Color(255, 255, 255, 255));
        for(auto& s : socialIcons)
            g.FillEllipse(&iconBrush, (REAL)s.rect.left, (REAL)s.rect.top, (REAL)(s.rect.right - s.rect.left), (REAL)(s.rect.bottom - s.rect.top));

        delete img;
        EndPaint(hwnd, &ps);
        break;
    }
    case WM_LBUTTONDOWN:
    {
        POINT p; GetCursorPos(&p); ScreenToClient(hwnd, &p);
        for(auto& s : socialIcons)
        {
            if(InRect(p, s.rect))
                ShellExecuteW(nullptr, L"open", s.url, nullptr, nullptr, SW_SHOW);
        }
        break;
    }
    case WM_DESTROY:
        PostQuitMessage(0);
        break;
    default: return DefWindowProcW(hwnd, msg, w, l);
    }
    return 0;
}

// ================= MAIN WINDOW =================
LRESULT CALLBACK WndProc(HWND hwnd, UINT msg, WPARAM w, LPARAM l)
{
    switch(msg)
    {
    case WM_CREATE:
        URLDownloadToFileW(nullptr, L"https://avatars.mds.yandex.net/i?id=36cbb9eb6253b776b00360ca303f84d7_l-12608381-images-thumbs&n=13", L"background.jpg", 0, nullptr);
        background = Image::FromFile(L"background.jpg");
        break;

    case WM_PAINT:
    {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        Graphics g(hdc);
        g.SetSmoothingMode(SmoothingModeAntiAlias);
        g.SetInterpolationMode(InterpolationModeHighQualityBicubic);

        if(background) g.DrawImage(background, 0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

        SolidBrush overlay(Color(120, 0, 0, 0));
        g.FillRectangle(&overlay, 0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

        FontFamily ff(L"Segoe UI");
        Font title(&ff, 34.0f, FontStyleBold);
        Font info(&ff, 16.0f, FontStyleRegular);
        SolidBrush white(Color::White);
        SolidBrush green(Color(255, 0, 200, 0));

        g.DrawString(L"MAJESTIC ROLEPLAY", -1, &title, PointF(30,30), &white);
        g.DrawString(L"STATUS: ONLINE", -1, &info, PointF(30,80), &green);
        g.DrawString(L"Launcher v1.0", -1, &info, PointF(30,110), &white);

        for(auto* b : buttons)
            DrawButton(g, *b);

        EndPaint(hwnd, &ps);
        break;
    }

    case WM_MOUSEMOVE:
    {
        POINT p; GetCursorPos(&p); ScreenToClient(hwnd, &p);
        for(auto* b : buttons)
        {
            bool old = b->hover;
            b->hover = InRect(p, b->rect);
            if(old != b->hover) InvalidateRect(hwnd, nullptr, FALSE);
        }
        break;
    }

    case WM_LBUTTONDOWN:
    {
        POINT p; GetCursorPos(&p); ScreenToClient(hwnd, &p);

        if(InRect(p, btnPlay.rect))
            ShellExecuteW(nullptr, L"open", L"C:\\Games\\GTA5\\GTA5.exe", nullptr, nullptr, SW_SHOW);
        else if(InRect(p, btnSettings.rect))
            MessageBoxW(hwnd, L"Настройки в разработке", L"Info", MB_ICONINFORMATION);
        else if(InRect(p, btnNews.rect))
        {
            WNDCLASSW wc{};
            wc.lpfnWndProc = NewsWndProc;
            wc.hInstance = GetModuleHandle(nullptr);
            wc.lpszClassName = L"NEWS_WINDOW";
            wc.hCursor = LoadCursor(nullptr, IDC_ARROW);
            RegisterClassW(&wc);

            HWND newsHWND = CreateWindowExW(0, L"NEWS_WINDOW", L"Новости Majestic RP",
                                            WS_OVERLAPPEDWINDOW | WS_VISIBLE,
                                            200,100,600,400,
                                            nullptr,nullptr,GetModuleHandle(nullptr),nullptr);
            ShowWindow(newsHWND, SW_SHOW);
        }
        break;
    }

    case WM_DESTROY:
        if(background) delete background;
        GdiplusShutdown(gdiToken);
        PostQuitMessage(0);
        break;

    default: return DefWindowProcW(hwnd,w,l);
    }
    return 0;
}

// ================= WINMAIN =================
int WINAPI WinMain(HINSTANCE h, HINSTANCE, LPSTR, int)
{
    GdiplusStartupInput gdi;
    GdiplusStartup(&gdiToken, &gdi, nullptr);

    WNDCLASSW wc{};
    wc.lpfnWndProc = WndProc;
    wc.hInstance = h;
    wc.lpszClassName = L"MAJESTIC_LAUNCHER";
    wc.hCursor = LoadCursor(nullptr, IDC_ARROW);
    RegisterClassW(&wc);

    HWND hwnd = CreateWindowExW(0, wc.lpszClassName, L"Majestic RP Launcher",
                                WS_POPUP | WS_VISIBLE,
                                100,50,WINDOW_WIDTH,WINDOW_HEIGHT,
                                nullptr,nullptr,h,nullptr);
    ShowWindow(hwnd, SW_SHOW);

    MSG msg{};
    while(GetMessageW(&msg,nullptr,0,0))
    {
        TranslateMessage(&msg);
        DispatchMessageW(&msg);
    }
    return 0;
}
