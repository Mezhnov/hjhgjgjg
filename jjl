#include <windows.h>
#include <gdiplus.h>
#include <urlmon.h>
#include <shellapi.h>

#pragma comment(lib, "gdiplus.lib")
#pragma comment(lib, "urlmon.lib")

using namespace Gdiplus;

ULONG_PTR gdiToken;
Image* bgImage = nullptr;

RECT playBtn = { 300, 340, 500, 400 };
bool hoverPlay = false;

const wchar_t* BG_URL  = L"https://i.imgur.com/9ZQZQ9Y.jpg";
const wchar_t* BG_FILE = L"bg.jpg";

void DrawButton(Graphics& g)
{
    Color bg = hoverPlay ? Color(220, 255, 180, 0) : Color(180, 0, 0, 0);
    SolidBrush brush(bg);
    g.FillRectangle(&brush,
        playBtn.left,
        playBtn.top,
        playBtn.right - playBtn.left,
        playBtn.bottom - playBtn.top);

    FontFamily ff(L"Segoe UI");
    Font font(&ff, 22, FontStyleBold);
    SolidBrush textBrush(Color::White);

    g.DrawString(
        L"ИГРАТЬ",
        -1,
        &font,
        PointF(345, 350),
        &textBrush
    );
}

bool PointInRect(POINT p, RECT r)
{
    return p.x >= r.left && p.x <= r.right &&
           p.y >= r.top  && p.y <= r.bottom;
}

LRESULT CALLBACK WndProc(HWND hwnd, UINT msg, WPARAM w, LPARAM l)
{
    switch (msg)
    {
    case WM_CREATE:
        URLDownloadToFileW(nullptr, BG_URL, BG_FILE, 0, nullptr);
        bgImage = Image::FromFile(BG_FILE);
        break;

    case WM_PAINT:
    {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        Graphics g(hdc);

        if (bgImage)
            g.DrawImage(bgImage, 0, 0, 800, 450);

        DrawButton(g);
        EndPaint(hwnd, &ps);
        break;
    }

    case WM_MOUSEMOVE:
    {
        POINT p;
        GetCursorPos(&p);
        ScreenToClient(hwnd, &p);

        bool old = hoverPlay;
        hoverPlay = PointInRect(p, playBtn);
        if (old != hoverPlay)
            InvalidateRect(hwnd, NULL, TRUE);
        break;
    }

    case WM_LBUTTONDOWN:
    {
        POINT p;
        GetCursorPos(&p);
        ScreenToClient(hwnd, &p);

        if (PointInRect(p, playBtn))
        {
            ShellExecuteW(
                nullptr,
                L"open",
                L"C:\\Games\\GTA5\\GTA5.exe",
                L"-rpserver=majestic",
                nullptr,
                SW_SHOW
            );
        }
        else
        {
            SendMessage(hwnd, WM_NCLBUTTONDOWN, HTCAPTION, 0);
        }
        break;
    }

    case WM_DESTROY:
        delete bgImage;
        GdiplusShutdown(gdiToken);
        PostQuitMessage(0);
        break;

    default:
        return DefWindowProc(hwnd, msg, w, l);
    }
    return 0;
}

int WINAPI WinMain(HINSTANCE hInst, HINSTANCE, LPSTR, int)
{
    GdiplusStartupInput gdiInput;
    GdiplusStartup(&gdiToken, &gdiInput, nullptr);

    WNDCLASSW wc{};
    wc.lpfnWndProc = WndProc;
    wc.hInstance = hInst;
    wc.lpszClassName = L"MAJESTIC_LAUNCHER";
    wc.hCursor = LoadCursor(nullptr, IDC_ARROW);

    RegisterClassW(&wc);

    HWND hwnd = CreateWindowExW(
        0,
        wc.lpszClassName,
        L"GTA 5 Majestic RP",
        WS_POPUP,
        300, 200,
        800, 450,
        nullptr,
        nullptr,
        hInst,
        nullptr
    );

    ShowWindow(hwnd, SW_SHOW);

    MSG msg{};
    while (GetMessage(&msg, nullptr, 0, 0))
    {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }
    return 0;
}
